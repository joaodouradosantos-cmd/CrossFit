<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrossBox</title>

  <meta name="theme-color" content="#f2f2f2" />
  <link rel="manifest" href="manifest.json" />

  <link rel="apple-touch-icon" sizes="180x180" href="imagens/crossbox_logo.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Fonte militar -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Stardos+Stencil:wght@400;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      font-family: system-ui, sans-serif;
      color-scheme: light;
    }

    body {
      background:
        /* RISCOS ESCUROS TIPO ARRANH√ïES */
        repeating-linear-gradient(
          145deg,
          rgba(18, 22, 15, 0.95) 0px,
          rgba(18, 22, 15, 0.95) 120px,
          rgba(12, 13, 10, 1) 121px,
          rgba(12, 13, 10, 1) 132px
        ),
        /* MANCHAS OLIVA / LAMA */
        radial-gradient(circle at 12% 0%, rgba(116, 128, 76, 0.55) 0, transparent 55%),
        radial-gradient(circle at 85% 100%, rgba(140, 110, 60, 0.45) 0, transparent 60%),
        /* FUNDO PRINCIPAL VERDE TROPA ESCURO */
        linear-gradient(to bottom, #4f5b32 0%, #262f1c 40%, #141710 100%);

      color: #111;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      background-attachment: fixed;
    }

    .app {
      width: 100%;
      max-width: 900px;
      padding: 8px;
      box-sizing: border-box;
    }

    /* HEADER SEM CAIXA PRETA */
    header {
      position: sticky;
      top: 0;
      z-index: 999;
      background: transparent;
      padding: 10px 4px 4px;
      margin-bottom: 8px;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    #appLogo {
      max-width: 120px;
      height: auto;
      margin: 0;
      display: block;
    }

/* BLOCO DO T√çTULO EM 2 LINHAS */
.subtitle-block {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;   /* CENTRA as duas linhas */
  text-align: center;    /* texto centrado */
  cursor: pointer;
  font-family: "Stardos Stencil", system-ui, sans-serif;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  text-shadow: 0 2px 3px rgba(0, 0, 0, 0.7);
  transform-origin: center center;
  transition: transform 0.1s ease;
}

.subtitle-block:hover {
  transform: translateY(-1px);
}

.subtitle-line-1 {
  font-size: 0.85rem;
  color: #e0e5d8;
}

.subtitle-line-2 {
  font-size: 1.1rem;
  color: #fefce8;
  margin-top: 2px;
  border-bottom: 2px solid rgba(254, 252, 232, 0.85);
  padding-bottom: 1px;
  /* removido o align-self para n√£o empurrar a 2.¬™ linha para a esquerda */
}


    .card {
      background: #e1e1e1;
      background-image:
        linear-gradient(135deg, rgba(255, 255, 255, 0.18), rgba(180, 180, 180, 0.12)),
        repeating-linear-gradient(
          135deg,
          rgba(0, 0, 0, 0.09) 0px,
          rgba(0, 0, 0, 0.09) 1px,
          transparent 1px,
          transparent 4px
        );
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 16px;
      border: 1px solid #9d9d9d;
      box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.35),
        inset 0 0 0 1px rgba(255, 255, 255, 0.06);
    }

    /* PERFIL SEM ‚ÄúCART√ÉO‚Äù VIS√çVEL */
    #perfil.card {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
      margin-bottom: 6px;
    }

    #perfilForm {
      display: none;
      margin-bottom: 8px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .field {
      flex: 1;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.8rem;
      color: #2b2b2b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    input,
    select,
    textarea,
    button {
      padding: 10px;
      border-radius: 10px;
      background: #f8f8f8;
      color: #222;
      border: 1px solid #b7b7b7;
      font-size: 0.9rem;
      box-sizing: border-box;
      font-family: inherit;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.25);
    }

    /* BOT√ÉO PRINCIPAL ‚Äì ESTILO GUERRA SUJA */
    .btn-primary {
      background:
        linear-gradient(145deg, #1f7b3a, #0f4220);
      border: 1px solid #050806;
      color: #f4f4f4;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      box-shadow:
        0 3px 0 #050806,
        inset 0 0 0 1px rgba(255, 255, 255, 0.04);
      position: relative;
      overflow: hidden;
    }

    .btn-primary::after {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        repeating-linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.08) 0px,
          rgba(255, 255, 255, 0.08) 1px,
          transparent 1px,
          transparent 4px
        );
      mix-blend-mode: soft-light;
      opacity: 0.32;
      pointer-events: none;
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow:
        0 1px 0 #050806,
        inset 0 0 0 1px rgba(0, 0, 0, 0.3);
    }

    /* BOT√ïES SECUND√ÅRIOS ‚Äì RISCADOS / BATTLE WORN */
    .btn-secondary {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #303030;
      background:
        linear-gradient(145deg, #3b3f3a, #202320);
      color: #f2f2f2;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      box-shadow:
        0 3px 0 #050807,
        inset 0 0 0 1px rgba(255, 255, 255, 0.03);
      position: relative;
      overflow: hidden;
    }

    .btn-secondary::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        repeating-linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.07) 0px,
          rgba(255, 255, 255, 0.07) 1px,
          transparent 1px,
          transparent 5px
        );
      mix-blend-mode: soft-light;
      opacity: 0.28;
      pointer-events: none;
    }

    .btn-secondary:active {
      transform: translateY(1px);
      box-shadow: 0 1px 0 #050807;
    }

    /* BOT√ÉO APAGAR ‚Äì MANTIDO MAS MAIS ‚ÄúBRUTO‚Äù */
    .btn-delete {
      padding: 2px 4px;
      border-radius: 999px;
      border: 1px solid #3b0505;
      background:
        linear-gradient(145deg, #b93333, #7a1515);
      color: #ffffff;
      font-size: 0.75rem;
      cursor: pointer;
      box-shadow: 0 2px 0 #2a0202;
    }

    .btn-delete:hover {
      background: linear-gradient(145deg, #ef4444, #b91c1c);
    }

    .helper-text {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #222;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin: 10px 0 14px 0;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid #202320;
      background:
        linear-gradient(145deg, #32372f, #21241f);
      color: #f1f1f1;
      cursor: pointer;
      font-size: 0.9rem;
      box-shadow:
        0 4px 0 #050806,
        inset 0 0 0 1px rgba(255, 255, 255, 0.04);
      transition:
        transform 0.1s ease,
        box-shadow 0.1s ease,
        background 0.1s ease,
        border-color 0.1s ease,
        color 0.1s ease;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      position: relative;
      overflow: hidden;
    }

    .tab-btn::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        repeating-linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.08) 0px,
          rgba(255, 255, 255, 0.08) 1px,
          transparent 1px,
          transparent 4px
        );
      mix-blend-mode: soft-light;
      opacity: 0.3;
      pointer-events: none;
    }

    .tab-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 5px 0 #040605;
    }

    .tab-btn.active {
      background:
        linear-gradient(145deg, #1f7b3a, #0f4220);
      border-color: #0b2614;
      color: #ffffff;
      font-weight: 700;
      transform: translateY(2px);
      box-shadow: 0 2px 0 #041207;
    }

    .section { display: none; }
    .section.active { display: block; }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
    }

    .opt-btn {
      width: 100%;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .opt-emoji {
      font-size: 1.4rem;
    }

    .option-section {
      display: none;
    }

    .option-section.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      color: #111;
    }

    th,
    td {
      padding: 6px;
      text-align: center;
      border-bottom: 1px solid #d9d9d9;
      white-space: nowrap;
    }

    th {
      background: #d5d5d5;
      color: #222;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .scroll {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #b5b5b5;
      background: #f0f0f0;
    }

    #backupInfo {
      margin-top: 6px;
      font-size: 0.75rem;
      color: #222;
    }

    /* REMOVER RISCOS APENAS NO CARD "REGISTO E HIST√ìRICO" */
    #opt-wod .card:nth-of-type(2) {
      background-image: none !important;
      background-color: #e1e1e1 !important;
    }
  </style>
</head>
<body>
<div class="app">

  <header>
    <div class="header-row">
      <img id="appLogo" src="imagens/crossbox_logo.png" alt="CrossBox logo">
      <div class="subtitle-block" id="appSubtitle">
        <span class="subtitle-line-1" id="appSubtitleLine1">Registo de treinos</span>
        <span class="subtitle-line-2" id="appSubtitleLine2">Toca para configurar o teu perfil</span>
      </div>
    </div>
  </header>

  <!-- PERFIL -->
  <section class="card" id="perfil">
    <div id="perfilForm">
      <div class="form-row">
        <div class="field">
          <label>Nome</label>
          <input id="nome" type="text" />
        </div>
        <div class="field">
          <label>N√≠vel</label>
          <select id="nivel">
            <option value="">Selecionar</option>
            <option value="iniciante">Iniciante</option>
            <option value="intermedio">Interm√©dio</option>
            <option value="avancado">Avan√ßado</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Sexo</label>
          <select id="sexo">
            <option value="">Selecionar</option>
            <option value="homem">Homem</option>
            <option value="mulher">Mulher</option>
          </select>
        </div>
        <div class="field">
          <label>Idade</label>
          <input id="idade" type="number" min="10" max="100" />
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Altura (cm)</label>
          <input id="altura" type="number" min="100" max="230" />
        </div>
        <div class="field">
          <label>Peso (kg)</label>
          <input id="peso" type="number" step="0.1" min="30" max="250" />
        </div>
      </div>

      <button class="btn-primary" id="saveProfile">Guardar perfil</button>
    </div>
  </section>

  <!-- TABS PRINCIPAIS -->
  <div class="tabs">
    <button class="tab-btn active" data-target="sec-1rm">1RM</button>
    <button class="tab-btn" data-target="sec-opcoes">WOD & Tools</button>
  </div>

  <!-- SEC√á√ÉO 1: 1RM -->
  <section id="sec-1rm" class="section active">

    <div class="card">
      <div class="form-row">
        <div class="field">
          <label>Exerc√≠cio</label>
          <select id="exercise"></select>
        </div>

        <div class="field">
          <label>1RM (kg) ‚Äì peso m√°ximo numa repeti√ß√£o</label>
          <input id="oneRm" type="number" step="0.5" />
        </div>
      </div>

      <button class="btn-primary" id="addBtn">Guardar / Atualizar</button>
    </div>

    <div class="card">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Exerc√≠cio</th>
              <th>1RM</th>
              <th>25%</th>
              <th>30%</th>
              <th>35%</th>
              <th>40%</th>
              <th>50%</th>
              <th>60%</th>
              <th>65%</th>
              <th>70%</th>
              <th>75%</th>
              <th>80%</th>
              <th>85%</th>
              <th>90%</th>
              <th>95%</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

  </section>

  <!-- SEC√á√ÉO 2: OP√á√ïES -->
  <section id="sec-opcoes" class="section">

    <div class="card">
      <div class="options-grid">
        <button class="btn-secondary opt-btn" data-target="opt-wod">
          <span class="opt-emoji">üü©</span>
          <span>WOD</span>
        </button>

        <button class="btn-secondary opt-btn" data-target="opt-calc">
          <span class="opt-emoji">üßÆ</span>
          <span>Objetivo</span>
        </button>

        <button class="btn-secondary opt-btn" data-target="opt-graficos">
          <span class="opt-emoji">üìà</span>
          <span>Gr√°fico</span>
        </button>

        <button class="btn-secondary opt-btn" data-target="opt-performance">
          <span class="opt-emoji">üèÖ</span>
          <span>Desempenho</span>
        </button>

        <button class="btn-secondary opt-btn" data-target="opt-guia">
          <span class="opt-emoji">üìö</span>
          <span>Exerc√≠cios</span>
        </button>

        <button class="btn-secondary opt-btn" data-target="opt-backup">
          <span class="opt-emoji">üíæ</span>
          <span>Backup</span>
        </button>

        <!-- BOT√ÉO RESERVAS DENTRO DO WOD & TOOLS -->
        <button class="btn-secondary opt-btn" data-target="sec-reservas">
          <span class="opt-emoji">üìÜ</span>
          <span>Reservas</span>
        </button>
      </div>

      <div class="helper-text" style="margin-top:8px;">
      </div>
    </div>

    <!-- WOD -->
    <section id="opt-wod" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üü© WOD</h3>

        <div class="form-row">
          <div class="field">
            <label>Data</label>
            <input id="treinoData" type="date">
          </div>
          <div class="field">
            <label>Exerc√≠cio</label>
            <input id="treinoExercicioSearch" type="text" placeholder="Procurar exerc√≠cio..." />
            <select id="treinoExercicio"></select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Tipo</label>
            <select id="treinoTipo">
              <option value="">Selecionar</option>
              <option value="for√ßa">For√ßa</option>
              <option value="hipertrofia">Hipertrofia</option>
              <option value="t√©cnica">T√©cnica</option>
              <option value="metcon">Metcon</option>
            </select>
          </div>
          <div class="field">
            <label>Rondas / S√©ries</label>
            <input id="treinoRondas" type="number" min="1" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Repeti√ß√µes por s√©rie</label>
            <input id="treinoReps" type="number" min="1" />
          </div>
          <div class="field">
            <label>Peso (kg)</label>
            <input id="treinoPeso" type="number" step="0.5" min="0" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Tempo (opcional)</label>
            <input id="treinoTempo" type="text" placeholder="Ex.: 12:35, 20', AMRAP 10'..." />
          </div>
          <div class="field">
            <label>Dist√¢ncia (km ‚Äì Metcon, opcional)</label>
            <input id="treinoDist" type="number" step="0.01" min="0" />
          </div>
        </div>

        <button class="btn-primary" id="treinoAdd">Adicionar ao WOD</button>
        <div class="helper-text">
          A carga de cada exerc√≠cio (kg) √© calculada como: peso √ó repeti√ß√µes √ó rondas.
          A dist√¢ncia em metcon √© somada √† parte, em km.
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">Registo e hist√≥rico</h3>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Exerc√≠cio</th>
                <th>Tipo</th>
                <th>Rondas</th>
                <th>Reps</th>
                <th>Peso</th>
                <th>% 1RM</th>
                <th>Tempo</th>
                <th>Dist√¢ncia (km)</th>
                <th>Carga (kg)</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="treinoBody"></tbody>
          </table>
        </div>
        <div class="helper-text" id="treinoResumo"></div>
        <div class="helper-text" id="treinoSugestao" style="margin-top:4px; font-weight:500;"></div>
        <div class="helper-text" id="weeklyHistory" style="margin-top:6px;"></div>

        <button class="btn-secondary" id="toggleDailyHistory" style="margin-top:8px;">
          Hist√≥rico di√°rio completo
        </button>

        <div id="dailyHistorySection" style="display:none; margin-top:8px;">
          <div class="scroll">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Exerc√≠cio</th>
                  <th>Tipo</th>
                  <th>Rondas</th>
                  <th>Reps</th>
                  <th>Peso</th>
                  <th>% 1RM</th>
                  <th>Tempo</th>
                  <th>Dist√¢ncia (km)</th>
                  <th>Carga (kg)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="dailyHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- OBJETIVO -->
    <section id="opt-calc" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üßÆ Objetivo</h3>

        <div class="form-row">
          <div class="field">
            <label>Exerc√≠cio</label>
            <select id="calcExercicio"></select>
          </div>
          <div class="field">
            <label>N.¬∫ de repeti√ß√µes planeadas</label>
            <input id="calcReps" type="number" min="1" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Objetivo</label>
            <select id="calcObjetivo">
              <option value="">Autom√°tico</option>
              <option value="forca">For√ßa</option>
              <option value="hipertrofia">Hipertrofia</option>
              <option value="tecnica">T√©cnica / Volume leve</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Peso objetivo (kg ‚Äì opcional)</label>
            <input id="calcTargetKg" type="number" step="0.5" min="0" />
          </div>
          <div class="field">
            <label>Prazo (semanas ‚Äì opcional)</label>
            <input id="calcWeeks" type="number" min="1" />
          </div>
        </div>

        <button class="btn-primary" id="calcBtn">Calcular</button>
        <div class="helper-text" id="calcResultado" style="margin-top:6px;">
          Escolhe um exerc√≠cio, indica o n¬∫ de repeti√ß√µes e, se quiseres, o objetivo (for√ßa / hipertrofia / t√©cnica).
        </div>
      </div>
    </section>

    <!-- GR√ÅFICOS -->
    <section id="opt-graficos" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üìà Gr√°fico de evolu√ß√£o do 1RM</h3>
        <div class="field">
          <label>Exerc√≠cio</label>
          <select id="graphExercise"></select>
        </div>
        <div style="margin-top:8px;">
          <canvas id="rmChart" style="width:100%; max-height:260px;"></canvas>
        </div>
      </div>
    </section>

    <!-- PERFORMANCE -->
    <section id="opt-performance" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üèÖ Performance f√≠sica</h3>
        <p class="helper-text">
          Resumo autom√°tico com base nos teus registos de WOD, 1RM e metcons (carga em kg e dist√¢ncia em km).
        </p>

        <h4 style="margin-top:10px; margin-bottom:4px;">WOD ‚Äì dias com mais carga</h4>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Carga total (kg)</th>
                <th>Dist√¢ncia total (km)</th>
                <th>N.¬∫ exerc√≠cios</th>
                <th>Melhor tempo metcon</th>
              </tr>
            </thead>
            <tbody id="perfWodBody"></tbody>
          </table>
        </div>

        <h4 style="margin-top:12px; margin-bottom:4px;">Top 1RM</h4>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Exerc√≠cio</th>
                <th>1RM</th>
                <th>Rel. peso corporal</th>
              </tr>
            </thead>
            <tbody id="perf1rmBody"></tbody>
          </table>
        </div>

        <h4 style="margin-top:12px; margin-bottom:4px;">Metcon ‚Äì melhores tempos</h4>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Exerc√≠cio</th>
                <th>Melhor tempo</th>
                <th>Data</th>
                <th>Carga / dist√¢ncia</th>
              </tr>
            </thead>
            <tbody id="perfMetconBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- GUIA EXERC√çCIOS -->
    <section id="opt-guia" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üìö Guia de exerc√≠cios</h3>
        <input id="guiaSearch" type="text" placeholder="Procurar por nome (EN/PT) ou descri√ß√£o..." />
        <div class="scroll" style="margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th>Nome (EN)</th>
                <th>Tradu√ß√£o (PT)</th>
                <th>Descri√ß√£o</th>
              </tr>
            </thead>
            <tbody id="guiaBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BACKUP -->
    <section id="opt-backup" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üíæ Backup de dados</h3>
        <p class="helper-text">
          Exporta um ficheiro com o teu perfil, 1RM, hist√≥rico de WOD e restante informa√ß√£o.
          Podes guardar em Google Drive, iCloud, Ficheiros, etc. Para restaurar noutro telem√≥vel, basta importar o ficheiro.
        </p>
        <div class="form-row">
          <button class="btn-primary" id="exportBackupBtn">Exportar backup</button>
          <button class="btn-secondary" id="importBackupBtn">Importar backup</button>
          <input type="file" id="backupFileInput" accept="application/json" style="display:none;" />
        </div>
        <div id="backupInfo"></div>
      </div>
    </section>

    <!-- RESERVAS & PRESEN√áAS (AGORA DENTRO DO WOD & TOOLS) -->
    <section id="sec-reservas" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üìÜ Reservas & Presen√ßas</h3>

        <div class="form-row">
          <div class="field">
            <label>Data da aula</label>
            <input id="reservaData" type="date" />
          </div>
          <div class="field">
            <label>Hora</label>
            <input id="reservaHora" type="time" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Tipo de aula</label>
            <select id="reservaTipo">
              <option value="">Selecionar</option>
              <option value="WOD">WOD</option>
              <option value="Open Box">Open Box</option>
              <option value="Halterofilismo">Halterofilismo</option>
              <option value="Mobilidade">Mobilidade</option>
              <option value="Competi√ß√£o">Competi√ß√£o</option>
            </select>
          </div>

          <div class="field">
            <label>Nota (opcional)</label>
            <input id="reservaNota" type="text" placeholder="Ex.: parceiro, foco, objetivo do dia..." />
          </div>
        </div>

        <button class="btn-primary" id="reservaAddBtn">Guardar reserva</button>

        <div class="helper-text" style="margin-top:6px;">
          Estas reservas e presen√ßas s√£o pessoais e ficam apenas guardadas neste dispositivo.
        </div>

        <div class="scroll" style="margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Hora</th>
                <th>Aula</th>
                <th>Nota</th>
                <th>Presen√ßa</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="reservasBody"></tbody>
          </table>
        </div>

        <div class="helper-text" id="reservasResumo" style="margin-top:6px;"></div>
      </div>
    </section>

  </section>

</div>

<script>
/* ===== CHAVES DE ARMAZENAMENTO ===== */
const STORAGE_PROFILE = "crossfit_profile";
const STORAGE_RM = "crossfit_1rm";
const STORAGE_RM_HISTORY = "crossfit_1rm_history";
const STORAGE_TREINO = "crossfit_treinos";
const STORAGE_BACKUP_META = "crossfit_backup_meta";

/* NOVOS ARMAZENAMENTOS */
const STORAGE_RESERVAS = "crossfit_reservas";
const STORAGE_PRESENCAS = "crossfit_presencas";
const STORAGE_RANKINGS = "crossfit_rankings";

/* ===== PERFIL ===== */
let profile = JSON.parse(localStorage.getItem(STORAGE_PROFILE) || "{}");

const nomeEl = document.getElementById("nome");
const nivelEl = document.getElementById("nivel");
const sexoEl = document.getElementById("sexo");
const idadeEl = document.getElementById("idade");
const alturaEl = document.getElementById("altura");
const pesoEl = document.getElementById("peso");
const perfilForm = document.getElementById("perfilForm");
const subtitleEl = document.getElementById("appSubtitle");
const subtitleLine1El = document.getElementById("appSubtitleLine1");
const subtitleLine2El = document.getElementById("appSubtitleLine2");

function updateProfileInfo() {
  if (perfilForm) perfilForm.style.display = "none";
}

function updateSubtitle() {
  if (!subtitleLine1El || !subtitleLine2El) return;

  if (profile && profile.nome && profile.nome.trim() !== "") {
    // primeira linha SEM "de"
    subtitleLine1El.textContent = "Registo de treinos";
    subtitleLine2El.textContent = profile.nome.trim();
  } else {
    subtitleLine1El.textContent = "Registo de treinos";
    subtitleLine2El.textContent = "Toca para configurar o teu perfil";
  }
}

function loadProfile() {
  if (!sexoEl) return;
  if (profile.nome && nomeEl) nomeEl.value = profile.nome;
  if (profile.nivel && nivelEl) nivelEl.value = profile.nivel;
  if (profile.sexo) sexoEl.value = profile.sexo;
  if (profile.idade) idadeEl.value = profile.idade;
  if (profile.altura) alturaEl.value = profile.altura;
  if (profile.peso) pesoEl.value = profile.peso;
  updateProfileInfo();
  updateSubtitle();
}

const saveProfileBtn = document.getElementById("saveProfile");
if (saveProfileBtn) {
  saveProfileBtn.addEventListener("click", () => {
    profile = {
      nome: nomeEl && nomeEl.value ? nomeEl.value.trim() : "",
      nivel: nivelEl ? (nivelEl.value || "") : "",
      sexo: sexoEl.value || "",
      idade: idadeEl.value ? parseInt(idadeEl.value, 10) : "",
      altura: alturaEl.value ? parseInt(alturaEl.value, 10) : "",
      peso: pesoEl.value ? parseFloat(pesoEl.value) : ""
    };
    localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
    updateProfileInfo();
    updateSubtitle();
    registerBackupMeta("Perfil atualizado");
    alert("Perfil atualizado.");
    renderPerformance();
  });
}

/* clicar no t√≠tulo abre/fecha o formul√°rio de perfil */
if (subtitleEl && perfilForm) {
  subtitleEl.addEventListener("click", () => {
    const visible = perfilForm.style.display === "block";
    perfilForm.style.display = visible ? "none" : "block";
  });
}

/* ===== EXERC√çCIOS ===== */
const MOVES = [
  "Chest Press",
  "Back Squat",
  "Front Squat",
  "Overhead Squat",
  "Deadlift",
  "Sumo Deadlift",
  "Romanian Deadlift (RDL)",
  "Power Clean",
  "Squat Clean",
  "Clean & Jerk",
  "Power Snatch",
  "Squat Snatch",
  "Push Press",
  "Push Jerk",
  "Split Jerk",
  "Strict Press",
  "Thruster",
  "Barbell Row",
  "Bent Over Row",
  "Good Morning",
  "Lunges com barra",
  "Hip Thrust com barra",
  "Dumbbell Press",
  "Dumbbell Bench Press",
  "Dumbbell Snatch",
  "Dumbbell Clean",
  "Dumbbell Clean & Jerk",
  "Dumbbell Thruster",
  "Dumbbell Row",
  "Dumbbell Lunges",
  "Kettlebell Swing",
  "Kettlebell Clean",
  "Kettlebell Snatch",
  "Goblet Squat",
  "Kettlebell Lunges"
];

const MOVES_PT = {
  "Chest Press": "Supino com barra",
  "Back Squat": "Agachamento com barra nas costas",
  "Front Squat": "Agachamento frontal",
  "Overhead Squat": "Agachamento acima da cabe√ßa",
  "Deadlift": "Peso morto",
  "Sumo Deadlift": "Peso morto sumo",
  "Romanian Deadlift (RDL)": "Peso morto romeno",
  "Power Clean": "Power clean",
  "Squat Clean": "Squat clean",
  "Clean & Jerk": "Clean & jerk",
  "Power Snatch": "Power snatch",
  "Squat Snatch": "Squat snatch",
  "Push Press": "Push press",
  "Push Jerk": "Push jerk",
  "Split Jerk": "Split jerk",
  "Strict Press": "Press militar estrito",
  "Thruster": "Thruster",
  "Barbell Row": "Remada com barra",
  "Bent Over Row": "Remada inclinada",
  "Good Morning": "Good morning",
  "Lunges com barra": "Passadas com barra",
  "Hip Thrust com barra": "Hip thrust com barra",
  "Dumbbell Press": "Press com halteres",
  "Dumbbell Bench Press": "Supino com halteres",
  "Dumbbell Snatch": "Snatch com halteres",
  "Dumbbell Clean": "Clean com halteres",
  "Dumbbell Clean & Jerk": "Clean & jerk com halteres",
  "Dumbbell Thruster": "Thruster com halteres",
  "Dumbbell Row": "Remada com halteres",
  "Dumbbell Lunges": "Passadas com halteres",
  "Kettlebell Swing": "Swing com kettlebell",
  "Kettlebell Clean": "Clean com kettlebell",
  "Kettlebell Snatch": "Snatch com kettlebell",
  "Goblet Squat": "Agachamento goblet",
  "Kettlebell Lunges": "Passadas com kettlebell"
};

/* GUIA ‚Äì LISTA TIPO JSON (inclui mais exerc√≠cios que MOVES) */
const EXER_INFO = [
  { en: "Chest Press", pt: "Supino com barra", descricao: "Empurrar a barra para longe do peito, deitado no banco, controlando a descida e a subida." },
  { en: "Back Squat", pt: "Agachamento com barra nas costas", descricao: "Agachamento com a barra apoiada nas costas, descendo at√© pelo menos √† paralela e subindo com o tronco firme." },
  { en: "Front Squat", pt: "Agachamento frontal", descricao: "Agachamento com a barra apoiada na parte da frente dos ombros, mantendo o tronco mais vertical." },
  { en: "Overhead Squat", pt: "Agachamento acima da cabe√ßa", descricao: "Agachamento com a barra acima da cabe√ßa, bra√ßos estendidos e core bem firme para estabilizar." },
  { en: "Deadlift", pt: "Peso morto", descricao: "Levar a barra do ch√£o at√© √† anca com costas neutras, empurrando o ch√£o com as pernas e contraindo gl√∫teos no topo." },
  { en: "Sumo Deadlift", pt: "Peso morto sumo", descricao: "Peso morto com p√©s mais afastados e m√£os a agarrar a barra entre as pernas, reduzindo a amplitude de anca." },
  { en: "Romanian Deadlift (RDL)", pt: "Peso morto romeno", descricao: "Peso morto com menor flex√£o de joelhos, focado em posteriores da coxa e gl√∫teos, mantendo a barra perto do corpo." },
  { en: "Power Clean", pt: "Power clean", descricao: "Levar a barra do ch√£o at√© aos ombros de forma explosiva, recebendo-a acima da paralela." },
  { en: "Squat Clean", pt: "Squat clean", descricao: "Clean com rece√ß√£o em agachamento completo antes de subir para a posi√ß√£o de p√©." },
  { en: "Clean & Jerk", pt: "Clean & jerk", descricao: "Levar a barra do ch√£o aos ombros (clean) e dos ombros at√© acima da cabe√ßa (jerk) em dois movimentos distintos." },
  { en: "Power Snatch", pt: "Power snatch", descricao: "Arranco com rece√ß√£o acima da paralela, num √∫nico movimento do ch√£o at√© overhead." },
  { en: "Squat Snatch", pt: "Squat snatch", descricao: "Arranco com rece√ß√£o em agachamento profundo, seguido de extens√£o at√© ficar totalmente de p√©." },
  { en: "Push Press", pt: "Push press", descricao: "Press de ombros com pequeno impulso das pernas, terminando com a barra acima da cabe√ßa." },
  { en: "Push Jerk", pt: "Push jerk", descricao: "Impulso de pernas e encaixe da barra acima da cabe√ßa, recebendo em semi-agachamento antes de estender." },
  { en: "Split Jerk", pt: "Split jerk", descricao: "Jerk em passada, recebendo a barra overhead com uma perna √† frente e outra atr√°s para maior estabilidade." },
  { en: "Strict Press", pt: "Press militar estrito", descricao: "Press de ombros sem ajuda das pernas, s√≥ com for√ßa dos ombros e bra√ßos, de p√© ou sentado." },
  { en: "Thruster", pt: "Thruster", descricao: "Agachamento frontal seguido diretamente de press acima da cabe√ßa num √∫nico movimento fluido." },
  { en: "Barbell Row", pt: "Remada com barra", descricao: "Com o tronco inclinado √† frente, puxar a barra em dire√ß√£o ao abd√≥men mantendo as costas neutras." },
  { en: "Bent Over Row", pt: "Remada inclinada", descricao: "Remada com maior inclina√ß√£o do tronco, focando dorsais e parte m√©dia das costas." },
  { en: "Good Morning", pt: "Good morning", descricao: "Com a barra nas costas, inclinar o tronco √† frente com ligeira flex√£o de joelhos e voltar √† posi√ß√£o inicial." },
  { en: "Lunges com barra", pt: "Passadas com barra", descricao: "Passadas √† frente ou atr√°s com a barra apoiada nos ombros, mantendo o tronco direito." },
  { en: "Hip Thrust com barra", pt: "Hip thrust com barra", descricao: "Elevar a anca com as costas apoiadas num banco e a barra sobre a bacia, contraindo bem os gl√∫teos." },
  { en: "Dumbbell Press", pt: "Press com halteres", descricao: "Press de ombros com halteres, de p√© ou sentado, subindo os halteres acima da cabe√ßa." },
  { en: "Dumbbell Bench Press", pt: "Supino com halteres", descricao: "Deitado no banco, empurrar dois halteres para cima a partir do peito, controlando a descida." },
  { en: "Dumbbell Snatch", pt: "Snatch com halteres", descricao: "Do ch√£o at√© acima da cabe√ßa com um haltere, num movimento explosivo e cont√≠nuo." },
  { en: "Dumbbell Clean", pt: "Clean com halteres", descricao: "Levar o haltere do ch√£o ou das pernas at√© ao ombro, com extens√£o de anca." },
  { en: "Dumbbell Clean & Jerk", pt: "Clean & jerk com halteres", descricao: "Clean com haltere at√© ao ombro seguido de impulso at√© overhead." },
  { en: "Dumbbell Thruster", pt: "Thruster com halteres", descricao: "Agachamento seguido de press com halteres acima da cabe√ßa num s√≥ movimento." },
  { en: "Dumbbell Row", pt: "Remada com halteres", descricao: "Remada unilateral ou bilateral puxando o haltere em dire√ß√£o ao tronco, focando dorsais." },
  { en: "Dumbbell Lunges", pt: "Passadas com halteres", descricao: "Passadas segurando um haltere em cada m√£o junto ao corpo." },
  { en: "Kettlebell Swing", pt: "Swing com kettlebell", descricao: "Balan√ßo da kettlebell usando sobretudo o impulso da anca, n√£o dos bra√ßos." },
  { en: "Kettlebell Clean", pt: "Clean com kettlebell", descricao: "Levar a kettlebell do fundo at√© √† posi√ß√£o de rack junto ao peito." },
  { en: "Kettlebell Snatch", pt: "Snatch com kettlebell", descricao: "Arranco unilateral, do ch√£o ou baloi√ßo at√© acima da cabe√ßa." },
  { en: "Goblet Squat", pt: "Agachamento goblet", descricao: "Agachamento segurando a kettlebell ou haltere junto ao peito, com p√©s √† largura dos ombros." },
  { en: "Kettlebell Lunges", pt: "Passadas com kettlebell", descricao: "Passadas segurando a kettlebell ao lado do corpo ou em posi√ß√£o de rack." },

  /* GIN√ÅSTICA / CALISTENIA */
  { en: "Pull-Up", pt: "Puxada na barra", descricao: "Suspenso na barra, puxar at√© o queixo ultrapassar a barra, usando pegada em prona√ß√£o." },
  { en: "Chin-Up", pt: "Puxada em supina√ß√£o", descricao: "Semelhante ao pull-up, mas com palmas das m√£os viradas para ti, focando mais b√≠ceps." },
  { en: "Chest-to-Bar Pull-Up", pt: "Puxada ao peito", descricao: "Puxada na barra at√© o peito tocar na barra, exigindo maior amplitude." },
  { en: "Bar Muscle-Up", pt: "Muscle-up na barra", descricao: "Puxada explosiva seguida de transi√ß√£o e dip, terminando com o tronco por cima da barra." },
  { en: "Ring Muscle-Up", pt: "Muscle-up nas argolas", descricao: "Vers√£o nas argolas, mais inst√°vel, combinando puxada e dip num s√≥ movimento." },
  { en: "Toes-to-Bar (T2B)", pt: "P√©s √† barra", descricao: "Suspenso na barra, elevar os p√©s at√© tocar na barra, usando controlo de core." },
  { en: "Knees-to-Elbows (K2E)", pt: "Joelhos aos cotovelos", descricao: "Suspenso na barra, elevar os joelhos at√© tocar nos cotovelos." },
  { en: "Hanging Knee Raise", pt: "Eleva√ß√£o de joelhos", descricao: "Vers√£o mais simples, elevando os joelhos at√© √† altura da anca ou ligeiramente acima." },
  { en: "Handstand Push-Up (HSPU)", pt: "Flex√£o de bra√ßos em pino", descricao: "Em pino contra a parede ou livre, realizar flex√µes de bra√ßos at√© a cabe√ßa tocar ligeiramente no ch√£o ou alvo." },
  { en: "Handstand Walk", pt: "Caminhada em pino", descricao: "Deslocar-se apoiado apenas nas m√£os, em posi√ß√£o de pino." },
  { en: "Pistol Squat", pt: "Agachamento numa perna", descricao: "Agachamento completo numa perna, mantendo a outra estendida √† frente." },
  { en: "Sit-Up", pt: "Abdominal", descricao: "Deitado de costas, subir o tronco at√© ficar sentado, muitas vezes com apoio de almofada de abdominais." },
  { en: "GHD Sit-Up", pt: "Abdominal GHD", descricao: "Abdominal profundo na m√°quina GHD, descendo al√©m da linha da anca e regressando ao topo." },
  { en: "Back Extension (GHD)", pt: "Extens√£o lombar", descricao: "Na GHD, descer o tronco em flex√£o de anca e voltar √† extens√£o, focando lombar e gl√∫teos." },

  /* METCON / CONDICIONAMENTO */
  { en: "Burpee", pt: "Burpee", descricao: "Agachar, colocar as m√£os no ch√£o, fazer flex√£o, voltar a levantar e terminar com um salto." },
  { en: "Burpee Box Jump-Over", pt: "Burpee com salto sobre a caixa", descricao: "Realizar um burpee e depois saltar por cima da caixa, podendo n√£o aterrar em p√© em cima dela." },
  { en: "Box Jump", pt: "Salto para a caixa", descricao: "Saltar com os dois p√©s para cima da caixa e estabilizar antes de descer." },
  { en: "Box Jump Over", pt: "Salto por cima da caixa", descricao: "Saltar para cima e para o outro lado da caixa, sem necessidade de estabilizar no topo." },
  { en: "Wall Ball", pt: "Lan√ßamento de bola", descricao: "Agachamento com bola medicinal seguido de lan√ßamento at√© um alvo na parede." },
  { en: "Rowing", pt: "Remo", descricao: "Exerc√≠cio na m√°quina de remo, trabalhando pernas, tronco e bra√ßos de forma coordenada." },
  { en: "Ski Erg", pt: "Ski erg", descricao: "Simulador de esqui, puxando as manetes de cima para baixo em movimento cont√≠nuo." },
  { en: "Assault Bike", pt: "Bicicleta de resist√™ncia", descricao: "Bicicleta com resist√™ncia de ar, trabalhando simultaneamente bra√ßos e pernas." },
  { en: "Running", pt: "Corrida", descricao: "Corrida simples, em tapete ou no exterior, podendo ser em ritmo cont√≠nuo ou intervalado." },
  { en: "Double Under", pt: "Saltos duplos na corda", descricao: "Saltos em que a corda passa duas vezes por baixo dos p√©s em cada salto." },
  { en: "Single Under", pt: "Saltos simples na corda", descricao: "Saltos em que a corda passa uma vez por baixo dos p√©s em cada salto." },
  { en: "Sled Push", pt: "Empurrar tren√≥", descricao: "Empurrar um tren√≥ com carga ao longo de uma dist√¢ncia definida." },
  { en: "Sled Pull", pt: "Puxar tren√≥", descricao: "Puxar tren√≥ com carga, com arn√™s ou corda, para tr√°s ou para a frente." },
  { en: "Farmer Carry", pt: "Caminhada com cargas", descricao: "Caminhar segurando cargas pesadas (halteres ou kettlebells) ao lado do corpo." },
  { en: "Sprint", pt: "Sprint", descricao: "Corrida explosiva de curta dist√¢ncia, normalmente em m√°xima intensidade." },

  /* COMPLEXOS / FOR√áA FUNCIONAL */
  { en: "Bear Complex", pt: "Bear complex", descricao: "Sequ√™ncia cont√≠nua: power clean, front squat, push press, back squat e push press novamente." },
  { en: "Devil Press", pt: "Devil press", descricao: "Burpee com halteres seguido de swing at√© overhead, num movimento fluido." },
  { en: "Man Maker", pt: "Man maker", descricao: "Combina√ß√£o de remada, burpee, clean e thruster com halteres." },
  { en: "Sandbag Carry", pt: "Caminhada com saco", descricao: "Transportar um saco pesado ao peito, ombro ou costas ao longo de uma dist√¢ncia." },
  { en: "Yoke Carry", pt: "Caminhada com yoke", descricao: "Caminhar com uma estrutura pesada apoiada nos ombros (yoke), trabalhando for√ßa total." },
  { en: "Rope Climb", pt: "Subida √† corda", descricao: "Subir a corda usando t√©cnica de pernas ou apenas bra√ßos, tocando um alvo no topo." },

  /* ACESS√ìRIOS / MOBILIDADE EXTRA */
  { en: "Hip Thrust", pt: "Eleva√ß√£o de anca", descricao: "Elevar a anca com costas apoiadas num banco, com ou sem carga, focando gl√∫teos." },
  { en: "Glute Bridge", pt: "Ponte de gl√∫teos", descricao: "Elevar a anca a partir de posi√ß√£o deitado no ch√£o, mantendo ombros apoiados." },
  { en: "Reverse Hyperextension", pt: "Hiperextens√£o reversa", descricao: "Exerc√≠cio na m√°quina Reverse Hyper, elevando as pernas atr√°s do corpo para trabalhar gl√∫teos e lombar." },
  { en: "Shrug", pt: "Encolhimento de ombros", descricao: "Elevar os ombros em dire√ß√£o √†s orelhas segurando barra ou halteres, focando trap√©zios." }
];

/* Lista completa de exerc√≠cios em ingl√™s (para WOD, Objetivo, Guia) */
const ALL_EXERCISES = Array.from(new Set(EXER_INFO.map(ex => ex.en))).sort();

/* Completar MOVES_PT com todos os exerc√≠cios do guia */
EXER_INFO.forEach(ex => {
  MOVES_PT[ex.en] = ex.pt;
});

const PERC = [
  0.25, 0.30, 0.35, 0.40, 0.50, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.90, 0.95
];

let dataRm = JSON.parse(localStorage.getItem(STORAGE_RM) || "{}");
let rmHistory = JSON.parse(localStorage.getItem(STORAGE_RM_HISTORY) || "{}");

const sel = document.getElementById("exercise");
const rm = document.getElementById("oneRm");
const bodyTable = document.getElementById("tableBody");

/* WOD */
let treinos = JSON.parse(localStorage.getItem(STORAGE_TREINO) || "[]");

const treinoDataEl = document.getElementById("treinoData");
const treinoExEl = document.getElementById("treinoExercicio");
const treinoExSearchEl = document.getElementById("treinoExercicioSearch");
const treinoTipoEl = document.getElementById("treinoTipo");
const treinoRondasEl = document.getElementById("treinoRondas");
const treinoRepsEl = document.getElementById("treinoReps");
const treinoPesoEl = document.getElementById("treinoPeso");
const treinoTempoEl = document.getElementById("treinoTempo");
const treinoDistEl = document.getElementById("treinoDist");
const treinoAddBtn = document.getElementById("treinoAdd");
const treinoBody = document.getElementById("treinoBody");
const treinoResumoEl = document.getElementById("treinoResumo");
const treinoSugestaoEl = document.getElementById("treinoSugestao");
const weeklyHistoryEl = document.getElementById("weeklyHistory");
const toggleDailyHistoryBtn = document.getElementById("toggleDailyHistory");
const dailyHistorySection = document.getElementById("dailyHistorySection");
const dailyHistoryBody = document.getElementById("dailyHistoryBody");

/* OBJETIVO */
const calcExEl = document.getElementById("calcExercicio");
const calcRepsEl = document.getElementById("calcReps");
const calcObjEl = document.getElementById("calcObjetivo");
const calcTargetKgEl = document.getElementById("calcTargetKg");
const calcWeeksEl = document.getElementById("calcWeeks");
const calcResEl = document.getElementById("calcResultado");
const calcBtn = document.getElementById("calcBtn");

/* Gr√°ficos */
const graphExerciseEl = document.getElementById("graphExercise");
const rmChartCanvas = document.getElementById("rmChart");
let rmChart = null;

/* Guia exerc√≠cios */
const guiaBody = document.getElementById("guiaBody");
const guiaSearch = document.getElementById("guiaSearch");

/* Performance (rankings) */
const perfWodBody = document.getElementById("perfWodBody");
const perf1rmBody = document.getElementById("perf1rmBody");
const perfMetconBody = document.getElementById("perfMetconBody");

/* Backup */
const exportBackupBtn = document.getElementById("exportBackupBtn");
const importBackupBtn = document.getElementById("importBackupBtn");
const backupFileInput = document.getElementById("backupFileInput");
const backupInfoEl = document.getElementById("backupInfo");

/* Reservas & presen√ßas */
const reservasBtn = document.getElementById("reservasBtn");
const reservasSection = document.getElementById("sec-reservas");
const reservaDataEl = document.getElementById("reservaData");
const reservaHoraEl = document.getElementById("reservaHora");
const reservaTipoEl = document.getElementById("reservaTipo");
const reservaNotaEl = document.getElementById("reservaNota");
const reservaAddBtn = document.getElementById("reservaAddBtn");
const reservasBody = document.getElementById("reservasBody");
const reservasResumoEl = document.getElementById("reservasResumo");

let reservas = JSON.parse(localStorage.getItem(STORAGE_RESERVAS) || "[]");
let presencas = JSON.parse(localStorage.getItem(STORAGE_PRESENCAS) || "[]");
let rankingsMensais = JSON.parse(localStorage.getItem(STORAGE_RANKINGS) || "[]");

function formatKg(v) {
  return v.toFixed(1).replace(".", ",") + " kg";
}

function formatKm(v) {
  return v.toFixed(2).replace(".", ",") + " km";
}

/* Selects ‚Äì 1RM s√≥ com MOVES (peso); WOD com ALL_EXERCISES */
function updateTreinoExercicioOptions(filter) {
  if (!treinoExEl) return;
  const f = (filter || "").toLowerCase();
  treinoExEl.innerHTML = "";
  ALL_EXERCISES.forEach(m => {
    const label = MOVES_PT[m] ? `${m} ‚Äì ${MOVES_PT[m]}` : m;
    if (f && !label.toLowerCase().includes(f)) return;
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = label;
    treinoExEl.appendChild(opt);
  });
}

function initSelects() {
  if (sel) {
    sel.innerHTML = "";
    MOVES.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      const label = MOVES_PT[m] ? `${m} ‚Äì ${MOVES_PT[m]}` : m;
      opt.textContent = label;
      sel.appendChild(opt);
    });
  }

  updateTreinoExercicioOptions("");
}

if (treinoExSearchEl) {
  treinoExSearchEl.addEventListener("input", () => {
    updateTreinoExercicioOptions(treinoExSearchEl.value || "");
  });
}

/* OBJETIVO ‚Äì lista completa de exerc√≠cios; c√°lculo s√≥ funciona se tiver 1RM */
function refreshCalcExOptions() {
  if (!calcExEl) return;
  calcExEl.innerHTML = "";

  if (!ALL_EXERCISES.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Sem exerc√≠cios dispon√≠veis";
    calcExEl.appendChild(opt);
    calcExEl.disabled = true;
    return;
  }

  calcExEl.disabled = false;
  ALL_EXERCISES.forEach(n => {
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    calcExEl.appendChild(opt);
  });
}

function refreshGraphExerciseOptions() {
  if (!graphExerciseEl) return;
  const allNames = new Set([
    ...Object.keys(dataRm || {}),
    ...Object.keys(rmHistory || {})
  ]);
  const names = Array.from(allNames).sort();

  graphExerciseEl.innerHTML = "";
  if (!names.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Sem dados de 1RM";
    graphExerciseEl.appendChild(opt);
    graphExerciseEl.disabled = true;
    updateRmChart();
    return;
  }

  graphExerciseEl.disabled = false;
  names.forEach(n => {
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    graphExerciseEl.appendChild(opt);
  });

  updateRmChart();
}

function deleteEx(name) {
  if (!name) return;
  if (!confirm(`Apagar o exerc√≠cio "${name}"?`)) return;
  delete dataRm[name];
  delete rmHistory[name];
  localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
  localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory));
  registerBackupMeta("1RM removido");
  renderRm();
}

function renderRm() {
  bodyTable.innerHTML = "";
  Object.keys(dataRm).sort().forEach(name => {
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    const label = MOVES_PT[name] ? `${name} ‚Äì ${MOVES_PT[name]}` : name;
    tdName.textContent = label;
    tr.appendChild(tdName);

    const td1rm = document.createElement("td");
    let oneRmText = formatKg(dataRm[name]);

    if (profile && profile.peso) {
      const rel = dataRm[name] / profile.peso;
      oneRmText += " (" + rel.toFixed(2) + "x peso corporal)";
    }

    const histList = rmHistory[name] || [];
    if (histList.length) {
      const prev = histList[histList.length - 1];
      const prevVal = prev.value;
      const diff = dataRm[name] - prevVal;
      if (Math.abs(diff) >= 0.5) {
        const seta = diff > 0 ? "‚Üë" : "‚Üì";
        const diffAbs = Math.abs(diff).toFixed(1).replace(".", ",");
        oneRmText += ` ¬∑ ${seta} ${diffAbs} kg vs anterior`;
      }
    }

    td1rm.textContent = oneRmText;
    tr.appendChild(td1rm);

    PERC.forEach(p => {
      const td = document.createElement("td");
      td.textContent = formatKg(dataRm[name] * p);
      tr.appendChild(td);
    });

    const tdDelete = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üóë";
    btn.className = "btn-delete";
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      deleteEx(name);
    });
    tdDelete.appendChild(btn);
    tr.appendChild(tdDelete);

    bodyTable.appendChild(tr);
  });

  refreshCalcExOptions();
  refreshGraphExerciseOptions();
  renderPerformance();
}

document.getElementById("addBtn").addEventListener("click", () => {
  const ex = sel.value;
  const val = parseFloat(rm.value);
  if (!ex || !val || val <= 0) return;

  const old = dataRm[ex];

  if (typeof old === "number" && !isNaN(old) && old !== val) {
    if (!rmHistory[ex]) rmHistory[ex] = [];
    rmHistory[ex].push({
      date: new Date().toISOString().slice(0, 10),
      value: old
    });
  }

  dataRm[ex] = val;
  localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
  localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory));

  rm.value = "";
  registerBackupMeta("1RM atualizado");
  renderRm();
});

/* ===== OBJETIVO (CALCULADORA) ===== */
function getPercentRange(reps, objetivo) {
  let minP, maxP;

  if (objetivo === "forca") {
    if (reps <= 2) { minP = 0.9; maxP = 0.98; }
    else if (reps <= 3) { minP = 0.88; maxP = 0.95; }
    else if (reps <= 5) { minP = 0.80; maxP = 0.90; }
    else { minP = 0.75; maxP = 0.85; }
  } else if (objetivo === "hipertrofia") {
    if (reps <= 5) { minP = 0.75; maxP = 0.85; }
    else if (reps <= 8) { minP = 0.70; maxP = 0.80; }
    else if (reps <= 12) { minP = 0.65; maxP = 0.75; }
    else { minP = 0.55; maxP = 0.70; }
  } else if (objetivo === "tecnica") {
    if (reps <= 5) { minP = 0.50; maxP = 0.65; }
    else if (reps <= 10) { minP = 0.45; maxP = 0.60; }
    else { minP = 0.40; maxP = 0.55; }
  } else {
    if (reps === 1) { minP = 0.9; maxP = 1.0; }
    else if (reps <= 3) { minP = 0.85; maxP = 0.95; }
    else if (reps <= 5) { minP = 0.80; maxP = 0.90; }
    else if (reps <= 8) { minP = 0.70; maxP = 0.80; }
    else if (reps <= 12) { minP = 0.65; maxP = 0.75; }
    else { minP = 0.50; maxP = 0.65; }
  }

  return { minP, maxP };
}

if (calcBtn) {
  calcBtn.addEventListener("click", () => {
    if (!calcExEl || !calcRepsEl || !calcResEl) return;

    const ex = calcExEl.value;
    const reps = parseInt(calcRepsEl.value || "0", 10);
    const obj = calcObjEl ? calcObjEl.value : "";
    const targetKgVal = calcTargetKgEl ? parseFloat(calcTargetKgEl.value || "0") : 0;
    const weeksVal = calcWeeksEl ? parseInt(calcWeeksEl.value || "0", 10) : 0;

    if (!ex) {
      calcResEl.textContent = "Escolhe um exerc√≠cio.";
      return;
    }
    if (!reps || reps <= 0) {
      calcResEl.textContent = "Indica o n√∫mero de repeti√ß√µes.";
      return;
    }
    if (!dataRm[ex]) {
      calcResEl.textContent = "Para calcular percentagens de carga, regista primeiro o 1RM desse exerc√≠cio.";
      return;
    }

    const oneRmVal = dataRm[ex];
    const { minP, maxP } = getPercentRange(reps, obj);
    const minLoad = oneRmVal * minP;
    const maxLoad = oneRmVal * maxP;

    let objetivoTexto = "autom√°tico";
    if (obj === "forca") objetivoTexto = "for√ßa";
    if (obj === "hipertrofia") objetivoTexto = "hipertrofia";
    if (obj === "tecnica") objetivoTexto = "t√©cnica / volume leve";

    let msg =
      `Para ${reps} repeti√ß√µes em ${ex}, com objetivo ${objetivoTexto}, ` +
      `a carga sugerida √© entre ${(minP*100).toFixed(0)}% e ${(maxP*100).toFixed(0)}% do 1RM: ` +
      `${formatKg(minLoad)} ‚Äì ${formatKg(maxLoad)}. Ajusta ligeiramente para bater certo com os discos que tens.`;

    if (targetKgVal && !isNaN(targetKgVal)) {
      if (targetKgVal <= oneRmVal) {
        msg += `\n\nO peso objetivo (${formatKg(targetKgVal)}) est√° abaixo ou muito pr√≥ximo do teu 1RM atual. Foca-te em consolidar t√©cnica, controlar o volume e manter consist√™ncia semanal.`;
      } else {
        if (weeksVal && weeksVal > 0) {
          const incPercent = ((targetKgVal - oneRmVal) / oneRmVal) * 100;
          const incPerWeek = incPercent / weeksVal;
          let dificuldade;
          if (incPerWeek <= 1) {
            dificuldade = "uma progress√£o realista";
          } else if (incPerWeek <= 2) {
            dificuldade = "uma progress√£o exigente mas ainda poss√≠vel";
          } else {
            dificuldade = "uma progress√£o muito agressiva e pouco realista para a maioria das pessoas";
          }

          const nivel = (profile && profile.nivel) ? profile.nivel.toLowerCase() : "";
          let freq = "2‚Äì3 sess√µes semanais";
          let seriesReps = "3‚Äì5 s√©ries de 3‚Äì6 repeti√ß√µes entre 75‚Äì90% do 1RM atual";

          if (nivel === "iniciante") {
            freq = "2‚Äì3 sess√µes semanais focadas no movimento principal";
            seriesReps = "3‚Äì4 s√©ries de 5‚Äì8 repeti√ß√µes entre 70‚Äì80% do 1RM atual";
          } else if (nivel === "intermedio") {
            freq = "2‚Äì3 sess√µes semanais com varia√ß√µes do movimento principal";
            seriesReps = "4‚Äì5 s√©ries de 3‚Äì6 repeti√ß√µes entre 75‚Äì85% do 1RM atual";
          } else if (nivel === "avancado") {
            freq = "2‚Äì3 sess√µes semanais mais espec√≠ficas (for√ßa + varia√ß√µes t√©cnicas)";
            seriesReps = "3‚Äì6 s√©ries entre 2‚Äì5 repeti√ß√µes a 80‚Äì90% do 1RM atual";
          }

          msg += `\n\nObjetivo: chegar a ${formatKg(targetKgVal)} em cerca de ${weeksVal} semanas (${dificuldade}). ` +
                 `Uma sugest√£o, tendo em conta o teu n√≠vel, √© realizar ${freq} de ${ex}, com ${seriesReps}, ` +
                 `aumentando 2,5‚Äì5 kg quando conseguires todas as s√©ries com boa t√©cnica e sem falhas.`;
        } else {
          msg += `\n\nTens como objetivo chegar a ${formatKg(targetKgVal)}. Define um prazo em semanas para obteres uma recomenda√ß√£o mais detalhada de volume e frequ√™ncia.`;
        }
      }
    }

    calcResEl.textContent = msg;
  });
}

/* ===== GR√ÅFICO 1RM ===== */
function updateRmChart() {
  if (!rmChartCanvas || !graphExerciseEl) return;

  const ex = graphExerciseEl.value;
  let labels = [];
  let values = [];

  if (ex && (rmHistory[ex] || dataRm[ex])) {
    const hist = (rmHistory[ex] || []).slice().sort((a, b) => {
      return (a.date || "").localeCompare(b.date || "");
    });

    hist.forEach((entry, idx) => {
      labels.push(entry.date || "h" + (idx + 1));
      values.push(entry.value);
    });

    if (dataRm[ex]) {
      labels.push("Atual");
      values.push(dataRm[ex]);
    }
  }

  const ctx = rmChartCanvas.getContext("2d");

  if (rmChart) {
    rmChart.destroy();
    rmChart = null;
  }

  if (!labels.length) {
    rmChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: ["Sem dados"],
        datasets: [{
          label: "1RM (kg)",
          data: [0],
          tension: 0.25
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { display: false },
          y: { display: false }
        }
      }
    });
    return;
  }

  const datasetLabel = MOVES_PT[ex] ? `${ex} ‚Äì ${MOVES_PT[ex]} ‚Äì 1RM (kg)` : ex + " ‚Äì 1RM (kg)";

  rmChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: datasetLabel,
        data: values,
        tension: 0.25
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        x: {
          title: { display: true, text: "Registos" }
        },
        y: {
          title: { display: true, text: "Peso (kg)" },
          beginAtZero: false
        }
      }
    }
  });
}

if (graphExerciseEl) {
  graphExerciseEl.addEventListener("change", updateRmChart);
}

/* ===== WOD ===== */
function saveTreinos() {
  localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));
}

function calcCarga(entry) {
  const peso = entry.peso || 0;
  const reps = entry.reps || 0;
  const rondas = entry.rondas || 1;
  return peso * reps * rondas;
}

function addTreinoEntry() {
  const date = treinoDataEl.value || new Date().toISOString().slice(0,10);
  const ex = treinoExEl.value;
  const tipo = treinoTipoEl.value;
  const rondas = parseInt(treinoRondasEl.value || "1", 10);
  const reps = parseInt(treinoRepsEl.value || "0", 10);
  const peso = parseFloat(treinoPesoEl.value || "0");
  const tempo = treinoTempoEl.value.trim();
  const distKmVal = parseFloat(treinoDistEl.value || "0");

  if (!ex || !reps || reps <= 0) return;

  const carga = calcCarga({ peso, reps, rondas });
  let perc1rm = null;
  if (dataRm[ex] && dataRm[ex] > 0 && peso > 0) {
    perc1rm = peso / dataRm[ex];
  }

  const entry = {
    date,
    ex,
    tipo,
    rondas,
    reps,
    peso,
    tempo,
    carga,
    perc1rm,
    distanciaKm: (!isNaN(distKmVal) && distKmVal > 0) ? distKmVal : 0
  };

  treinos.unshift(entry);
  saveTreinos();
  registerBackupMeta("WOD registado");
  renderTreinos();
}

function deleteTreinoEntry(index) {
  if (index < 0 || index >= treinos.length) return;
  if (!confirm("Apagar este registo de WOD?")) return;
  treinos.splice(index, 1);
  saveTreinos();
  registerBackupMeta("WOD removido");
  renderTreinos();
}

function renderDailyHistory() {
  if (!dailyHistoryBody) return;
  dailyHistoryBody.innerHTML = "";

  if (!treinos.length) return;

  const sorted = treinos.slice().sort((a, b) => {
    return (b.date || "").localeCompare(a.date || "");
  });

  sorted.forEach(t => {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = t.date || "";
    tr.appendChild(tdDate);

    const tdEx = document.createElement("td");
    const label = MOVES_PT[t.ex] ? `${t.ex} ‚Äì ${MOVES_PT[t.ex]}` : t.ex;
    tdEx.textContent = label || "";
    tr.appendChild(tdEx);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = t.tipo || "";
    tr.appendChild(tdTipo);

    const tdR = document.createElement("td");
    tdR.textContent = t.rondas || "";
    tr.appendChild(tdR);

    const tdReps = document.createElement("td");
    tdReps.textContent = t.reps || "";
    tr.appendChild(tdReps);

    const tdPeso = document.createElement("td");
    tdPeso.textContent = t.peso ? formatKg(t.peso) : "";
    tr.appendChild(tdPeso);

    const tdPerc = document.createElement("td");
    if (t.perc1rm) {
      tdPerc.textContent = (t.perc1rm * 100).toFixed(0) + "%";
    } else {
      tdPerc.textContent = "";
    }
    tr.appendChild(tdPerc);

    const tdTempo = document.createElement("td");
    tdTempo.textContent = t.tempo || "";
    tr.appendChild(tdTempo);

    const tdDist = document.createElement("td");
    tdDist.textContent = t.distanciaKm ? formatKm(t.distanciaKm) : "";
    tr.appendChild(tdDist);

    const tdCarga = document.createElement("td");
    tdCarga.textContent = t.carga ? formatKg(t.carga) : "";
    tr.appendChild(tdCarga);

    const tdDel = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üóë";
    btn.className = "btn-delete";
    btn.addEventListener("click", () => {
      deleteTreinoEntry(treinos.indexOf(t));
    });
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);

    dailyHistoryBody.appendChild(tr);
  });
}

function buildSugestao(lista, totalCarga, totalSeries, blocosForca, blocosHipertrofia, blocosLeve, dia) {
  let partes = [];

  if (totalSeries === 0 || totalCarga === 0) {
    return "Hoje o treino ficou muito leve. Se o objetivo √© ganhar for√ßa e m√∫sculo, planeia pelo menos 2‚Äì3 blocos de trabalho com carga moderada a alta.";
  }

  partes.push("Bom trabalho hoje, treino conclu√≠do em " + dia + "!");

  const idade = profile && profile.idade ? profile.idade : null;
  const sexo = profile && profile.sexo ? profile.sexo : null;
  const peso = profile && profile.peso ? profile.peso : null;
  const altura = profile && profile.altura ? profile.altura : null;

  if (blocosForca === 0 && blocosHipertrofia === 0) {
    partes.push("O dia ficou mais leve em termos de est√≠mulo de for√ßa e hipertrofia.");
    partes.push("Para evoluir, tenta incluir 2‚Äì3 exerc√≠cios principais entre 70‚Äì85% do teu 1RM, com 5‚Äì10 repeti√ß√µes.");
  } else if (blocosForca > 0 && blocosHipertrofia === 0) {
    partes.push("Treino muito focado em for√ßa m√°xima, com s√©ries pesadas e repeti√ß√µes baixas.");
    partes.push("Para aumentar tamb√©m a massa muscular, acrescenta 2‚Äì4 s√©ries de 6‚Äì10 repeti√ß√µes a 65‚Äì75% do 1RM em 1‚Äì2 exerc√≠cios grandes.");
  } else if (blocosHipertrofia > 0 && blocosForca === 0) {
    partes.push("Treino consistente para hipertrofia, com bastante trabalho de volume.");
    partes.push("Para refor√ßar a for√ßa, vale a pena incluir 2‚Äì3 s√©ries pesadas (3‚Äì5 repeti√ß√µes a 80‚Äì85% do 1RM) em movimentos fundamentais.");
  } else {
    partes.push("Boa combina√ß√£o de for√ßa e hipertrofia hoje.");
    partes.push("Mant√©m a l√≥gica de 2‚Äì3 exerc√≠cios principais mais pesados (3‚Äì5 reps a 80‚Äì85% do 1RM) e 2‚Äì3 exerc√≠cios de apoio com 6‚Äì12 reps a 65‚Äì75% do 1RM.");
  }

  if (sexo === "homem") {
    partes.push("Como homem, toleras bem blocos pesados entre 80‚Äì85% do 1RM, desde que respeites a t√©cnica e a recupera√ß√£o.");
  } else if (sexo === "mulher") {
    partes.push("Como mulher, costumas recuperar melhor entre s√©ries; n√£o tenhas receio de trabalhar com 8‚Äì12 repeti√ß√µes a 70‚Äì75% do 1RM nos grandes movimentos.");
  }

  if (idade && idade >= 40) {
    partes.push("Com a idade atual, √© importante controlar o volume: d√° prioridade √† qualidade do movimento e garante 48‚Äì72 horas de recupera√ß√£o entre dias muito pesados.");
  }

  if (peso) {
    const cargaMediaPorSerie = totalCarga / Math.max(totalSeries, 1);
    const rel = cargaMediaPorSerie / peso;

    if (rel < 0.8) {
      partes.push("A carga m√©dia por s√©rie ficou relativamente baixa face ao teu peso corporal; aos poucos podes aproximar os principais levantamentos de 1.0‚Äì1.5x do teu peso.");
    } else if (rel >= 0.8 && rel <= 1.5) {
      partes.push("A rela√ß√£o entre carga m√©dia por s√©rie e peso corporal est√° numa faixa interessante para progresso cont√≠nuo. Mant√©m esta consist√™ncia.");
    } else if (rel > 1.5) {
      partes.push("Est√°s a trabalhar com uma carga m√©dia por s√©rie alta relativamente ao teu peso corporal; mant√©m aten√ß√£o √† t√©cnica e √† recupera√ß√£o para evitar excesso de fadiga.");
    }
  }

  if (altura) {
    if (altura >= 185) {
      partes.push("Com a tua estatura, d√° aten√ß√£o extra √† posi√ß√£o lombar em agachamentos e deadlifts, mantendo o core firme em todas as repeti√ß√µes.");
    } else if (altura <= 165) {
      partes.push("Com a tua estatura, tens vantagem para estabilizar cargas pesadas; usa isso para consolidar t√©cnica s√≥lida nos b√°sicos antes de aumentar muito o volume.");
    }
  }

  return partes.join(" ");
}

function getMonday(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return null;
  const day = d.getDay();
  const diff = (day + 6) % 7;
  d.setDate(d.getDate() - diff);
  d.setHours(0, 0, 0, 0);
  return d;
}

function renderWeeklyHistory() {
  if (!weeklyHistoryEl) return;

  if (!treinos.length) {
    weeklyHistoryEl.textContent = "Ainda n√£o h√° hist√≥rico semanal registado.";
    return;
  }

  const semanas = {};
  treinos.forEach(t => {
    if (!t.date) return;
    const mon = getMonday(t.date);
    if (!mon) return;
    const key = mon.toISOString().slice(0,10);
    if (!semanas[key]) semanas[key] = { carga: 0, dist: 0 };
    semanas[key].carga += t.carga || 0;
    if (t.distanciaKm) semanas[key].dist += t.distanciaKm;
  });

  const keys = Object.keys(semanas).sort((a, b) => b.localeCompare(a));

  if (!keys.length) {
    weeklyHistoryEl.textContent = "Ainda n√£o h√° hist√≥rico semanal registado.";
    return;
  }

  const fmt = (d) => {
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    return dd + "/" + mm;
  };

  const lines = keys.slice(0, 4).map(k => {
    const mon = new Date(k);
    const sun = new Date(mon);
    sun.setDate(mon.getDate() + 6);
    const txtCarga = formatKg(semanas[k].carga);
    const txtDist = semanas[k].dist > 0 ? " ¬∑ " + formatKm(semanas[k].dist) : "";
    return fmt(mon) + " ‚Äì " + fmt(sun) + ": " + txtCarga + txtDist;
  });

  weeklyHistoryEl.innerHTML =
    "Hist√≥rico das √∫ltimas semanas (carga total e dist√¢ncia):<br>" +
    lines.join("<br>");
}

function renderTreinos() {
  if (!treinoBody) return;
  treinoBody.innerHTML = "";

  const dia = treinoDataEl.value || new Date().toISOString().slice(0,10);
  const lista = treinos.filter(t => t.date === dia);

  if (!lista.length) {
    if (treinoResumoEl) {
      treinoResumoEl.textContent = "Sem WOD registado para " + dia + ".";
    }
    if (treinoSugestaoEl) treinoSugestaoEl.textContent = "";
    renderWeeklyHistory();
    renderDailyHistory();
    renderPerformance();
    atualizarRankingsMensais();
    return;
  }

  let totalCarga = 0;
  let totalSeries = 0;
  let totalDistKm = 0;
  let blocosForca = 0;
  let blocosHipertrofia = 0;
  let blocosLeve = 0;

  lista.forEach(e => {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = e.date || "";
    tr.appendChild(tdDate);

    const tdEx = document.createElement("td");
    const label = MOVES_PT[e.ex] ? `${e.ex} ‚Äì ${MOVES_PT[e.ex]}` : e.ex;
    tdEx.textContent = label || "";
    tr.appendChild(tdEx);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = e.tipo || "";
    tr.appendChild(tdTipo);

    const tdR = document.createElement("td");
    tdR.textContent = e.rondas || "";
    tr.appendChild(tdR);

    const tdReps = document.createElement("td");
    tdReps.textContent = e.reps || "";
    tr.appendChild(tdReps);

    const tdPeso = document.createElement("td");
    tdPeso.textContent = e.peso ? formatKg(e.peso) : "";
    tr.appendChild(tdPeso);

    const tdPerc = document.createElement("td");
    if (e.perc1rm) {
      tdPerc.textContent = (e.perc1rm * 100).toFixed(0) + "%";
    } else {
      tdPerc.textContent = "";
    }
    tr.appendChild(tdPerc);

    const tdTempo = document.createElement("td");
    tdTempo.textContent = e.tempo || "";
    tr.appendChild(tdTempo);

    const tdDist = document.createElement("td");
    tdDist.textContent = e.distanciaKm ? formatKm(e.distanciaKm) : "";
    tr.appendChild(tdDist);

    const tdCarga = document.createElement("td");
    tdCarga.textContent = e.carga ? formatKg(e.carga) : "";
    tr.appendChild(tdCarga);

    const tdDel = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üóë";
    btn.className = "btn-delete";
    btn.addEventListener("click", () => deleteTreinoEntry(treinos.indexOf(e)));
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);

    treinoBody.appendChild(tr);

    totalCarga += e.carga || 0;
    totalSeries += (e.rondas || 0);
    totalDistKm += e.distanciaKm || 0;

    if (e.perc1rm && e.reps) {
      const p = e.perc1rm;
      const r = e.reps;
      if (p >= 0.8 && r <= 5) {
        blocosForca++;
      } else if (p >= 0.65 && p <= 0.8 && r >= 6 && r <= 12) {
        blocosHipertrofia++;
      } else if (p < 0.6 || r >= 15) {
        blocosLeve++;
      }
    }
  });

  if (treinoResumoEl) {
    let resumo =
      "Resumo do dia " + dia + ": carga total do WOD = " + formatKg(totalCarga);
    if (totalDistKm > 0) {
      resumo += " ¬∑ dist√¢ncia total = " + formatKm(totalDistKm);
    }
    treinoResumoEl.textContent = resumo;
  }

  const sugestao = buildSugestao(
    lista,
    totalCarga,
    totalSeries,
    blocosForca,
    blocosHipertrofia,
    blocosLeve,
    dia
  );
  if (treinoSugestaoEl) treinoSugestaoEl.textContent = sugestao;

  renderWeeklyHistory();
  renderDailyHistory();
  renderPerformance();
  atualizarRankingsMensais();
}

if (treinoAddBtn) {
  treinoAddBtn.addEventListener("click", addTreinoEntry);
}
if (treinoDataEl) {
  treinoDataEl.addEventListener("change", renderTreinos);
}
if (toggleDailyHistoryBtn && dailyHistorySection) {
  toggleDailyHistoryBtn.addEventListener("click", () => {
    const visible = dailyHistorySection.style.display === "block";
    dailyHistorySection.style.display = visible ? "none" : "block";
    if (!visible) {
      renderDailyHistory();
    }
  });
}

/* ===== BACKUP ===== */
function formatDateTime(dt) {
  const d = new Date(dt);
  if (isNaN(d.getTime())) return "";
  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2, "0");
  const mi = String(d.getMinutes()).padStart(2, "0");
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}

function registerBackupMeta(evento) {
  try {
    const meta = JSON.parse(localStorage.getItem(STORAGE_BACKUP_META) || "{}");
    meta.lastChange = new Date().toISOString();
    meta.lastEvent = evento || "";
    localStorage.setItem(STORAGE_BACKUP_META, JSON.stringify(meta));
    updateBackupInfo();
  } catch (e) {}
}

function updateBackupInfo() {
  if (!backupInfoEl) return;
  const meta = JSON.parse(localStorage.getItem(STORAGE_BACKUP_META) || "{}");
  const lastBackup = meta.lastBackup ? formatDateTime(meta.lastBackup) : "nunca";
  const lastChange = meta.lastChange ? formatDateTime(meta.lastChange) : "sem registo";
  backupInfoEl.innerHTML =
    `<div class="helper-text">
       √öltimo backup exportado: <strong>${lastBackup}</strong><br>
       √öltima altera√ß√£o de dados: <strong>${lastChange}</strong>
     </div>`;
}

function buildBackupObject() {
  return {
    version: 2,
    createdAt: new Date().toISOString(),
    profile: profile || {},
    dataRm: dataRm || {},
    rmHistory: rmHistory || {},
    treinos: treinos || [],
    reservas: reservas || [],
    presencas: presencas || [],
    rankingsMensais: rankingsMensais || []
  };
}

function downloadJson(obj, filename) {
  const dataStr = "data:application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(obj));
  const a = document.createElement("a");
  a.setAttribute("href", dataStr);
  a.setAttribute("download", filename);
  document.body.appendChild(a);
  a.click();
  a.remove();
}

if (exportBackupBtn) {
  exportBackupBtn.addEventListener("click", () => {
    const backup = buildBackupObject();
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const dd = String(now.getDate()).padStart(2, "0");
    const filename = `crossfit_backup_${yyyy}${mm}${dd}.json`;
    downloadJson(backup, filename);

    try {
      const meta = JSON.parse(localStorage.getItem(STORAGE_BACKUP_META) || "{}");
      meta.lastBackup = new Date().toISOString();
      localStorage.setItem(STORAGE_BACKUP_META, JSON.stringify(meta));
    } catch (e) {}
    updateBackupInfo();
    alert("Backup exportado. Podes agora guardar o ficheiro em Google Drive, iCloud, Ficheiros, etc.");
  });
}

if (importBackupBtn && backupFileInput) {
  importBackupBtn.addEventListener("click", () => {
    backupFileInput.value = "";
    backupFileInput.click();
  });

  backupFileInput.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        const content = evt.target.result;
        const data = JSON.parse(content);

        if (!data || typeof data !== "object") {
          alert("Ficheiro inv√°lido.");
          return;
        }

        if (!("dataRm" in data) && !("treinos" in data)) {
          alert("Este ficheiro n√£o parece ser um backup v√°lido da app.");
          return;
        }

        profile = data.profile || {};
        dataRm = data.dataRm || {};
        rmHistory = data.rmHistory || {};
        treinos = data.treinos || [];
        reservas = data.reservas || [];
        presencas = data.presencas || [];
        rankingsMensais = data.rankingsMensais || [];

        localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
        localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
        localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory));
        localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));
        localStorage.setItem(STORAGE_RESERVAS, JSON.stringify(reservas));
        localStorage.setItem(STORAGE_PRESENCAS, JSON.stringify(presencas));
        localStorage.setItem(STORAGE_RANKINGS, JSON.stringify(rankingsMensais));

        registerBackupMeta("Backup importado");

        loadProfile();
        renderRm();
        refreshCalcExOptions();
        refreshGraphExerciseOptions();
        renderTreinos();
        renderReservas();

        alert("Backup importado com sucesso.");
      } catch (err) {
        console.error(err);
        alert("Erro ao ler o ficheiro de backup.");
      }
    };
    reader.readAsText(file);
  });
}

/* GUIA EXERC√çCIOS */
function renderGuiaExercicios() {
  if (!guiaBody) return;
  guiaBody.innerHTML = "";

  const filtro = (guiaSearch?.value || "").toLowerCase().trim();

  EXER_INFO.forEach(ex => {
    const texto = (ex.en + " " + ex.pt + " " + ex.descricao).toLowerCase();
    if (filtro && !texto.includes(filtro)) return;

    const tr = document.createElement("tr");

    const tdEn = document.createElement("td");
    tdEn.textContent = ex.en;
    tr.appendChild(tdEn);

    const tdPt = document.createElement("td");
    tdPt.textContent = ex.pt;
    tr.appendChild(tdPt);

    const tdDesc = document.createElement("td");
    tdDesc.textContent = ex.descricao;
    tr.appendChild(tdDesc);

    guiaBody.appendChild(tr);
  });
}

if (guiaSearch) {
  guiaSearch.addEventListener("input", renderGuiaExercicios);
}

/* ===== PERFORMANCE (WOD / 1RM / METCON) ===== */
function parseTimeToSeconds(str) {
  if (!str) return null;
  const clean = String(str).trim();
  const parts = clean.split(":");
  if (parts.length < 2 || parts.length > 3) return null;

  const nums = parts.map(p => parseInt(p, 10));
  if (nums.some(n => isNaN(n))) return null;

  let h = 0, m = 0, s = 0;
  if (nums.length === 2) {
    m = nums[0];
    s = nums[1];
  } else {
    h = nums[0];
    m = nums[1];
    s = nums[2];
  }

  if (m < 0 || s < 0 || s >= 60) return null;
  return h * 3600 + m * 60 + s;
}

function formatSecondsToTime(totalSeconds) {
  if (totalSeconds == null || isNaN(totalSeconds)) return "";
  const t = Math.round(totalSeconds);
  const h = Math.floor(t / 3600);
  const m = Math.floor((t % 3600) / 60);
  const s = t % 60;
  const mm = String(m).padStart(2, "0");
  const ss = String(s).padStart(2, "0");
  if (h > 0) {
    return `${h}:${mm}:${ss}`;
  }
  return `${m}:${ss}`;
}

function renderPerformance() {
  /* WOD ‚Äì dias com mais carga */
  if (perfWodBody) {
    perfWodBody.innerHTML = "";
    if (!treinos.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.textContent = "Ainda n√£o existem WOD registados.";
      tr.appendChild(td);
      perfWodBody.appendChild(tr);
    } else {
      const map = {};
      treinos.forEach(t => {
        if (!t.date) return;
        if (!map[t.date]) {
          map[t.date] = {
            cargaTotal: 0,
            distTotalKm: 0,
            numEx: 0,
            melhorTempoMetconSeg: null
          };
        }
        map[t.date].cargaTotal += t.carga || 0;
        map[t.date].distTotalKm += t.distanciaKm || 0;
        map[t.date].numEx += 1;

        if (t.tipo === "metcon" && t.tempo) {
          const sec = parseTimeToSeconds(t.tempo);
          if (sec != null) {
            if (map[t.date].melhorTempoMetconSeg == null || sec < map[t.date].melhorTempoMetconSeg) {
              map[t.date].melhorTempoMetconSeg = sec;
            }
          }
        }
      });

      const rows = Object.keys(map).map(date => ({
        date,
        cargaTotal: map[date].cargaTotal,
        distTotalKm: map[date].distTotalKm,
        numEx: map[date].numEx,
        melhorTempoMetconSeg: map[date].melhorTempoMetconSeg
      }));

      rows.sort((a, b) => (b.cargaTotal || 0) - (a.cargaTotal || 0));

      rows.slice(0, 10).forEach(r => {
        const tr = document.createElement("tr");

        const tdData = document.createElement("td");
        tdData.textContent = r.date;
        tr.appendChild(tdData);

        const tdCarga = document.createElement("td");
        tdCarga.textContent = formatKg(r.cargaTotal);
        tr.appendChild(tdCarga);

        const tdDist = document.createElement("td");
        tdDist.textContent = r.distTotalKm ? formatKm(r.distTotalKm) : "-";
        tr.appendChild(tdDist);

        const tdNum = document.createElement("td");
        tdNum.textContent = r.numEx.toString();
        tr.appendChild(tdNum);

        const tdTempo = document.createElement("td");
        tdTempo.textContent = r.melhorTempoMetconSeg != null
          ? formatSecondsToTime(r.melhorTempoMetconSeg)
          : "-";
        tr.appendChild(tdTempo);

        perfWodBody.appendChild(tr);
      });

      if (!perfWodBody.hasChildNodes()) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.textContent = "Sem dados suficientes para gerar ranking.";
        tr.appendChild(td);
        perfWodBody.appendChild(tr);
      }
    }
  }

  /* Top 1RM */
  if (perf1rmBody) {
    perf1rmBody.innerHTML = "";
    const nomes = Object.keys(dataRm || {});
    if (!nomes.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 3;
      td.textContent = "Ainda n√£o registaste nenhum 1RM.";
      tr.appendChild(td);
      perf1rmBody.appendChild(tr);
    } else {
      const pesoCorporal = profile && profile.peso ? profile.peso : null;
      const rows = nomes.map(name => ({
        name,
        value: dataRm[name]
      })).sort((a, b) => (b.value || 0) - (a.value || 0));

      rows.slice(0, 10).forEach(r => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        const label = MOVES_PT[r.name] ? `${r.name} ‚Äì ${MOVES_PT[r.name]}` : r.name;
        tdName.textContent = label;
        tr.appendChild(tdName);

        const tdVal = document.createElement("td");
        tdVal.textContent = formatKg(r.value);
        tr.appendChild(tdVal);

        const tdRel = document.createElement("td");
        if (pesoCorporal) {
          const rel = r.value / pesoCorporal;
          tdRel.textContent = rel.toFixed(2) + "x";
        } else {
          tdRel.textContent = "-";
        }
        tr.appendChild(tdRel);

        perf1rmBody.appendChild(tr);
      });
    }
  }

  /* Metcon ‚Äì melhores tempos (tipo = 'metcon') */
  if (perfMetconBody) {
    perfMetconBody.innerHTML = "";
    const metconMap = {};

    treinos.forEach(t => {
      if (t.tipo !== "metcon" || !t.tempo) return;
      const sec = parseTimeToSeconds(t.tempo);
      if (sec == null) return;
      const key = t.ex || "Metcon";
      const existing = metconMap[key];
      if (!existing || sec < existing.tempoSeg) {
        metconMap[key] = {
          exercicio: key,
          tempoSeg: sec,
          tempoStr: t.tempo,
          date: t.date || "",
          carga: t.carga || 0,
          distanciaKm: t.distanciaKm || 0
        };
      }
    });

    const rows = Object.keys(metconMap).map(k => metconMap[k]).sort((a, b) => a.tempoSeg - b.tempoSeg);

    if (!rows.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 4;
      td.textContent = "Ainda n√£o registaste metcons com tempo em formato mm:ss.";
      tr.appendChild(td);
      perfMetconBody.appendChild(tr);
    } else {
      rows.slice(0, 10).forEach(r => {
        const tr = document.createElement("tr");

        const tdEx = document.createElement("td");
        const label = MOVES_PT[r.exercicio] ? `${r.exercicio} ‚Äì ${MOVES_PT[r.exercicio]}` : r.exercicio;
        tdEx.textContent = label;
        tr.appendChild(tdEx);

        const tdTempo = document.createElement("td");
        tdTempo.textContent = r.tempoStr;
        tr.appendChild(tdTempo);

        const tdData = document.createElement("td");
        tdData.textContent = r.date;
        tr.appendChild(tdData);

        const tdCarga = document.createElement("td");
        let cargaLabel = "-";
        if (r.distanciaKm && r.distanciaKm > 0) {
          cargaLabel = formatKm(r.distanciaKm);
        } else if (r.carga && r.carga > 0) {
          cargaLabel = formatKg(r.carga);
        }
        tdCarga.textContent = cargaLabel;
        tr.appendChild(tdCarga);

        perfMetconBody.appendChild(tr);
      });
    }
  }
}

/* ===== RESERVAS & PRESEN√áAS (ALUNO) ===== */

/* Garantir que as estruturas s√£o sempre arrays v√°lidas */
if (!Array.isArray(reservas)) reservas = [];
if (!Array.isArray(presencas)) presencas = [];
if (!Array.isArray(rankingsMensais)) rankingsMensais = [];

function saveReservas() {
  try {
    localStorage.setItem(STORAGE_RESERVAS, JSON.stringify(reservas));
  } catch (e) {
    console.error("Erro ao guardar reservas:", e);
    alert("N√£o foi poss√≠vel guardar a reserva (erro de armazenamento do navegador).");
  }
}

function savePresencas() {
  try {
    localStorage.setItem(STORAGE_PRESENCAS, JSON.stringify(presencas));
  } catch (e) {
    console.error("Erro ao guardar presen√ßas:", e);
  }
}

function saveRankings() {
  try {
    localStorage.setItem(STORAGE_RANKINGS, JSON.stringify(rankingsMensais));
  } catch (e) {
    console.error("Erro ao guardar rankings mensais:", e);
  }
}

function gerarIdReserva() {
  return "res_" + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
}

function marcarPresenca(reservaId) {
  const existe = presencas.some(p => p.reservaId === reservaId);
  if (existe) return;
  const now = new Date();
  presencas.push({
    reservaId,
    data: now.toISOString().slice(0, 10),
    hora: now.toTimeString().slice(0,5)
  });
  savePresencas();
  renderReservas();
  atualizarRankingsMensais();
}

function apagarReserva(id) {
  if (!confirm("Apagar esta reserva?")) return;
  reservas = reservas.filter(r => r.id !== id);
  presencas = presencas.filter(p => p.reservaId !== id);
  saveReservas();
  savePresencas();
  renderReservas();
  atualizarRankingsMensais();
}

function adicionarReserva() {
  try {
    const hojeISO = new Date().toISOString().slice(0,10);

    const data = (reservaDataEl && reservaDataEl.value) ? reservaDataEl.value : hojeISO;
    const hora = reservaHoraEl ? reservaHoraEl.value : "";
    const tipo = reservaTipoEl ? reservaTipoEl.value : "";
    const nota = reservaNotaEl ? reservaNotaEl.value.trim() : "";

    if (!data || !hora || !tipo) {
      alert("Preenche pelo menos data, hora e tipo de aula.");
      return;
    }

    const novaReserva = {
      id: gerarIdReserva(),
      data,
      hora,
      tipo,
      nota,
      inscritos: profile && profile.nome ? [profile.nome] : []
    };

    if (!Array.isArray(reservas)) reservas = [];
    reservas.unshift(novaReserva);

    saveReservas();
    if (reservaNotaEl) reservaNotaEl.value = "";
    registerBackupMeta("Reserva registada");
    renderReservas();
    atualizarRankingsMensais();

    console.log("Reserva adicionada:", novaReserva);
  } catch (e) {
    console.error("Erro ao adicionar reserva:", e);
    alert("Ocorreu um erro ao guardar a reserva. Verifica a consola do navegador para mais detalhes.");
  }
}

function mesmoMesAno(dataISO, ano, mes) {
  const d = new Date(dataISO);
  if (isNaN(d.getTime())) return false;
  return d.getFullYear() === ano && (d.getMonth() + 1) === mes;
}

function atualizarRankingsMensais() {
  if (!treinos || !treinos.length) {
    rankingsMensais = [];
    saveRankings();
    renderReservasResumo();
    return;
  }

  const agora = new Date();
  const ano = agora.getFullYear();
  const mes = agora.getMonth() + 1;
  const chave = `${ano}-${String(mes).padStart(2,"0")}`;

  let cargaTotal = 0;
  let distTotal = 0;
  let nTreinos = 0;

  treinos.forEach(t => {
    if (!t.date) return;
    if (!mesmoMesAno(t.date, ano, mes)) return;
    nTreinos++;
    cargaTotal += t.carga || 0;
    distTotal += t.distanciaKm || 0;
  });

  const outras = rankingsMensais.filter(r => r.mes !== chave);
  const atual = {
    mes: chave,
    ano,
    mesNumero: mes,
    nTreinos,
    cargaTotal,
    distTotal
  };

  rankingsMensais = [...outras, atual];
  saveRankings();
  renderReservasResumo();
}

function renderReservasResumo() {
  if (!reservasResumoEl) return;
  const agora = new Date();
  const ano = agora.getFullYear();
  const mes = agora.getMonth() + 1;

  const nReservasMes = reservas.filter(r => mesmoMesAno(r.data, ano, mes)).length;
  const nPresencasMes = presencas.filter(p => mesmoMesAno(p.data, ano, mes)).length;

  const chave = `${ano}-${String(mes).padStart(2,"0")}`;
  const rank = rankingsMensais.find(r => r.mes === chave);

  let texto = `Este m√™s: ${nReservasMes} reservas e ${nPresencasMes} presen√ßas registadas.`;

  if (rank && rank.nTreinos > 0) {
    texto += ` Treinos registados em WOD: ${rank.nTreinos} ¬∑ Carga total = ${formatKg(rank.cargaTotal)}.`;
    if (rank.distTotal > 0) {
      texto += ` Dist√¢ncia total = ${formatKm(rank.distTotal)}.`;
    }
  } else {
    texto += " Ainda n√£o h√° dados suficientes de WOD para resumo mensal.";
  }

  reservasResumoEl.textContent = texto;
}

function renderReservas() {
  if (!reservasBody) return;
  reservasBody.innerHTML = "";

  if (!reservas || !reservas.length) {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 6;
    td.textContent = "Sem reservas registadas.";
    tr.appendChild(td);
    reservasBody.appendChild(tr);
    renderReservasResumo();
    return;
  }

  reservas.forEach(r => {
    const tr = document.createElement("tr");

    const tdData = document.createElement("td");
    tdData.textContent = r.data || "";
    tr.appendChild(tdData);

    const tdHora = document.createElement("td");
    tdHora.textContent = r.hora || "";
    tr.appendChild(tdHora);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = r.tipo || "";
    tr.appendChild(tdTipo);

    const tdNota = document.createElement("td");
    tdNota.textContent = r.nota || "";
    tr.appendChild(tdNota);

    const tdPres = document.createElement("td");
    const temPresenca = presencas.some(p => p.reservaId === r.id);
    if (temPresenca) {
      tdPres.textContent = "Presente ‚úÖ";
    } else {
      const btnPres = document.createElement("button");
      btnPres.className = "btn-secondary";
      btnPres.style.padding = "4px 8px";
      btnPres.style.fontSize = "0.7rem";
      btnPres.textContent = "Marcar presen√ßa";
      btnPres.addEventListener("click", () => marcarPresenca(r.id));
      tdPres.appendChild(btnPres);
    }
    tr.appendChild(tdPres);

    const tdDel = document.createElement("td");
    const btnDel = document.createElement("button");
    btnDel.className = "btn-delete";
    btnDel.textContent = "üóë";
    btnDel.addEventListener("click", () => apagarReserva(r.id));
    tdDel.appendChild(btnDel);
    tr.appendChild(tdDel);

    reservasBody.appendChild(tr);
  });

  renderReservasResumo();
}

/* LIGAR BOT√ÉO GUARDAR RESERVA */
if (reservaAddBtn) {
  reservaAddBtn.addEventListener("click", adicionarReserva);
}

/* TABS PRINCIPAIS */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const target = btn.dataset.target;
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(target).classList.add("active");
  });
});

/* OP√á√ïES (sub-se√ß√µes) */
document.querySelectorAll(".opt-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const target = btn.dataset.target;

    document.querySelectorAll(".option-section").forEach(s => {
      s.classList.remove("active");
    });

    const sec = document.getElementById(target);
    if (sec && sec.classList.contains("option-section")) {
      sec.classList.add("active");
    }
  });
});

/* BOT√ÉO RESERVAS ‚Äì (se existir no futuro no ecr√£ principal) */
if (reservasBtn && reservasSection) {
  reservasBtn.addEventListener("click", () => {
    const visivel = reservasSection.style.display === "block";
    reservasSection.style.display = visivel ? "none" : "block";
  });
}

/* INIT */
initSelects();
loadProfile();
renderRm();
refreshCalcExOptions();
refreshGraphExerciseOptions();

if (treinoDataEl && !treinoDataEl.value) {
  treinoDataEl.value = new Date().toISOString().slice(0, 10);
}
renderTreinos();
updateBackupInfo();
renderGuiaExercicios();
renderPerformance();
renderReservas();
atualizarRankingsMensais();

if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    navigator.serviceWorker.register("service-worker.js");
  });
}
</script>

</body>
</html>



