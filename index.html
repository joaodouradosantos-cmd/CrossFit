<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cross Moita ‚Äì 1RM & Di√°rio</title>

  <!-- Cor da barra de topo nos telem√≥veis -->
  <meta name="theme-color" content="#f2f2f2" />
  <link rel="manifest" href="manifest.json" />

  <style>
    :root {
      font-family: system-ui, sans-serif;
      color-scheme: light;
    }

    /* === FUNDO CLARO (CINZA SUAVE) === */
    body {
      margin: 0;
      background: #f2f2f2;   /* cinza muito claro */
      color: #111111;        /* texto escuro */
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 900px;
      padding: 16px;
      box-sizing: border-box;
    }

    header {
      text-align: center;
      margin-bottom: 16px;
    }

    #appLogo {
      max-width: 220px;
      height: auto;
      display: block;
      margin: 0 auto 6px auto;
    }

    h1 {
      margin: 0;
      font-size: 1.6rem;
      color: #111;
    }

    .subtitle {
      font-size: 0.85rem;
      color: #555;
    }

    /* === TABS === */
    .tabs {
      display: flex;
      gap: 8px;
      margin: 14px 0;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid #cccccc;
      background: #e5e5e5;
      color: #222;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .tab-btn.active {
      background: #22c55e;
      border-color: #22c55e;
      color: #ffffff;
      font-weight: 600;
    }

    /* === CARDS === */
    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 16px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .field {
      flex: 1;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.8rem;
      color: #444;
    }

    input, select, textarea, button {
      padding: 10px;
      border-radius: 10px;
      background: #ffffff;
      color: #111;
      border: 1px solid #cccccc;
      font-size: 0.9rem;
      box-sizing: border-box;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.2);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 140px;
    }

    .btn-primary {
      background: #22c55e;
      border-color: #22c55e;
      color: #ffffff;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-danger {
      background: #b91c1c;
      border-color: #991b1b;
      color: #ffffff;
      font-weight: 600;
      cursor: pointer;
      margin-left: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      color: #111;
    }

    th, td {
      padding: 6px;
      text-align: center;
      border-bottom: 1px solid #dddddd;
      white-space: nowrap;
    }

    th {
      background: #f9f9f9;
      color: #333;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .scroll {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #e5e5e5;
    }

    .section { display: none; }
    .section.active { display: block; }

    /* Bot√£o de apagar nas tabelas (1RM e Di√°rio) */
    .btn-delete {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e5e5e5;
      background: #f97373;
      color: #ffffff;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .btn-delete:hover {
      background: #ef4444;
    }

    .helper-text {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #444;
    }
  </style>
</head>

<body>
<div class="app">

  <header>
    <img id="appLogo" src="imagens/crossmoita_logo.png" alt="Cross Moita Logo">
    <div class="subtitle">Registo pessoal de treinos</div>
  </header>

  <!-- RESUMO -->
  <section class="card" id="resumo">
    <div class="helper-text"><strong>Resumo</strong></div>
    <div id="resumoPr" class="helper-text"></div>
    <div id="resumoTreinos" class="helper-text"></div>
  </section>

  <!-- PERFIL -->
  <section class="card" id="perfil">
    <div class="form-row">
      <div class="field">
        <label>Sexo</label>
        <select id="sexo">
          <option value="">Selecionar</option>
          <option value="homem">Homem</option>
          <option value="mulher">Mulher</option>
        </select>
      </div>
      <div class="field">
        <label>Idade</label>
        <input id="idade" type="number" min="10" max="100" />
      </div>
    </div>

    <div class="form-row">
      <div class="field">
        <label>Altura (cm)</label>
        <input id="altura" type="number" min="100" max="230" />
      </div>
      <div class="field">
        <label>Peso (kg)</label>
        <input id="peso" type="number" step="0.1" min="30" max="250" />
      </div>
    </div>

    <button class="btn-primary" id="saveProfile">Guardar perfil</button>
    <div class="helper-text" id="profileInfo"></div>
  </section>

  <div class="tabs">
    <button class="tab-btn active" data-target="sec-1rm">1RM</button>
    <button class="tab-btn" data-target="sec-cargas">Cargas</button>
    <button class="tab-btn" data-target="sec-diario">Di√°rio</button>
  </div>

  <!-- 1RM -->
  <section id="sec-1rm" class="section active">

    <div class="card">
      <div class="form-row">
        <div class="field">
          <label>Exerc√≠cio</label>
          <select id="exercise"></select>
        </div>

        <div class="field">
          <label>1RM (kg) ‚Äì peso m√°ximo numa repeti√ß√£o</label>
          <input id="oneRm" type="number" step="0.5" />
        </div>
      </div>

      <button class="btn-primary" id="addBtn">Guardar / Atualizar</button>
    </div>

    <div class="card">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Exerc√≠cio</th>
              <th>1RM</th>
              <th>50%</th>
              <th>60%</th>
              <th>70%</th>
              <th>75%</th>
              <th>80%</th>
              <th>85%</th>
              <th>90%</th>
              <th>95%</th>
              <th></th> <!-- coluna do bot√£o apagar -->
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="helper-text">Hist√≥rico de 1RM (√∫ltimos registos)</div>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Exerc√≠cio</th>
              <th>1RM</th>
              <th>Origem</th>
              <th>PR</th>
            </tr>
          </thead>
          <tbody id="rmLogBody"></tbody>
        </table>
      </div>
    </div>

  </section>

  <!-- CARGAS -->
  <section id="sec-cargas" class="section">
    <div class="card">
      <div class="field">
        <label>Exerc√≠cio (com 1RM registado)</label>
        <select id="loadExercise"></select>
      </div>

      <div class="scroll" style="margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Reps</th>
              <th>% 1RM</th>
              <th>Carga sugerida</th>
            </tr>
          </thead>
          <tbody id="loadBody"></tbody>
        </table>
      </div>

      <div class="helper-text">
        <div id="strengthZone"></div>
        <div id="hypertrophyZone" style="margin-top:4px;"></div>
        <small>Valores aproximados. Ajusta conforme t√©cnica e sensa√ß√£o de esfor√ßo.</small>
      </div>
    </div>

    <div class="card">
      <div class="form-row">
        <div class="field">
          <label>Exerc√≠cio para estimar 1RM</label>
          <select id="calcExercise"></select>
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Carga (kg)</label>
          <input id="calcPeso" type="number" step="0.5" />
        </div>
        <div class="field">
          <label>Repeti√ß√µes</label>
          <input id="calcReps" type="number" min="1" max="20" />
        </div>
      </div>

      <div style="margin-top:8px;">
        <button class="btn-primary" id="btnCalc1RM">Calcular 1RM estimado</button>
        <button class="btn-danger" id="btnApply1RM">Guardar como 1RM do exerc√≠cio</button>
      </div>

      <div class="helper-text" id="calc1rmResultado"></div>
    </div>
  </section>

  <!-- DI√ÅRIO -->
  <section id="sec-diario" class="section">

    <div class="card">
      <div class="form-row">
        <div class="field">
          <label>Data</label>
          <input id="date" type="date">
        </div>

        <div class="field">
          <label>WOD</label>
          <input id="wod" type="text" placeholder="Ex.: Cindy, EMOM 10‚Äô...">
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Tipo</label>
          <input id="tipo" type="text" placeholder="For√ßa, Metcon, Skill...">
        </div>

        <div class="field">
          <label>Resultado</label>
          <input id="resultado" type="text" placeholder="Ex.: 10 rondas, 120 kg, 12:35...">
        </div>
      </div>

      <div class="field">
        <label>Notas</label>
        <textarea id="notas" placeholder="Sensa√ß√µes, ajustes, t√©cnica, etc."></textarea>
      </div>

      <div style="margin-top:8px;">
        <button class="btn-primary" id="saveDiary">Guardar</button>
      </div>

    </div>

    <div class="card">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>WOD</th>
              <th>Tipo</th>
              <th>Resultado</th>
              <th>Notas</th>
              <th></th> <!-- lixo por linha -->
            </tr>
          </thead>
          <tbody id="diaryBody"></tbody>
        </table>
      </div>
    </div>

  </section>

</div>

<script>
/* ===== PERFIL ===== */
const STORAGE_PROFILE = "crossfit_profile";
let profile = JSON.parse(localStorage.getItem(STORAGE_PROFILE) || "{}");

const sexoEl = document.getElementById("sexo");
const idadeEl = document.getElementById("idade");
const alturaEl = document.getElementById("altura");
const pesoEl = document.getElementById("peso");
const profileInfo = document.getElementById("profileInfo");

function updateProfileInfo() {
  if (!profileInfo) return;
  if (!profile || !profile.peso) {
    profileInfo.textContent = "Preenche o perfil para calcular for√ßa relativa (1RM em fun√ß√£o do peso corporal).";
    return;
  }
  let txt = "Peso atual: " + profile.peso + " kg";
  if (profile.idade) txt += " ¬∑ Idade: " + profile.idade + " anos";
  if (profile.sexo) {
    const sx = profile.sexo === "homem" ? "Homem" : "Mulher";
    txt += " ¬∑ Sexo: " + sx;
  }
  profileInfo.textContent = txt;
}

function loadProfile() {
  if (!sexoEl) return;
  if (profile.sexo) sexoEl.value = profile.sexo;
  if (profile.idade) idadeEl.value = profile.idade;
  if (profile.altura) alturaEl.value = profile.altura;
  if (profile.peso) pesoEl.value = profile.peso;
  updateProfileInfo();
}

const saveProfileBtn = document.getElementById("saveProfile");
if (saveProfileBtn) {
  saveProfileBtn.addEventListener("click", () => {
    profile = {
      sexo: sexoEl.value || "",
      idade: idadeEl.value ? parseInt(idadeEl.value, 10) : "",
      altura: alturaEl.value ? parseInt(alturaEl.value, 10) : "",
      peso: pesoEl.value ? parseFloat(pesoEl.value) : ""
    };
    localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
    updateProfileInfo();
    alert("Perfil atualizado.");
  });
}

/* ===== 1RM ===== */
const MOVES = [
  "Chest Press",
  "Back Squat",
  "Front Squat",
  "Overhead Squat",
  "Deadlift",
  "Sumo Deadlift",
  "Romanian Deadlift (RDL)",
  "Power Clean",
  "Squat Clean",
  "Clean & Jerk",
  "Power Snatch",
  "Squat Snatch",
  "Push Press",
  "Push Jerk",
  "Split Jerk",
  "Strict Press",
  "Thruster",
  "Barbell Row",
  "Bent Over Row",
  "Good Morning",
  "Lunges com barra",
  "Hip Thrust com barra",
  "Dumbbell Press",
  "Dumbbell Bench Press",
  "Dumbbell Snatch",
  "Dumbbell Clean",
  "Dumbbell Clean & Jerk",
  "Dumbbell Thruster",
  "Dumbbell Row",
  "Dumbbell Lunges",
  "Kettlebell Swing",
  "Kettlebell Clean",
  "Kettlebell Snatch",
  "Goblet Squat",
  "Kettlebell Lunges"
];

const PERC = [0.5,0.6,0.7,0.75,0.8,0.85,0.9,0.95];
const STORAGE_RM = "crossfit_1rm";
let dataRm = JSON.parse(localStorage.getItem(STORAGE_RM) || "{}");

/* Hist√≥rico de 1RM */
const STORAGE_RM_LOG = "crossfit_1rm_log";
let rmLog = JSON.parse(localStorage.getItem(STORAGE_RM_LOG) || "[]");
const rmLogBody = document.getElementById("rmLogBody");

const sel = document.getElementById("exercise");
const rm = document.getElementById("oneRm");
const bodyTable = document.getElementById("tableBody");

/* ==== CARGAS ==== */
const REP_SCHEMES = [
  { reps: 1,  perc: 1.00 },
  { reps: 2,  perc: 0.96 },
  { reps: 3,  perc: 0.93 },
  { reps: 4,  perc: 0.90 },
  { reps: 5,  perc: 0.87 },
  { reps: 6,  perc: 0.85 },
  { reps: 8,  perc: 0.80 },
  { reps: 10, perc: 0.75 },
  { reps: 12, perc: 0.70 }
];

const loadSel = document.getElementById("loadExercise");
const loadBody = document.getElementById("loadBody");
const strengthZone = document.getElementById("strengthZone");
const hypertrophyZone = document.getElementById("hypertrophyZone");

/* Calculadora de 1RM estimado */
const calcExSel = document.getElementById("calcExercise");
const calcPesoEl = document.getElementById("calcPeso");
const calcRepsEl = document.getElementById("calcReps");
const calcResEl = document.getElementById("calc1rmResultado");
const btnCalc1RM = document.getElementById("btnCalc1RM");
const btnApply1RM = document.getElementById("btnApply1RM");

let lastEst1RM = null; // guarda √∫ltima estimativa para poder aplicar

/* RESUMO DOM */
const resumoPrEl = document.getElementById("resumoPr");
const resumoTreinosEl = document.getElementById("resumoTreinos");

/* preencher select com exerc√≠cios (1RM e base) */
function initSelect() {
  sel.innerHTML = "";
  MOVES.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    sel.appendChild(opt);
  });
}

/* formatar kg com uma casa decimal */
function formatKg(v) {
  return v.toFixed(1).replace(".", ",") + " kg";
}

/* ---- Hist√≥rico de 1RM ---- */
function saveRmLog() {
  localStorage.setItem(STORAGE_RM_LOG, JSON.stringify(rmLog));
}

function addRmLog(ex, val, source) {
  const entry = {
    ex,
    val,
    source, // "manual" ou "estimado"
    date: new Date().toISOString().slice(0, 10)
  };
  rmLog.unshift(entry);
  if (rmLog.length > 100) rmLog.length = 100; // limite de 100 entradas
  saveRmLog();
  renderRmLog();
  updateResumo();
}

function renderRmLog() {
  if (!rmLogBody) return;
  rmLogBody.innerHTML = "";
  if (!rmLog.length) return;

  // calcular PR por exerc√≠cio
  const maxByEx = {};
  rmLog.forEach(e => {
    if (!maxByEx[e.ex] || e.val > maxByEx[e.ex]) {
      maxByEx[e.ex] = e.val;
    }
  });

  rmLog.slice(0, 20).forEach(e => {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = e.date || "";
    tr.appendChild(tdDate);

    const tdEx = document.createElement("td");
    tdEx.textContent = e.ex;
    tr.appendChild(tdEx);

    const tdVal = document.createElement("td");
    tdVal.textContent = formatKg(e.val);
    tr.appendChild(tdVal);

    const tdSrc = document.createElement("td");
    tdSrc.textContent = e.source === "estimado" ? "Estimado" : "Direto";
    tr.appendChild(tdSrc);

    const tdPr = document.createElement("td");
    tdPr.textContent = (e.val >= maxByEx[e.ex] - 0.0001) ? "PR" : "";
    tr.appendChild(tdPr);

    rmLogBody.appendChild(tr);
  });
}

/* apagar um exerc√≠cio espec√≠fico */
function deleteEx(name) {
  if (!name) return;
  if (confirm(`Apagar o exerc√≠cio "${name}"?`)) {
    delete dataRm[name];
    localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
    renderRm();
    updateLoadSelect();
    updateResumo();
  }
}

/* desenhar tabela 1RM */
function renderRm() {
  bodyTable.innerHTML = "";
  Object.keys(dataRm).sort().forEach(name => {
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.textContent = name;
    tr.appendChild(tdName);

    const td1rm = document.createElement("td");
    let oneRmText = formatKg(dataRm[name]);
    if (profile && profile.peso) {
      const rel = dataRm[name] / profile.peso;
      oneRmText += " (" + rel.toFixed(2) + "x peso corporal)";
    }
    td1rm.textContent = oneRmText;
    tr.appendChild(td1rm);

    PERC.forEach(p => {
      const td = document.createElement("td");
      td.textContent = formatKg(dataRm[name] * p);
      tr.appendChild(td);
    });

    const tdDelete = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üóë";
    btn.className = "btn-delete";
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      deleteEx(name);
    });
    tdDelete.appendChild(btn);
    tr.appendChild(tdDelete);

    bodyTable.appendChild(tr);
  });

  updateLoadSelect();
}

/* guardar / actualizar 1RM (manual) */
document.getElementById("addBtn").addEventListener("click", () => {
  const ex = sel.value;
  const val = parseFloat(rm.value);
  if (!ex || !val || val <= 0) return;
  dataRm[ex] = val;
  localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
  addRmLog(ex, val, "manual");
  rm.value = "";
  renderRm();
});

/* ===== CARGAS (a partir do 1RM) ===== */
function updateLoadSelect() {
  const names = Object.keys(dataRm).sort();

  if (loadSel) {
    loadSel.innerHTML = "";
    if (!names.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Regista primeiro o 1RM na aba 1RM";
      loadSel.appendChild(opt);
    } else {
      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        loadSel.appendChild(opt);
      });
    }
  }

  if (calcExSel) {
    calcExSel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = names.length ? "Escolher exerc√≠cio (opcional)" : "Sem 1RM registado ainda";
    calcExSel.appendChild(opt0);

    names.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      calcExSel.appendChild(opt);
    });
  }

  if (loadSel && names.length) {
    renderLoadTable(loadSel.value);
  } else {
    renderLoadTable(null);
  }
}

function renderLoadTable(exName) {
  loadBody.innerHTML = "";
  strengthZone.textContent = "";
  hypertrophyZone.textContent = "";

  if (!exName || !dataRm[exName]) return;

  const oneRmVal = dataRm[exName];

  REP_SCHEMES.forEach(row => {
    const tr = document.createElement("tr");

    const tdReps = document.createElement("td");
    tdReps.textContent = row.reps + " reps";
    tr.appendChild(tdReps);

    const tdPerc = document.createElement("td");
    tdPerc.textContent = (row.perc * 100).toFixed(0) + "%";
    tr.appendChild(tdPerc);

    const tdCarga = document.createElement("td");
    tdCarga.textContent = formatKg(oneRmVal * row.perc);
    tr.appendChild(tdCarga);

    loadBody.appendChild(tr);
  });

  const stLow  = formatKg(oneRmVal * 0.80);
  const stHigh = formatKg(oneRmVal * 0.90);
  const hypLow  = formatKg(oneRmVal * 0.70);
  const hypHigh = formatKg(oneRmVal * 0.80);

  strengthZone.textContent =
    `For√ßa (3‚Äì5 reps): ~80‚Äì90% 1RM ‚Üí ${stLow} ‚Äì ${stHigh}`;
  hypertrophyZone.textContent =
    `Hipertrofia (6‚Äì12 reps): ~70‚Äì80% 1RM ‚Üí ${hypLow} ‚Äì ${hypHigh}`;
}

if (loadSel) {
  loadSel.addEventListener("change", () => {
    renderLoadTable(loadSel.value);
  });
}

/* ===== Calculadora de 1RM estimado (Epley) ===== */
if (btnCalc1RM) {
  btnCalc1RM.addEventListener("click", () => {
    const peso = parseFloat(calcPesoEl.value);
    const reps = parseInt(calcRepsEl.value, 10);

    if (!peso || peso <= 0 || !reps || reps <= 0) {
      calcResEl.textContent = "Introduz uma carga e n√∫mero de repeti√ß√µes v√°lidos.";
      lastEst1RM = null;
      return;
    }

    // F√≥rmula de Epley: 1RM ‚âà peso √ó (1 + reps / 30)
    const est1rm = peso * (1 + reps / 30);
    let txt = "1RM estimado: " + formatKg(est1rm);

    if (profile && profile.peso) {
      const rel = est1rm / profile.peso;
      txt += " (" + rel.toFixed(2) + "x peso corporal)";
    }

    const exName = calcExSel.value || "";
    if (exName) {
      txt += " ¬∑ Exerc√≠cio selecionado: " + exName;
    } else {
      txt += " ¬∑ (Podes escolher um exerc√≠cio e gravar este valor como 1RM.)";
    }

    calcResEl.textContent = txt;
    lastEst1RM = { value: est1rm, exercise: exName || null };
  });
}

if (btnApply1RM) {
  btnApply1RM.addEventListener("click", () => {
    let exName = calcExSel.value || "";
    if (!exName) {
      alert("Escolhe um exerc√≠cio para guardar o 1RM estimado.");
      return;
    }

    let estVal = null;
    if (lastEst1RM && (lastEst1RM.exercise === exName || lastEst1RM.exercise === null)) {
      estVal = lastEst1RM.value;
    } else {
      const peso = parseFloat(calcPesoEl.value);
      const reps = parseInt(calcRepsEl.value, 10);
      if (!peso || peso <= 0 || !reps || reps <= 0) {
        alert("Introduz carga e repeti√ß√µes v√°lidos para calcular o 1RM.";
        return;
      }
      estVal = peso * (1 + reps / 30);
    }

    if (!confirm(`Guardar ${estVal.toFixed(1)} kg como novo 1RM para "${exName}"?`)) {
      return;
    }

    dataRm[exName] = estVal;
    localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
    addRmLog(exName, estVal, "estimado");
    renderRm();
    calcResEl.textContent = "Novo 1RM guardado para " + exName + ": " + formatKg(estVal);
  });
}

/* ===== DI√ÅRIO ===== */
const STORAGE_DIARY = "crossfit_diary";
let diary = JSON.parse(localStorage.getItem(STORAGE_DIARY) || "[]");

const dateEl = document.getElementById("date");
const wodEl = document.getElementById("wod");
const tipoEl = document.getElementById("tipo");
const resEl = document.getElementById("resultado");
const notasEl = document.getElementById("notas");
const diaryBody = document.getElementById("diaryBody");

function renderDiary() {
  diaryBody.innerHTML = "";
  diary.forEach((d, index) => {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = d.date || "";
    tr.appendChild(tdDate);

    const tdWod = document.createElement("td");
    tdWod.textContent = d.wod || "";
    tr.appendChild(tdWod);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = d.tipo || "";
    tr.appendChild(tdTipo);

    const tdRes = document.createElement("td");
    tdRes.textContent = d.resultado || "";
    tr.appendChild(tdRes);

    const tdNotas = document.createElement("td");
    tdNotas.textContent = d.notas || "";
    tr.appendChild(tdNotas);

    const tdDelete = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üóë";
    btn.className = "btn-delete";
    btn.addEventListener("click", () => deleteDiary(index));
    tdDelete.appendChild(btn);
    tr.appendChild(tdDelete);

    diaryBody.appendChild(tr);
  });

  updateResumo();
}

function deleteDiary(index) {
  if (index < 0 || index >= diary.length) return;
  if (!confirm("Apagar este registo do di√°rio?")) return;
  diary.splice(index, 1);
  localStorage.setItem(STORAGE_DIARY, JSON.stringify(diary));
  renderDiary();
}

/* guardar registo no di√°rio */
document.getElementById("saveDiary").addEventListener("click", () => {
  const entry = {
    date: dateEl.value || "",
    wod: wodEl.value.trim(),
    tipo: tipoEl.value.trim(),
    resultado: resEl.value.trim(),
    notas: notasEl.value.trim()
  };

  if (!entry.date && !entry.wod && !entry.resultado && !entry.notas) return;

  diary.unshift(entry);
  localStorage.setItem(STORAGE_DIARY, JSON.stringify(diary));
  renderDiary();

  wodEl.value = "";
  tipoEl.value = "";
  resEl.value = "";
  notasEl.value = "";
});

/* ===== RESUMO (PR + treinos) ===== */
function updateResumo() {
  if (!resumoPrEl || !resumoTreinosEl) return;

  // --- PRs ---
  if (!rmLog.length && !Object.keys(dataRm).length) {
    resumoPrEl.textContent = "Ainda n√£o tens PR registados.";
  } else {
    // usar rmLog se existir, sen√£o dataRm
    let maxByEx = {};
    if (rmLog.length) {
      rmLog.forEach(e => {
        if (!maxByEx[e.ex] || e.val > maxByEx[e.ex]) {
          maxByEx[e.ex] = e.val;
        }
      });
    } else {
      Object.keys(dataRm).forEach(ex => {
        maxByEx[ex] = dataRm[ex];
      });
    }

    const lista = Object.entries(maxByEx)
      .map(([ex, val]) => ({ ex, val }))
      .sort((a, b) => b.val - a.val)
      .slice(0, 3);

    if (!lista.length) {
      resumoPrEl.textContent = "Ainda n√£o tens PR registados.";
    } else {
      const parts = lista.map((item, idx) =>
        (idx + 1) + ") " + item.ex + " ‚Äì " + formatKg(item.val)
      );
      resumoPrEl.textContent = "Top PR de for√ßa: " + parts.join(" ¬∑ ");
    }
  }

  // --- Treinos ---
  if (!diary.length) {
    resumoTreinosEl.textContent = "Ainda n√£o tens treinos registados no di√°rio.";
  } else {
    const total = diary.length;
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth();
    let mesCount = 0;

    diary.forEach(d => {
      if (!d.date) return;
      const dt = new Date(d.date);
      if (!isNaN(dt) && dt.getFullYear() === y && dt.getMonth() === m) {
        mesCount++;
      }
    });

    resumoTreinosEl.textContent =
      "Treinos registados: " + total + " no total (" + mesCount + " este m√™s).";
  }
}

/* ===== TABS ===== */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const target = btn.dataset.target;
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(target).classList.add("active");
  });
});

/* INIT */
initSelect();
loadProfile();
renderRm();
renderRmLog();
renderDiary();
updateLoadSelect();
updateResumo();

/* preenche data de hoje por defeito */
if (!dateEl.value) {
  dateEl.value = new Date().toISOString().slice(0, 10);
}
</script>

</body>
</html>
