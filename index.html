<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cross Moita ‚Äì 1RM</title>

  <!-- Cor da barra de topo nos telem√≥veis -->
  <meta name="theme-color" content="#f2f2f2" />
  <link rel="manifest" href="manifest.json" />

  <!-- √çcone para iPhone (Apple Touch Icon) -->
  <link rel="apple-touch-icon" sizes="180x180" href="imagens/crossmoita_logo.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Chart.js para o gr√°fico de 1RM -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      font-family: system-ui, sans-serif;
      color-scheme: light;
    }

    /* FUNDO CLARO */
    body {
      /* Gradiente vertical: mais claro em cima, mais escuro em baixo */
  background: linear-gradient(
    to bottom,
    #ececec 40%,
    #e0e0e0 70%,
    #d4d4d4 100%
  );
  color: #111111;
  display: flex;
  justify-content: center;
  min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 900px;
      padding: 16px;
      box-sizing: border-box;
    }

    header {
      text-align: center;
      margin-bottom: 12px;
    }

    #appLogo {
      max-width: 220px;
      height: auto;
      display: block;
      margin: 0 auto 6px auto;
    }

    .subtitle {
      font-size: 0.85rem;
      color: #555;
    }

    /* CARDS */
    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 16px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .field {
      flex: 1;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.8rem;
      color: #444;
    }

    input, select, textarea, button {
      padding: 10px;
      border-radius: 10px;
      background: #ffffff;
      color: #111;
      border: 1px solid #cccccc;
      font-size: 0.9rem;
      box-sizing: border-box;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.2);
    }

    .btn-primary {
      background: #22c55e;
      border-color: #22c55e;
      color: #ffffff;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-danger {
      background: #b91c1c;
      border-color: #991b1b;
      color: #ffffff;
      font-weight: 600;
      cursor: pointer;
      margin-left: 8px;
    }

    .btn-secondary {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #cccccc;
      background: #e5e5e5;
      color: #222;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-secondary:active {
      transform: scale(0.97);
    }

    /* TABS */
    .tabs {
      display: flex;
      gap: 8px;
      margin: 10px 0 14px 0;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid #cccccc;
      background: #e5e5e5;
      color: #222;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .tab-btn.active {
      background: #22c55e;
      border-color: #22c55e;
      color: #ffffff;
      font-weight: 600;
    }

    .section { display: none; }
    .section.active { display: block; }

    /* TABELAS */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      color: #111;
    }

    th, td {
      padding: 6px;
      text-align: center;
      border-bottom: 1px solid #dddddd;
      white-space: nowrap;
    }

    th {
      background: #f9f9f9;
      color: #333;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .scroll {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #e5e5e5;
    }

    /* BOT√ÉO APAGAR */
    .btn-delete {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e5e5e5;
      background: #f97373;
      color: #ffffff;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .btn-delete:hover {
      background: #ef4444;
    }

    .helper-text {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #444;
    }

    /* Linha de perfil + bot√£o Editar */
    #profileInfoWrapper {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #444;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    #profileInfo {
      flex: 1;
    }

    .btn-edit-profile {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #cccccc;
      background: #e5e5e5;
      color: #222;
      font-size: 0.7rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-edit-profile:active {
      transform: scale(0.97);
    }
  </style>
</head>

<body>
<div class="app">

  <header>
    <img id="appLogo" src="imagens/crossmoita_logo.png" alt="Cross Moita Logo">
    <div class="subtitle">Registo pessoal de treinos de for√ßa</div>
  </header>

  <!-- PERFIL -->
  <section class="card" id="perfil">
    <div id="perfilForm">
      <div class="form-row">
        <div class="field">
          <label>Sexo</label>
          <select id="sexo">
            <option value="">Selecionar</option>
            <option value="homem">Homem</option>
            <option value="mulher">Mulher</option>
          </select>
        </div>
        <div class="field">
          <label>Idade</label>
          <input id="idade" type="number" min="10" max="100" />
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Altura (cm)</label>
          <input id="altura" type="number" min="100" max="230" />
        </div>
        <div class="field">
          <label>Peso (kg)</label>
          <input id="peso" type="number" step="0.1" min="30" max="250" />
        </div>
      </div>

      <button class="btn-primary" id="saveProfile">Guardar perfil</button>
    </div>

    <!-- Linha de resumo do perfil + bot√£o EDITAR -->
    <div id="profileInfoWrapper">
      <span id="profileInfo"></span>
      <button id="editProfileBtn" class="btn-edit-profile">Editar</button>
    </div>
  </section>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" data-target="sec-1rm">1RM</button>
    <button class="tab-btn" data-target="sec-treino">WOD</button>
  </div>

  <!-- 1RM -->
  <section id="sec-1rm" class="section active">

    <div class="card">
      <div class="form-row">
        <div class="field">
          <label>Exerc√≠cio</label>
          <select id="exercise"></select>
        </div>

        <div class="field">
          <label>1RM (kg) ‚Äì peso m√°ximo numa repeti√ß√£o</label>
          <input id="oneRm" type="number" step="0.5" />
        </div>
      </div>

      <button class="btn-primary" id="addBtn">Guardar / Atualizar</button>
    </div>

    <div class="card">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Exerc√≠cio</th>
              <th>1RM</th>
              <th>25%</th>
              <th>30%</th>
              <th>35%</th>
              <th>40%</th>
              <th>50%</th>
              <th>60%</th>
              <th>70%</th>
              <th>75%</th>
              <th>80%</th>
              <th>85%</th>
              <th>90%</th>
              <th>95%</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- CART√ÉO: CARGA SUGERIDA + GR√ÅFICO -->
    <div class="card">
      <div class="form-row" style="margin-bottom:8px; gap:8px;">
        <button class="btn-secondary" id="toggleCalc">Carga sugerida</button>
        <button class="btn-secondary" id="toggleGraph">Gr√°fico</button>
      </div>

      <!-- SE√á√ÉO ESCONDIDA: C√ÅLCULO DE CARGA SUGERIDA -->
      <div id="calcSection" style="display:none;">
        <div class="form-row">
          <div class="field">
            <label>Exerc√≠cio (com 1RM registado)</label>
            <select id="calcExercicio"></select>
          </div>
          <div class="field">
            <label>N.¬∫ de repeti√ß√µes planeadas</label>
            <input id="calcReps" type="number" min="1" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Objetivo</label>
            <select id="calcObjetivo">
              <option value="">Autom√°tico</option>
              <option value="forca">For√ßa</option>
              <option value="hipertrofia">Hipertrofia</option>
              <option value="tecnica">T√©cnica / Volume leve</option>
            </select>
          </div>
        </div>

        <button class="btn-primary" id="calcBtn">Calcular</button>
        <div class="helper-text" id="calcResultado" style="margin-top:6px;">
          Escolhe um exerc√≠cio com 1RM registado, indica o n¬∫ de repeti√ß√µes e, se quiseres, o objetivo (for√ßa / hipertrofia / t√©cnica).
        </div>
      </div>

      <!-- SE√á√ÉO ESCONDIDA: GR√ÅFICO 1RM -->
      <div id="graphSection" style="display:none; margin-top:10px;">
        <div class="field">
          <label>Exerc√≠cio para gr√°fico de 1RM</label>
          <select id="graphExercise"></select>
        </div>
        <div style="margin-top:8px;">
          <canvas id="rmChart" style="width:100%; max-height:240px;"></canvas>
        </div>
      </div>
    </div>

  </section>

  <!-- WOD -->
  <section id="sec-treino" class="section">

    <!-- REGISTO DO WOD DO DIA -->
    <div class="card">
      <div class="form-row">
        <div class="field">
          <label>Data</label>
          <input id="treinoData" type="date">
        </div>
        <div class="field">
          <label>Exerc√≠cio</label>
          <select id="treinoExercicio"></select>
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Tipo</label>
          <select id="treinoTipo">
            <option value="">Selecionar</option>
            <option value="for√ßa">For√ßa</option>
            <option value="hipertrofia">Hipertrofia</option>
            <option value="t√©cnica">T√©cnica</option>
            <option value="metcon">Metcon</option>
          </select>
        </div>
        <div class="field">
          <label>Rondas / S√©ries</label>
          <input id="treinoRondas" type="number" min="1" />
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Repeti√ß√µes por s√©rie</label>
          <input id="treinoReps" type="number" min="1" />
        </div>
        <div class="field">
          <label>Peso (kg)</label>
          <input id="treinoPeso" type="number" step="0.5" min="0" />
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Tempo (opcional)</label>
          <input id="treinoTempo" type="text" placeholder="Ex.: 12:35, 20', AMRAP 10'..." />
        </div>
      </div>

      <button class="btn-primary" id="treinoAdd">Adicionar ao WOD</button>
      <div class="helper-text">
        A carga de cada exerc√≠cio √© calculada como: peso √ó repeti√ß√µes √ó rondas.
      </div>
    </div>

    <!-- TABELA DO WOD, RESUMO, SUGEST√ÉO, HIST√ìRICO SEMANAL + HIST√ìRICO DI√ÅRIO -->
    <div class="card">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Exerc√≠cio</th>
              <th>Tipo</th>
              <th>Rondas</th>
              <th>Reps</th>
              <th>Peso</th>
              <th>% 1RM</th>
              <th>Tempo</th>
              <th>Carga</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="treinoBody"></tbody>
        </table>
      </div>
      <div class="helper-text" id="treinoResumo"></div>
      <div class="helper-text" id="treinoSugestao" style="margin-top:4px; font-weight:500;"></div>
      <div class="helper-text" id="weeklyHistory" style="margin-top:6px;"></div>

      <!-- BOT√ÉO HIST√ìRICO DI√ÅRIO -->
      <button class="btn-secondary" id="toggleDailyHistory" style="margin-top:8px;">
        Hist√≥rico di√°rio
      </button>

      <!-- SEC√á√ÉO ESCONDIDA: HIST√ìRICO DI√ÅRIO COMPLETO -->
      <div id="dailyHistorySection" style="display:none; margin-top:8px;">
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Exerc√≠cio</th>
                <th>Tipo</th>
                <th>Rondas</th>
                <th>Reps</th>
                <th>Peso</th>
                <th>% 1RM</th>
                <th>Tempo</th>
                <th>Carga</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="dailyHistoryBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </section>

</div>

<script>
/* ===== PERFIL ===== */
const STORAGE_PROFILE = "crossfit_profile";
let profile = JSON.parse(localStorage.getItem(STORAGE_PROFILE) || "{}");

const sexoEl = document.getElementById("sexo");
const idadeEl = document.getElementById("idade");
const alturaEl = document.getElementById("altura");
const pesoEl = document.getElementById("peso");
const profileInfo = document.getElementById("profileInfo");
const perfilForm = document.getElementById("perfilForm");
const editProfileBtn = document.getElementById("editProfileBtn");

function updateProfileInfo() {
  if (!profileInfo) return;

  if (!profile || !profile.peso) {
    profileInfo.textContent = "Preenche o perfil para personalizar a an√°lise da tua for√ßa.";
    if (perfilForm) perfilForm.style.display = "block";
    return;
  }

  let txt = "Peso atual: " + profile.peso + " kg";
  if (profile.idade) txt += " ¬∑ Idade: " + profile.idade + " anos";
  if (profile.sexo) {
    const sx = profile.sexo === "homem" ? "Homem" : "Mulher";
    txt += " ¬∑ Sexo: " + sx;
  }
  if (profile.altura) txt += " ¬∑ Altura: " + profile.altura + " cm";

  profileInfo.textContent = txt;

  if (perfilForm) perfilForm.style.display = "none";
}

function loadProfile() {
  if (!sexoEl) return;
  if (profile.sexo) sexoEl.value = profile.sexo;
  if (profile.idade) idadeEl.value = profile.idade;
  if (profile.altura) alturaEl.value = profile.altura;
  if (profile.peso) pesoEl.value = profile.peso;
  updateProfileInfo();
}

const saveProfileBtn = document.getElementById("saveProfile");
if (saveProfileBtn) {
  saveProfileBtn.addEventListener("click", () => {
    profile = {
      sexo: sexoEl.value || "",
      idade: idadeEl.value ? parseInt(idadeEl.value, 10) : "",
      altura: alturaEl.value ? parseInt(alturaEl.value, 10) : "",
      peso: pesoEl.value ? parseFloat(pesoEl.value) : ""
    };
    localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
    updateProfileInfo();
    alert("Perfil atualizado.");
  });
}

/* Bot√£o pequeno "Editar" ao lado da linha de perfil */
if (editProfileBtn) {
  editProfileBtn.addEventListener("click", () => {
    if (perfilForm) {
      perfilForm.style.display = "block";
    }
  });
}

/* ===== 1RM / EXERC√çCIOS ===== */
const MOVES = [
  "Chest Press",
  "Back Squat",
  "Front Squat",
  "Overhead Squat",
  "Deadlift",
  "Sumo Deadlift",
  "Romanian Deadlift (RDL)",
  "Power Clean",
  "Squat Clean",
  "Clean & Jerk",
  "Power Snatch",
  "Squat Snatch",
  "Push Press",
  "Push Jerk",
  "Split Jerk",
  "Strict Press",
  "Thruster",
  "Barbell Row",
  "Bent Over Row",
  "Good Morning",
  "Lunges com barra",
  "Hip Thrust com barra",
  "Dumbbell Press",
  "Dumbbell Bench Press",
  "Dumbbell Snatch",
  "Dumbbell Clean",
  "Dumbbell Clean & Jerk",
  "Dumbbell Thruster",
  "Dumbbell Row",
  "Dumbbell Lunges",
  "Kettlebell Swing",
  "Kettlebell Clean",
  "Kettlebell Snatch",
  "Goblet Squat",
  "Kettlebell Lunges"
];

const PERC = [
  0.25, 0.30, 0.35, 0.40,
  0.50, 0.60, 0.70, 0.75,
  0.80, 0.85, 0.90, 0.95
];

const STORAGE_RM = "crossfit_1rm";
/* hist√≥rico de 1RM para compara√ß√£o e gr√°fico */
const STORAGE_RM_HISTORY = "crossfit_1rm_history";

let dataRm = JSON.parse(localStorage.getItem(STORAGE_RM) || "{}");
let rmHistory = JSON.parse(localStorage.getItem(STORAGE_RM_HISTORY) || "{}");

const sel = document.getElementById("exercise");
const rm = document.getElementById("oneRm");
const bodyTable = document.getElementById("tableBody");

/* M√ìDULO CALCULADORA DE CARGA */
const calcExEl = document.getElementById("calcExercicio");
const calcRepsEl = document.getElementById("calcReps");
const calcObjEl = document.getElementById("calcObjetivo");
const calcResEl = document.getElementById("calcResultado");
const calcBtn = document.getElementById("calcBtn");

/* Bot√µes de toggle das sec√ß√µes */
const toggleCalcBtn = document.getElementById("toggleCalc");
const toggleGraphBtn = document.getElementById("toggleGraph");
const calcSection = document.getElementById("calcSection");
const graphSection = document.getElementById("graphSection");

/* GR√ÅFICO 1RM */
const graphExerciseEl = document.getElementById("graphExercise");
const rmChartCanvas = document.getElementById("rmChart");
let rmChart = null;

/* WOD */
const STORAGE_TREINO = "crossfit_treinos";
let treinos = JSON.parse(localStorage.getItem(STORAGE_TREINO) || "[]");

const treinoDataEl = document.getElementById("treinoData");
const treinoExEl = document.getElementById("treinoExercicio");
const treinoTipoEl = document.getElementById("treinoTipo");
const treinoRondasEl = document.getElementById("treinoRondas");
const treinoRepsEl = document.getElementById("treinoReps");
const treinoPesoEl = document.getElementById("treinoPeso");
const treinoTempoEl = document.getElementById("treinoTempo");
const treinoAddBtn = document.getElementById("treinoAdd");
const treinoBody = document.getElementById("treinoBody");
const treinoResumoEl = document.getElementById("treinoResumo");
const treinoSugestaoEl = document.getElementById("treinoSugestao");
const weeklyHistoryEl = document.getElementById("weeklyHistory");

/* Hist√≥rico di√°rio DOM */
const toggleDailyHistoryBtn = document.getElementById("toggleDailyHistory");
const dailyHistorySection = document.getElementById("dailyHistorySection");
const dailyHistoryBody = document.getElementById("dailyHistoryBody");

/* Helpers */
function initSelect() {
  if (sel) {
    sel.innerHTML = "";
    MOVES.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      sel.appendChild(opt);
    });
  }

  if (treinoExEl) {
    treinoExEl.innerHTML = "";
    MOVES.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      treinoExEl.appendChild(opt);
    });
  }
}

/* atualizar lista da calculadora (s√≥ exerc√≠cios com 1RM) */
function refreshCalcExOptions() {
  if (!calcExEl) return;
  calcExEl.innerHTML = "";

  const names = Object.keys(dataRm).sort();
  if (!names.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Nenhum 1RM registado";
    calcExEl.appendChild(opt);
    calcExEl.disabled = true;
    return;
  }

  calcExEl.disabled = false;
  names.forEach(n => {
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    calcExEl.appendChild(opt);
  });
}

/* atualizar lista para o gr√°fico */
function refreshGraphExerciseOptions() {
  if (!graphExerciseEl) return;
  const allNames = new Set([
    ...Object.keys(dataRm || {}),
    ...Object.keys(rmHistory || {})
  ]);
  const names = Array.from(allNames).sort();

  graphExerciseEl.innerHTML = "";
  if (!names.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Sem dados de 1RM";
    graphExerciseEl.appendChild(opt);
    graphExerciseEl.disabled = true;
    updateRmChart();
    return;
  }

  graphExerciseEl.disabled = false;
  names.forEach(n => {
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    graphExerciseEl.appendChild(opt);
  });

  updateRmChart();
}

function formatKg(v) {
  return v.toFixed(1).replace(".", ",") + " kg";
}

/* === Tabela 1RM === */
function deleteEx(name) {
  if (!name) return;
  if (!confirm(`Apagar o exerc√≠cio "${name}"?`)) return;
  delete dataRm[name];
  delete rmHistory[name];
  localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
  localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory));
  renderRm();
}

function renderRm() {
  bodyTable.innerHTML = "";
  Object.keys(dataRm).sort().forEach(name => {
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.textContent = name;
    tr.appendChild(tdName);

    const td1rm = document.createElement("td");
    let oneRmText = formatKg(dataRm[name]);

    if (profile && profile.peso) {
      const rel = dataRm[name] / profile.peso;
      oneRmText += " (" + rel.toFixed(2) + "x peso corporal)";
    }

    /* compara√ß√£o com 1RM anterior */
    const histList = rmHistory[name] || [];
    if (histList.length) {
      const prev = histList[histList.length - 1];
      const prevVal = prev.value;
      const diff = dataRm[name] - prevVal;
      if (Math.abs(diff) >= 0.5) {
        const seta = diff > 0 ? "‚Üë" : "‚Üì";
        const diffAbs = Math.abs(diff).toFixed(1).replace(".", ",");
        oneRmText += ` ¬∑ ${seta} ${diffAbs} kg vs anterior`;
      }
    }

    td1rm.textContent = oneRmText;
    tr.appendChild(td1rm);

    PERC.forEach(p => {
      const td = document.createElement("td");
      td.textContent = formatKg(dataRm[name] * p);
      tr.appendChild(td);
    });

    const tdDelete = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üóë";
    btn.className = "btn-delete";
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      deleteEx(name);
    });
    tdDelete.appendChild(btn);
    tr.appendChild(tdDelete);

    bodyTable.appendChild(tr);
  });

  refreshCalcExOptions();
  refreshGraphExerciseOptions();
}

/* Guardar / atualizar 1RM manual (com hist√≥rico) */
document.getElementById("addBtn").addEventListener("click", () => {
  const ex = sel.value;
  const val = parseFloat(rm.value);
  if (!ex || !val || val <= 0) return;

  const old = dataRm[ex];

  if (typeof old === "number" && !isNaN(old) && old !== val) {
    if (!rmHistory[ex]) rmHistory[ex] = [];
    rmHistory[ex].push({
      date: new Date().toISOString().slice(0, 10),
      value: old
    });
  }

  dataRm[ex] = val;
  localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
  localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory));

  rm.value = "";
  renderRm();
});

/* === CALCULADORA DE CARGA SUGERIDA === */
function getPercentRange(reps, objetivo) {
  let minP, maxP;

  if (objetivo === "forca") {
    if (reps <= 2) { minP = 0.9; maxP = 0.98; }
    else if (reps <= 3) { minP = 0.88; maxP = 0.95; }
    else if (reps <= 5) { minP = 0.80; maxP = 0.90; }
    else { minP = 0.75; maxP = 0.85; }
  } else if (objetivo === "hipertrofia") {
    if (reps <= 5) { minP = 0.75; maxP = 0.85; }
    else if (reps <= 8) { minP = 0.70; maxP = 0.80; }
    else if (reps <= 12) { minP = 0.65; maxP = 0.75; }
    else { minP = 0.55; maxP = 0.70; }
  } else if (objetivo === "tecnica") {
    if (reps <= 5) { minP = 0.50; maxP = 0.65; }
    else if (reps <= 10) { minP = 0.45; maxP = 0.60; }
    else { minP = 0.40; maxP = 0.55; }
  } else {
    if (reps === 1) { minP = 0.9; maxP = 1.0; }
    else if (reps <= 3) { minP = 0.85; maxP = 0.95; }
    else if (reps <= 5) { minP = 0.80; maxP = 0.90; }
    else if (reps <= 8) { minP = 0.70; maxP = 0.80; }
    else if (reps <= 12) { minP = 0.65; maxP = 0.75; }
    else { minP = 0.50; maxP = 0.65; }
  }

  return { minP, maxP };
}

if (calcBtn) {
  calcBtn.addEventListener("click", () => {
    if (!calcExEl || !calcRepsEl || !calcResEl) return;

    const ex = calcExEl.value;
    const reps = parseInt(calcRepsEl.value || "0", 10);
    const obj = calcObjEl ? calcObjEl.value : "";

    if (!ex || !dataRm[ex]) {
      calcResEl.textContent = "Escolhe um exerc√≠cio com 1RM registado.";
      return;
    }
    if (!reps || reps <= 0) {
      calcResEl.textContent = "Indica o n√∫mero de repeti√ß√µes.";
      return;
    }

    const oneRmVal = dataRm[ex];
    const { minP, maxP } = getPercentRange(reps, obj);
    const minLoad = oneRmVal * minP;
    const maxLoad = oneRmVal * maxP;

    let objetivoTexto = "autom√°tico";
    if (obj === "forca") objetivoTexto = "for√ßa";
    if (obj === "hipertrofia") objetivoTexto = "hipertrofia";
    if (obj === "tecnica") objetivoTexto = "t√©cnica / volume leve";

    calcResEl.textContent =
      `Para ${reps} repeti√ß√µes em ${ex}, com objetivo ${objetivoTexto}, ` +
      `a carga sugerida √© entre ${(minP*100).toFixed(0)}% e ${(maxP*100).toFixed(0)}% do 1RM: ` +
      `${formatKg(minLoad)} ‚Äì ${formatKg(maxLoad)}. Ajusta ligeiramente para bater certo com os discos que tens.`;
  });
}

/* === TOGGLE DAS SEC√á√ïES CARGA / GR√ÅFICO === */
if (toggleCalcBtn && calcSection) {
  toggleCalcBtn.addEventListener("click", () => {
    const visible = calcSection.style.display === "block";
    calcSection.style.display = visible ? "none" : "block";
  });
}

if (toggleGraphBtn && graphSection) {
  toggleGraphBtn.addEventListener("click", () => {
    const visible = graphSection.style.display === "block";
    graphSection.style.display = visible ? "none" : "block";
    if (!visible) {
      refreshGraphExerciseOptions();
    }
  });
}

/* === GR√ÅFICO DE 1RM === */
function updateRmChart() {
  if (!rmChartCanvas || !graphExerciseEl) return;

  const ex = graphExerciseEl.value;
  let labels = [];
  let values = [];

  if (ex && (rmHistory[ex] || dataRm[ex])) {
    const hist = (rmHistory[ex] || []).slice().sort((a, b) => {
      return (a.date || "").localeCompare(b.date || "");
    });

    hist.forEach((entry, idx) => {
      labels.push(entry.date || "h" + (idx + 1));
      values.push(entry.value);
    });

    if (dataRm[ex]) {
      labels.push("Atual");
      values.push(dataRm[ex]);
    }
  }

  const ctx = rmChartCanvas.getContext("2d");

  if (rmChart) {
    rmChart.destroy();
    rmChart = null;
  }

  if (!labels.length) {
    rmChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: ["Sem dados"],
        datasets: [{
          label: "1RM (kg)",
          data: [0],
          tension: 0.25
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { display: false },
          y: { display: false }
        }
      }
    });
    return;
  }

  rmChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: ex + " ‚Äì 1RM (kg)",
        data: values,
        tension: 0.25
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        x: {
          title: { display: true, text: "Registos" }
        },
        y: {
          title: { display: true, text: "Peso (kg)" },
          beginAtZero: false
        }
      }
    }
  });
}

/* === WOD: CARGA E REGISTO === */
function saveTreinos() {
  localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));
}

function calcCarga(entry) {
  const peso = entry.peso || 0;
  const reps = entry.reps || 0;
  const rondas = entry.rondas || 1;
  return peso * reps * rondas;
}

function addTreinoEntry() {
  const date = treinoDataEl.value || new Date().toISOString().slice(0,10);
  const ex = treinoExEl.value;
  const tipo = treinoTipoEl.value;
  const rondas = parseInt(treinoRondasEl.value || "1", 10);
  const reps = parseInt(treinoRepsEl.value || "0", 10);
  const peso = parseFloat(treinoPesoEl.value || "0");
  const tempo = treinoTempoEl.value.trim();

  if (!ex || !reps || reps <= 0) return;

  const carga = calcCarga({ peso, reps, rondas });
  let perc1rm = null;
  if (dataRm[ex] && dataRm[ex] > 0 && peso > 0) {
    perc1rm = peso / dataRm[ex];
  }

  const entry = {
    date,
    ex,
    tipo,
    rondas,
    reps,
    peso,
    tempo,
    carga,
    perc1rm
  };

  treinos.unshift(entry);
  saveTreinos();
  renderTreinos();
}

/* apagar registo espec√≠fico do WOD */
function deleteTreinoEntry(index) {
  if (index < 0 || index >= treinos.length) return;
  if (!confirm("Apagar este registo de WOD?")) return;
  treinos.splice(index, 1);
  saveTreinos();
  renderTreinos();
}

/* === HIST√ìRICO DI√ÅRIO COMPLETO === */
function renderDailyHistory() {
  if (!dailyHistoryBody) return;
  dailyHistoryBody.innerHTML = "";

  if (!treinos.length) {
    return;
  }

  const sorted = treinos.slice().sort((a, b) => {
    return (b.date || "").localeCompare(a.date || "");
  });

  sorted.forEach(t => {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = t.date || "";
    tr.appendChild(tdDate);

    const tdEx = document.createElement("td");
    tdEx.textContent = t.ex || "";
    tr.appendChild(tdEx);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = t.tipo || "";
    tr.appendChild(tdTipo);

    const tdR = document.createElement("td");
    tdR.textContent = t.rondas || "";
    tr.appendChild(tdR);

    const tdReps = document.createElement("td");
    tdReps.textContent = t.reps || "";
    tr.appendChild(tdReps);

    const tdPeso = document.createElement("td");
    tdPeso.textContent = t.peso ? formatKg(t.peso) : "";
    tr.appendChild(tdPeso);

    const tdPerc = document.createElement("td");
    if (t.perc1rm) {
      tdPerc.textContent = (t.perc1rm * 100).toFixed(0) + "%";
    } else {
      tdPerc.textContent = "";
    }
    tr.appendChild(tdPerc);

    const tdTempo = document.createElement("td");
    tdTempo.textContent = t.tempo || "";
    tr.appendChild(tdTempo);

    const tdCarga = document.createElement("td");
    tdCarga.textContent = t.carga ? formatKg(t.carga) : "";
    tr.appendChild(tdCarga);

    const tdDel = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üóë";
    btn.className = "btn-delete";
    btn.addEventListener("click", () => {
      deleteTreinoEntry(treinos.indexOf(t));
    });
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);

    dailyHistoryBody.appendChild(tr);
  });
}

/* === SUGEST√ÉO MOTIVADORA === */
function buildSugestao(lista, totalCarga, totalSeries, blocosForca, blocosHipertrofia, blocosLeve, dia) {
  let partes = [];

  if (totalSeries === 0 || totalCarga === 0) {
    return "Hoje o treino ficou muito leve. Se o objetivo √© ganhar for√ßa e m√∫sculo, planeia pelo menos 2‚Äì3 blocos de trabalho com carga moderada a alta.";
  }

  partes.push("Bom trabalho hoje, treino conclu√≠do em " + dia + "!");

  const idade = profile && profile.idade ? profile.idade : null;
  const sexo = profile && profile.sexo ? profile.sexo : null;
  const peso = profile && profile.peso ? profile.peso : null;
  const altura = profile && profile.altura ? profile.altura : null;

  if (blocosForca === 0 && blocosHipertrofia === 0) {
    partes.push("O dia ficou mais leve em termos de est√≠mulo de for√ßa e hipertrofia.");
    partes.push("Para evoluir, tenta incluir 2‚Äì3 exerc√≠cios principais entre 70‚Äì85% do teu 1RM, com 5‚Äì10 repeti√ß√µes.");
  } else if (blocosForca > 0 && blocosHipertrofia === 0) {
    partes.push("Treino muito focado em for√ßa m√°xima, com s√©ries pesadas e repeti√ß√µes baixas.");
    partes.push("Para aumentar tamb√©m a massa muscular, acrescenta 2‚Äì4 s√©ries de 6‚Äì10 repeti√ß√µes a 65‚Äì75% do 1RM em 1‚Äì2 exerc√≠cios grandes.");
  } else if (blocosHipertrofia > 0 && blocosForca === 0) {
    partes.push("Treino consistente para hipertrofia, com bastante trabalho de volume.");
    partes.push("Para refor√ßar a for√ßa, vale a pena incluir 2‚Äì3 s√©ries pesadas (3‚Äì5 repeti√ß√µes a 80‚Äì85% do 1RM) em movimentos fundamentais.");
  } else {
    partes.push("Boa combina√ß√£o de for√ßa e hipertrofia hoje.");
    partes.push("Mant√©m a l√≥gica de 2‚Äì3 exerc√≠cios principais mais pesados (3‚Äì5 reps a 80‚Äì85% do 1RM) e 2‚Äì3 exerc√≠cios de apoio com 6‚Äì12 reps a 65‚Äì75% do 1RM.");
  }

  if (sexo === "homem") {
    partes.push("Como homem, toleras bem blocos pesados entre 80‚Äì85% do 1RM, desde que respeites a t√©cnica e a recupera√ß√£o.");
  } else if (sexo === "mulher") {
    partes.push("Como mulher, costumas recuperar melhor entre s√©ries; n√£o tenhas receio de trabalhar com 8‚Äì12 repeti√ß√µes a 70‚Äì75% do 1RM nos grandes movimentos.");
  }

  if (idade && idade >= 40) {
    partes.push("Com a idade atual, √© importante controlar o volume: d√° prioridade √† qualidade do movimento e garante 48‚Äì72 horas de recupera√ß√£o entre dias muito pesados.");
  }

  if (peso) {
    const cargaMediaPorSerie = totalCarga / Math.max(totalSeries, 1);
    const rel = cargaMediaPorSerie / peso;

    if (rel < 0.8) {
      partes.push("A carga m√©dia por s√©rie ficou relativamente baixa face ao teu peso corporal; aos poucos podes aproximar os principais levantamentos de 1.0‚Äì1.5x do teu peso.");
    } else if (rel >= 0.8 && rel <= 1.5) {
      partes.push("A rela√ß√£o entre carga m√©dia por s√©rie e peso corporal est√° numa faixa interessante para progresso cont√≠nuo. Mant√©m esta consist√™ncia.");
    } else if (rel > 1.5) {
      partes.push("Est√°s a trabalhar com uma carga m√©dia por s√©rie alta relativamente ao teu peso corporal; mant√©m aten√ß√£o √† t√©cnica e √† recupera√ß√£o para evitar excesso de fadiga.");
    }
  }

  if (altura) {
    if (altura >= 185) {
      partes.push("Com a tua estatura, d√° aten√ß√£o extra √† posi√ß√£o lombar em agachamentos e deadlifts, mantendo o core firme em todas as repeti√ß√µes.");
    } else if (altura <= 165) {
      partes.push("Com a tua estatura, tens vantagem para estabilizar cargas pesadas; usa isso para consolidar t√©cnica s√≥lida nos b√°sicos antes de aumentar muito o volume.");
    }
  }

  return partes.join(" ");
}

/* === HIST√ìRICO SEMANAL === */
function getMonday(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return null;
  const day = d.getDay();
  const diff = (day + 6) % 7;
  d.setDate(d.getDate() - diff);
  d.setHours(0, 0, 0, 0);
  return d;
}

function renderWeeklyHistory() {
  if (!weeklyHistoryEl) return;

  if (!treinos.length) {
    weeklyHistoryEl.textContent = "Ainda n√£o h√° hist√≥rico semanal registado.";
    return;
  }

  const semanas = {};
  treinos.forEach(t => {
    if (!t.date) return;
    const mon = getMonday(t.date);
    if (!mon) return;
    const key = mon.toISOString().slice(0,10);
    if (!semanas[key]) semanas[key] = 0;
    semanas[key] += t.carga || 0;
  });

  const keys = Object.keys(semanas).sort((a, b) => b.localeCompare(a));

  if (!keys.length) {
    weeklyHistoryEl.textContent = "Ainda n√£o h√° hist√≥rico semanal registado.";
    return;
  }

  const fmt = (d) => {
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    return dd + "/" + mm;
  };

  const lines = keys.slice(0, 4).map(k => {
    const mon = new Date(k);
    const sun = new Date(mon);
    sun.setDate(mon.getDate() + 6);
    const txtCarga = formatKg(semanas[k]);
    return fmt(mon) + " ‚Äì " + fmt(sun) + ": " + txtCarga;
  });

  weeklyHistoryEl.innerHTML =
    "Hist√≥rico das √∫ltimas semanas (carga total):<br>" +
    lines.join("<br>");
}

/* === RENDER WOD (DIA ATUAL) === */
function renderTreinos() {
  if (!treinoBody) return;
  treinoBody.innerHTML = "";

  const dia = treinoDataEl.value || new Date().toISOString().slice(0,10);
  const lista = treinos.filter(t => t.date === dia);

  if (!lista.length) {
    treinoResumoEl.textContent = "Sem WOD registado para " + dia + ".";
    treinoSugestaoEl.textContent = "";
    renderWeeklyHistory();
    renderDailyHistory();
    return;
  }

  let totalCarga = 0;
  let totalSeries = 0;
  let blocosForca = 0;
  let blocosHipertrofia = 0;
  let blocosLeve = 0;

  lista.forEach(e => {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = e.date || "";
    tr.appendChild(tdDate);

    const tdEx = document.createElement("td");
    tdEx.textContent = e.ex;
    tr.appendChild(tdEx);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = e.tipo || "";
    tr.appendChild(tdTipo);

    const tdR = document.createElement("td");
    tdR.textContent = e.rondas || "";
    tr.appendChild(tdR);

    const tdReps = document.createElement("td");
    tdReps.textContent = e.reps || "";
    tr.appendChild(tdReps);

    const tdPeso = document.createElement("td");
    tdPeso.textContent = e.peso ? formatKg(e.peso) : "";
    tr.appendChild(tdPeso);

    const tdPerc = document.createElement("td");
    if (e.perc1rm) {
      tdPerc.textContent = (e.perc1rm * 100).toFixed(0) + "%";
    } else {
      tdPerc.textContent = "";
    }
    tr.appendChild(tdPerc);

    const tdTempo = document.createElement("td");
    tdTempo.textContent = e.tempo || "";
    tr.appendChild(tdTempo);

    const tdCarga = document.createElement("td");
    tdCarga.textContent = e.carga ? formatKg(e.carga) : "";
    tr.appendChild(tdCarga);

    const tdDel = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üóë";
    btn.className = "btn-delete";
    btn.addEventListener("click", () => deleteTreinoEntry(treinos.indexOf(e)));
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);

    treinoBody.appendChild(tr);

    totalCarga += e.carga || 0;
    totalSeries += (e.rondas || 0);

    if (e.perc1rm && e.reps) {
      const p = e.perc1rm;
      const r = e.reps;
      if (p >= 0.8 && r <= 5) {
        blocosForca++;
      } else if (p >= 0.65 && p <= 0.8 && r >= 6 && r <= 12) {
        blocosHipertrofia++;
      } else if (p < 0.6 || r >= 15) {
        blocosLeve++;
      }
    }
  });

  treinoResumoEl.textContent =
    "Resumo do dia " + dia + ": carga total do WOD = " + formatKg(totalCarga);

  const sugestao = buildSugestao(
    lista,
    totalCarga,
    totalSeries,
    blocosForca,
    blocosHipertrofia,
    blocosLeve,
    dia
  );
  treinoSugestaoEl.textContent = sugestao;

  renderWeeklyHistory();
  renderDailyHistory();
}

/* Eventos WOD */
if (treinoAddBtn) {
  treinoAddBtn.addEventListener("click", addTreinoEntry);
}

/* Atualiza automaticamente quando mudas a data */
if (treinoDataEl) {
  treinoDataEl.addEventListener("change", renderTreinos);
}

/* BOT√ÉO HIST√ìRICO DI√ÅRIO */
if (toggleDailyHistoryBtn && dailyHistorySection) {
  toggleDailyHistoryBtn.addEventListener("click", () => {
    const visible = dailyHistorySection.style.display === "block";
    dailyHistorySection.style.display = visible ? "none" : "block";
    if (!visible) {
      renderDailyHistory();
    }
  });
}

/* TABS */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const target = btn.dataset.target;
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(target).classList.add("active");

    if (target === "sec-treino") {
      renderTreinos();
    }
  });
});

/* INIT */
initSelect();
loadProfile();
renderRm();

if (treinoDataEl && !treinoDataEl.value) {
  treinoDataEl.value = new Date().toISOString().slice(0, 10);
}
renderTreinos();

/* Quando muda exerc√≠cio do gr√°fico, atualizar chart */
if (graphExerciseEl) {
  graphExerciseEl.addEventListener("change", updateRmChart);
}

/* REGISTO DO SERVICE WORKER */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    navigator.serviceWorker.register("service-worker.js");
  });
}
</script>

</body>
</html>


