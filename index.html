<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrossBox</title>

  <meta name="theme-color" content="#f2f2f2" />
  <link rel="manifest" href="manifest.json" />

  <link rel="apple-touch-icon" sizes="180x180" href="imagens/crossbox_logo.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #111;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 0;
      box-sizing: border-box;
      color: #f3f3f3;
      background:
        radial-gradient(circle at 0 0, rgba(60, 80, 50, 0.45) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(110, 90, 60, 0.35) 0, transparent 55%),
        radial-gradient(circle at 0 100%, rgba(70, 60, 40, 0.35) 0, transparent 55%),
        linear-gradient(145deg, #1a1f16 0%, #151912 40%, #0d100c 100%);
      background-attachment: fixed;
    }

    * {
      box-sizing: border-box;
    }

    .app {
      position: relative;
      width: 100%;
      max-width: 960px;
      margin: 8px;
      padding: 12px;
      border-radius: 14px;
      background:
        linear-gradient(
          135deg,
          rgba(18, 23, 16, 0.97) 0%,
          rgba(13, 16, 11, 0.98) 40%,
          rgba(8, 9, 6, 0.99) 100%
        );
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.8),
        0 18px 35px rgba(0, 0, 0, 0.9);
      overflow: hidden;
    }

    .app::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 0 0, rgba(180, 180, 120, 0.13) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(160, 140, 90, 0.12) 0, transparent 55%),
        radial-gradient(circle at 30% 100%, rgba(130, 150, 90, 0.16) 0, transparent 50%),
        repeating-linear-gradient(
          125deg,
          rgba(0, 0, 0, 0.2) 0px,
          rgba(0, 0, 0, 0.2) 1px,
          transparent 1px,
          transparent 4px
        );
      mix-blend-mode: soft-light;
      opacity: 0.32;
      pointer-events: none;
    }

    header {
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      z-index: 2;
    }

    #appLogo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(40, 45, 32, 0.95);
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.9),
        0 0 12px rgba(0, 0, 0, 0.9);
    }

    h1 {
      font-size: 1.15rem;
      margin: 0;
      color: #f7f7f0;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.9);
    }

    .subtitle {
      font-size: 0.78rem;
      color: #d2d6c8;
      margin-top: 2px;
    }

    .app::after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 10% 0%, rgba(90, 110, 70, 0.5) 0, transparent 55%),
        radial-gradient(circle at 90% 0%, rgba(120, 100, 70, 0.45) 0, transparent 55%);
      mix-blend-mode: soft-light;
      opacity: 0.55;
      pointer-events: none;
      z-index: 0;
    }

    .card {
      position: relative;
      background:
        radial-gradient(circle at 0 0, rgba(160, 150, 110, 0.18) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(110, 130, 90, 0.16) 0, transparent 55%),
        linear-gradient(135deg,
          rgba(22, 27, 18, 0.98),
          rgba(16, 19, 12, 0.99)
        );
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.85),
        0 12px 24px rgba(0, 0, 0, 0.85);
      z-index: 1;
    }

    h2, h3 {
      margin: 0 0 6px 0;
      color: #f0f2e8;
      font-size: 0.95rem;
    }

    label {
      display: block;
      font-size: 0.78rem;
      margin-bottom: 2px;
      color: #e2e5d4;
    }

    input, select, textarea {
      width: 100%;
      padding: 6px 7px;
      border-radius: 6px;
      border: 1px solid rgba(92, 98, 80, 0.8);
      background: rgba(10, 12, 7, 0.96);
      color: #f7f7f2;
      font-size: 0.8rem;
      outline: none;
      box-shadow:
        inset 0 0 0 1px rgba(0, 0, 0, 0.7);
    }

    input:focus, select:focus, textarea:focus {
      border-color: rgba(205, 190, 122, 0.95);
      box-shadow:
        0 0 0 1px rgba(205, 190, 122, 0.8),
        0 0 0 3px rgba(205, 190, 122, 0.25);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }

    .field {
      flex: 1;
      min-width: 120px;
    }

    .field-small {
      max-width: 120px;
    }

    .helper-text {
      font-size: 0.72rem;
      color: #c3c8b5;
      margin-top: 3px;
    }

    .helper-text strong {
      color: #f5f7eb;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin: 4px 0 10px 0;
      position: relative;
      z-index: 2;
    }

    .tab-btn {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(117, 129, 94, 0.85);
      background:
        radial-gradient(circle at 0 0, rgba(150, 170, 90, 0.25) 0, transparent 60%);
      color: #f4f4ea;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      box-shadow:
        0 2px 0 rgba(0, 0, 0, 0.7);
    }

    .tab-btn:hover {
      filter: brightness(1.05);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #cfc27a, #f0df9e);
      color: #16170e;
      border-color: #e2d58d;
      box-shadow:
        0 0 0 1px rgba(6, 5, 0, 0.9),
        0 3px 0 rgba(6, 5, 0, 0.95);
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
    }

    .opt-btn {
      width: 100%;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .opt-emoji {
      font-size: 1.4rem;
    }

    .option-section {
      display: none;
    }

    .option-section.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.79rem;
    }

    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(70, 75, 55, 0.8);
      white-space: nowrap;
      text-align: left;
    }

    th {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #c9ceb8;
    }

    tr:nth-child(even) td {
      background: rgba(9, 11, 6, 0.88);
    }

    tr:nth-child(odd) td {
      background: rgba(12, 14, 8, 0.88);
    }

    .scroll {
      overflow-x: auto;
    }

    .btn-primary,
    .btn-secondary,
    .btn-ghost {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 6px 10px;
      font-size: 0.78rem;
      cursor: pointer;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #d9c877, #f5e59a);
      color: #15140b;
      border-color: #f0e2a0;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.8),
        0 3px 0 rgba(0, 0, 0, 0.9);
      font-weight: 600;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    .btn-secondary {
      background: radial-gradient(circle at 0 0, rgba(150, 167, 92, 0.25) 0, transparent 60%);
      color: #f0f3e5;
      border-color: rgba(110, 120, 85, 0.9);
      box-shadow: 0 2px 0 rgba(0, 0, 0, 0.7);
    }

    .btn-secondary:hover {
      filter: brightness(1.07);
    }

    .btn-ghost {
      background: transparent;
      color: #d4d7c5;
      border-color: rgba(113, 120, 92, 0.7);
      border-style: dashed;
    }

    .btn-ghost:hover {
      border-style: solid;
      filter: brightness(1.08);
    }

    .btn-delete {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }

    .btn-small {
      padding: 3px 8px;
      font-size: 0.7rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: radial-gradient(circle at 0 0, rgba(180, 165, 100, 0.4) 0, transparent 55%);
      border-radius: 999px;
      border: 1px solid rgba(188, 173, 105, 0.9);
      padding: 3px 7px;
      font-size: 0.68rem;
      color: #f7f7e9;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: radial-gradient(circle at 0 0, rgba(110, 125, 72, 0.55) 0, transparent 55%);
      border-radius: 999px;
      border: 1px solid rgba(131, 145, 88, 0.9);
      padding: 2px 6px;
      font-size: 0.68rem;
      color: #f3f5e8;
    }

    .chip .label {
      opacity: 0.9;
    }

    .chip .value {
      font-weight: 600;
    }

    .small-text {
      font-size: 0.72rem;
      color: #c5cab7;
    }

    .warning {
      background: rgba(150, 100, 40, 0.32);
      border: 1px solid rgba(200, 150, 80, 0.85);
      color: #f7f0df;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      margin-bottom: 6px;
    }

    .success {
      background: rgba(110, 150, 80, 0.32);
      border: 1px solid rgba(155, 200, 110, 0.85);
      color: #f4f8ea;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      margin-top: 4px;
    }

    .alert {
      background: rgba(150, 70, 60, 0.38);
      border: 1px solid rgba(210, 120, 100, 0.9);
      color: #ffece6;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      margin-top: 6px;
    }

    canvas {
      max-width: 100%;
    }

    .no-select {
      user-select: none;
    }

    /* BOT√ÉO RESERVAS NO CANTO SUPERIOR DIREITO (j√° sem HTML associado) */
    #reservasBtn {
      position: absolute;
      top: 4px;
      right: 4px;
      padding: 4px 8px;
      font-size: 0.7rem;
      z-index: 5;
    }

    @media (max-width: 600px) {
      header {
        align-items: flex-start;
      }

      #appLogo {
        width: 52px;
        height: 52px;
      }

      h1 {
        font-size: 1.05rem;
      }

      .form-row {
        flex-direction: column;
      }

      .options-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
<div class="app">

  <header>
    <img id="appLogo" src="imagens/crossbox_logo.png" alt="Cross Moita Logo">
    <div class="subtitle" id="appSubtitle">Registo de treinos</div>

  </header>

  <!-- PERFIL -->
  <section class="card" id="perfil">
    <div id="perfilForm">
      <div class="form-row">
        <div class="field">
          <label>Nome</label>
          <input id="nome" type="text" />
        </div>
        <div class="field">
          <label>N√≠vel</label>
          <select id="nivel">
            <option value="">Selecionar</option>
            <option value="iniciante">Iniciante</option>
            <option value="intermedio">Interm√©dio</option>
            <option value="avancado">Avan√ßado</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Sexo</label>
          <select id="sexo">
            <option value="">Selecionar</option>
            <option value="masculino">Masculino</option>
            <option value="feminino">Feminino</option>
          </select>
        </div>
        <div class="field">
          <label>Idade</label>
          <input id="idade" type="number" min="10" max="99" />
        </div>
        <div class="field">
          <label>Altura (cm)</label>
          <input id="altura" type="number" min="130" max="220" />
        </div>
        <div class="field">
          <label>Peso (kg)</label>
          <input id="peso" type="number" step="0.1" min="30" max="250" />
        </div>
      </div>

      <button class="btn-primary" id="saveProfile">Guardar perfil</button>
    </div>
  </section>
  <!-- (antiga sec-reservas aqui foi removida; agora est√° dentro de WOD & Tools) -->

  <!-- TABS PRINCIPAIS -->
  <div class="tabs">
    <button class="tab-btn active" data-target="sec-1rm">1RM</button>
    <button class="tab-btn" data-target="sec-opcoes">WOD & Tools</button>
  </div>

  <!-- SEC√á√ÉO 1: 1RM -->
  <section id="sec-1rm" class="section active">

    <div class="card">
      <div class="form-row">
        <div class="field">
          <label>Exerc√≠cio</label>
          <select id="exercise"></select>
        </div>

        <div class="field">
          <label>1RM (kg) ‚Äì peso m√°ximo numa repeti√ß√£o</label>
          <input id="oneRm" type="number" step="0.5" />
        </div>
      </div>

      <button class="btn-primary" id="addBtn">Guardar / Atualizar</button>
    </div>

    <div class="card">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Exerc√≠cio</th>
              <th>1RM</th>
              <th>25%</th>
              <th>30%</th>
              <th>35%</th>
              <th>40%</th>
              <th>50%</th>
              <th>60%</th>
              <th>65%</th>
              <th>70%</th>
              <th>75%</th>
              <th>80%</th>
              <th>85%</th>
              <th>90%</th>
              <th>95%</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>Hist√≥rico de 1RM</h3>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Exerc√≠cio</th>
              <th>Data</th>
              <th>1RM</th>
              <th>Diferen√ßa</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
      <div class="helper-text" id="historyResumo"></div>
    </div>
  </section>

  <!-- SEC√á√ÉO 2: OP√á√ïES -->
  <section id="sec-opcoes" class="section">

    <div class="card">
      <div class="options-grid">
        <button class="btn-secondary opt-btn" data-target="opt-wod">
          <span class="opt-emoji">üü©</span>
          <span>WOD</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-calc">
          <span class="opt-emoji">üßÆ</span>
          <span>Objetivo</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-graficos">
          <span class="opt-emoji">üìà</span>
          <span>Gr√°fico</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-performance">
          <span class="opt-emoji">üèÖ</span>
          <span>Desempenho</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-reservas">
          <span class="opt-emoji">üìÜ</span>
          <span>Marca√ß√µes</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-guia">
          <span class="opt-emoji">üìö</span>
          <span>Exerc√≠cios</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-backup">
          <span class="opt-emoji">üíæ</span>
          <span>Backup</span>
        </button>

      </div>
      <div class="helper-text" style="margin-top:8px;">
      </div>
    </div>

    <!-- MARCA√á√ïES / RESERVAS -->
    <section id="opt-reservas" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üìÜ Reservas & Presen√ßas</h3>

        <div class="form-row">
          <div class="field">
            <label>Data da aula</label>
            <input id="reservaData" type="date" />
          </div>
          <div class="field">
            <label>Hora</label>
            <input id="reservaHora" type="time" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Tipo de aula</label>
            <select id="reservaTipo">
              <option value="">Selecionar</option>
              <option value="WOD">WOD</option>
              <option value="Open Box">Open Box</option>
              <option value="Halterofilismo">Halterofilismo</option>
              <option value="Mobilidade">Mobilidade</option>
              <option value="Competi√ß√£o">Competi√ß√£o</option>
            </select>
          </div>
          <div class="field">
            <label>Nota (opcional)</label>
            <input id="reservaNota" type="text" placeholder="Ex.: parceiro, foco, objetivo do dia..." />
          </div>
        </div>

        <button class="btn-primary" id="reservaAddBtn">Guardar reserva</button>

        <div class="helper-text" style="margin-top:6px;">
          Estas reservas e presen√ßas s√£o pessoais e ficam apenas guardadas neste dispositivo.
        </div>

        <div class="scroll" style="margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Hora</th>
                <th>Aula</th>
                <th>Nota</th>
                <th>Presen√ßa</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="reservasBody"></tbody>
          </table>
        </div>

        <div class="helper-text" id="reservasResumo" style="margin-top:6px;"></div>
      </div>
    </section>

    <!-- WOD -->
    <section id="opt-wod" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üü© WOD</h3>

        <div class="form-row">
          <div class="field">
            <label>Data</label>
            <input id="treinoData" type="date">
          </div>
          <div class="field">
            <label>Exerc√≠cio</label>
            <input id="treinoExercicioSearch" type="text" placeholder="Procurar exerc√≠cio..." />
            <select id="treinoExercicio"></select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Categoria</label>
            <select id="treinoCategoria">
              <option value="">Selecionar</option>
              <option value="for√ßa">For√ßa</option>
              <option value="t√©cnica">T√©cnica</option>
              <option value="metcon">Metcon</option>
            </select>
          </div>
          <div class="field">
            <label>Rondas / S√©ries</label>
            <input id="treinoRondas" type="number" min="1" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Repeti√ß√µes por s√©rie</label>
            <input id="treinoReps" type="number" min="1" />
          </div>
          <div class="field">
            <label>Carga / Intensidade</label>
            <input id="treinoCarga" type="text" placeholder="Ex.: 80kg, RX, 70% 1RM..." />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Tempo / Score</label>
            <input id="treinoScore" type="text" placeholder="Ex.: 12:35, 3 rondas + 10 reps..." />
          </div>
          <div class="field">
            <label>RPE (1-10)</label>
            <input id="treinoRpe" type="number" min="1" max="10" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Notas</label>
            <textarea id="treinoNotas" placeholder="Como correu? Onde sentiste mais dificuldade?"></textarea>
          </div>
        </div>

        <button class="btn-primary" id="treinoAdd">Registar WOD</button>
      </div>

      <div class="card">
        <h3>Hist√≥rico de treinos</h3>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Exerc√≠cio</th>
                <th>Categoria</th>
                <th>Score</th>
                <th>RPE</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="treinoTableBody"></tbody>
          </table>
        </div>
        <div class="helper-text" id="treinoResumo"></div>
      </div>
    </section>

    <!-- OBJETIVO -->
    <section id="opt-calc" class="option-section">
      <div class="card">
        <h3>Objetivo do treino</h3>

        <div class="form-row">
          <div class="field">
            <label>Exerc√≠cio</label>
            <select id="calcExercicio"></select>
          </div>
          <div class="field">
            <label>N.¬∫ de repeti√ß√µes planeadas</label>
            <input id="calcReps" type="number" min="1" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Objetivo</label>
            <select id="calcObjetivo">
              <option value="">Autom√°tico</option>
              <option value="forca">For√ßa</option>
              <option value="hipertrofia">Hipertrofia</option>
              <option value="tecnica">T√©cnica</option>
            </select>
          </div>
          <div class="field">
            <label>Semanas de progress√£o</label>
            <input id="calcWeeks" type="number" min="1" />
          </div>
        </div>

        <button class="btn-primary" id="calcBtn">Calcular</button>
        <div class="helper-text" id="calcResultado" style="margin-top:6px;">
          Escolhe um exerc√≠cio, indica o n¬∫ de repeti√ß√µes e, se quiseres, o objetivo (for√ßa / hipertrofia / t√©cnica).
        </div>
      </div>
    </section>

    <!-- GR√ÅFICOS -->
    <section id="opt-graficos" class="option-section">
      <div class="card">
        <h3>Gr√°ficos de evolu√ß√£o</h3>

        <div class="form-row">
          <div class="field">
            <label>Tipo de gr√°fico</label>
            <select id="graphTipo">
              <option value="1rm">1RM</option>
              <option value="wod">WOD / RPE</option>
            </select>
          </div>
          <div class="field" id="graphExContainer">
            <label>Exerc√≠cio</label>
            <select id="graphExercicio"></select>
          </div>
        </div>

        <canvas id="chart" height="180"></canvas>
        <div class="helper-text" id="graphHelper"></div>
      </div>
    </section>
    <!-- PERFORMANCE -->
    <section id="opt-performance" class="option-section">
      <div class="card">
        <h3>Desempenho global</h3>
        <div id="performanceResumo" class="small-text"></div>
      </div>
    </section>

    <!-- GUIA DE EXERC√çCIOS -->
    <section id="opt-guia" class="option-section">
      <div class="card">
        <h3>Guia r√°pido de exerc√≠cios</h3>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Exerc√≠cio</th>
                <th>Categoria</th>
                <th>Descri√ß√£o</th>
              </tr>
            </thead>
            <tbody id="guiaExerciciosBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BACKUP -->
    <section id="opt-backup" class="option-section">
      <div class="card">
        <h3>Backup & Ficheiros</h3>

        <div class="form-row">
          <div class="field">
            <label>Exportar dados</label>
            <button class="btn-secondary btn-small" id="exportBackupBtn">Exportar JSON</button>
          </div>
          <div class="field">
            <label>Importar dados</label>
            <button class="btn-secondary btn-small" id="importBackupBtn">Importar JSON</button>
            <input id="backupFileInput" type="file" accept=".json" style="display:none;" />
          </div>
        </div>

        <div class="helper-text" id="backupInfo" style="margin-top:6px;"></div>
      </div>
    </section>

  </section>

</div>

<script>
/* STORAGE KEYS */
const STORAGE_PROFILE = "crossfit_profile";
const STORAGE_RM = "crossfit_1rm";
const STORAGE_RM_HISTORY = "crossfit_1rm_history";
const STORAGE_TREINO = "crossfit_treinos";
const STORAGE_BACKUP_META = "crossfit_backup_meta";

/* NOVOS ARMAZENAMENTOS */
const STORAGE_RESERVAS = "crossfit_reservas";
const STORAGE_PRESENCAS = "crossfit_presencas";
const STORAGE_RANKINGS = "crossfit_rankings";

/* ===== PERFIL ===== */
let profile = JSON.parse(localStorage.getItem(STORAGE_PROFILE) || "{}");

const nomeEl = document.getElementById("nome");
const nivelEl = document.getElementById("nivel");
const sexoEl = document.getElementById("sexo");
const idadeEl = document.getElementById("idade");
const alturaEl = document.getElementById("altura");
const pesoEl = document.getElementById("peso");
const perfilForm = document.getElementById("perfilForm");
const subtitleEl = document.getElementById("appSubtitle");

function updateProfileInfo() {
  if (!perfilForm) return;
  const nome = (profile.nome || "").trim();
  if (nome) {
    subtitleEl.textContent = `Registo de treinos de ${nome}`;
  } else {
    subtitleEl.textContent = "Registo de treinos";
  }
}

function loadProfile() {
  if (!profile) return;

  nomeEl.value = profile.nome || "";
  nivelEl.value = profile.nivel || "";
  sexoEl.value = profile.sexo || "";
  idadeEl.value = profile.idade || "";
  alturaEl.value = profile.altura || "";
  pesoEl.value = profile.peso || "";

  updateProfileInfo();
}

function saveProfile() {
  profile = {
    nome: nomeEl.value || "",
    nivel: nivelEl.value || "",
    sexo: sexoEl.value || "",
    idade: idadeEl.value || "",
    altura: alturaEl.value || "",
    peso: pesoEl.value || ""
  };
  localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
  updateProfileInfo();
}

document.getElementById("saveProfile").addEventListener("click", saveProfile);

/* ===== 1RM ===== */
let dataRm = JSON.parse(localStorage.getItem(STORAGE_RM) || "{}");
let rmHistory = JSON.parse(localStorage.getItem(STORAGE_RM_HISTORY) || "{}");

const sel = document.getElementById("exercise");
const oneRmInput = document.getElementById("oneRm");
const addBtn = document.getElementById("addBtn");
const tableBody = document.getElementById("tableBody");
const historyBody = document.getElementById("historyBody");
const historyResumo = document.getElementById("historyResumo");

/* Exerc√≠cios base para 1RM */
const MOVES_PT = {
  "Back Squat": "Back Squat",
  "Front Squat": "Front Squat",
  "Overhead Squat": "Overhead Squat",
  "Deadlift": "Deadlift",
  "Bench Press": "Bench Press",
  "Strict Press": "Strict Press",
  "Push Press": "Push Press",
  "Push Jerk": "Push Jerk",
  "Split Jerk": "Split Jerk",
  "Power Clean": "Power Clean",
  "Squat Clean": "Squat Clean",
  "Power Snatch": "Power Snatch",
  "Squat Snatch": "Squat Snatch",
  "Clean & Jerk": "Clean & Jerk",
  "Thruster": "Thruster"
};

/* Lista detalhada de exerc√≠cios (para Guia, WOD, etc.) */
const EXER_INFO = [
  { en: "Back Squat", pt: "Back Squat", descricao: "Agachamento com a barra apoiada nas costas, foco em for√ßa de pernas e core." },
  { en: "Front Squat", pt: "Front Squat", descricao: "Agachamento frontal com a barra apoiada nos ombros. Exige mais mobilidade de tronco." },
  { en: "Overhead Squat", pt: "Overhead Squat", descricao: "Agachamento com a barra acima da cabe√ßa, exige muita estabilidade e mobilidade." },
  { en: "Deadlift", pt: "Deadlift", descricao: "Levantamento da barra do ch√£o at√© √† anca, foco em cadeia posterior." },
  { en: "Bench Press", pt: "Supino", descricao: "Press em banco deitado para desenvolvimento de peito, ombros e tr√≠ceps." },
  { en: "Strict Press", pt: "Press estrito", descricao: "Press vertical sem ajuda de pernas, for√ßa pura de ombros." },
  { en: "Push Press", pt: "Push Press", descricao: "Press de ombros com impulso de pernas." },
  { en: "Push Jerk", pt: "Push Jerk", descricao: "Press de ombros com dip e rece√ß√£o em semi-agachamento." },
  { en: "Split Jerk", pt: "Split Jerk", descricao: "Varia√ß√£o de jerk com passada √† frente e atr√°s para mais estabilidade." },
  { en: "Power Clean", pt: "Power Clean", descricao: "Clean rececionado acima da paralela, movimento explosivo com barra." },
  { en: "Squat Clean", pt: "Squat Clean", descricao: "Clean rececionado em agachamento completo." },
  { en: "Power Snatch", pt: "Power Snatch", descricao: "Snatch rececionado acima da paralela, movimento muito explosivo." },
  { en: "Squat Snatch", pt: "Squat Snatch", descricao: "Snatch rececionado em agachamento completo." },
  { en: "Clean & Jerk", pt: "Clean & Jerk", descricao: "Levantamento ol√≠mpico completo, clean seguido de jerk." },
  { en: "Thruster", pt: "Thruster", descricao: "Front squat seguido de press acima da cabe√ßa num s√≥ movimento." },
  { en: "Burpee", pt: "Burpee", descricao: "Exerc√≠cio de corpo inteiro, descida ao ch√£o e salto." },
  { en: "Pull-up", pt: "Pull-up", descricao: "Eleva√ß√£o na barra. Pode ser estrito, kipping ou butterfly." },
  { en: "Toes to Bar", pt: "Toes to Bar", descricao: "Elevar os p√©s at√© √† barra, forte est√≠mulo de core." },
  { en: "Kipping Swing", pt: "Kipping Swing", descricao: "Balan√ßo na barra para gerar momentum em movimentos gin√°sticos." },
  { en: "Chest to Bar", pt: "Chest to Bar", descricao: "Pull-up em que o peito toca na barra." },
  { en: "Muscle-up", pt: "Muscle-up", descricao: "Passagem da posi√ß√£o de suspens√£o para suporte acima da barra ou rings." },
  { en: "Ring Dip", pt: "Ring Dip", descricao: "Dip em argolas, muito exigente para ombros e core." },
  { en: "Handstand Push-up", pt: "Handstand Push-up", descricao: "Flex√µes de bra√ßos em pino." },
  { en: "Handstand Walk", pt: "Handstand Walk", descricao: "Marcha em pino, forte componente de skill e controlo." },
  { en: "Box Jump", pt: "Box Jump", descricao: "Salto para cima de uma caixa, foco em pot√™ncia de pernas." },
  { en: "Box Jump Over", pt: "Box Jump Over", descricao: "Transposi√ß√£o de caixa, geralmente sem necessidade de extens√£o total." },
  { en: "Step-up", pt: "Step-up", descricao: "Subida alternada √† caixa, for√ßa unilateral de pernas." },
  { en: "Pistol Squat", pt: "Pistol Squat", descricao: "Agachamento numa s√≥ perna, muito desafiador em equil√≠brio e mobilidade." },
  { en: "Lunge", pt: "Lunge", descricao: "Passadas em frente, atr√°s ou laterais." },
  { en: "Walking Lunge", pt: "Walking Lunge", descricao: "Passadas a caminhar, com ou sem carga." },
  { en: "Row", pt: "Remo", descricao: "Remo em m√°quina, excelente cardio de corpo inteiro." },
  { en: "Ski Erg", pt: "Ski Erg", descricao: "Simula√ß√£o de movimento de ski, foco em tronco superior e cardio." },
  { en: "Assault Bike", pt: "Assault Bike", descricao: "Bicicleta de bra√ßos e pernas, muito exigente a n√≠vel metab√≥lico." },
  { en: "Echo Bike", pt: "Echo Bike", descricao: "Vers√£o similar √† Assault Bike, tamb√©m muito intensa." },
  { en: "Bike Erg", pt: "Bike Erg", descricao: "Bicicleta para trabalho mais cont√≠nuo de pernas." },
  { en: "Run", pt: "Corrida", descricao: "Corrida em exterior ou tapete." },
  { en: "Double Unders", pt: "Double Unders", descricao: "Saltos √† corda em que a corda passa duas vezes por salto." },
  { en: "Single Unders", pt: "Single Unders", descricao: "Saltos √† corda simples." },
  { en: "Sit-up", pt: "Sit-up", descricao: "Flex√£o de tronco para trabalhar abdominais." },
  { en: "V-Up", pt: "V-Up", descricao: "Abdominal em forma de V, tocando p√©s e m√£os no topo." },
  { en: "Hollow Hold", pt: "Hollow Hold", descricao: "Isometria em hollow, base para muitos movimentos gin√°sticos." },
  { en: "Plank", pt: "Prancha", descricao: "Isometria de core, pode ser frontal ou lateral." },
  { en: "GHD Sit-up", pt: "GHD Sit-up", descricao: "Sit-up profundo na m√°quina GHD." },
  { en: "Hip Extension", pt: "Extens√£o de anca", descricao: "Extens√£o na GHD, foco em lombar e isquiotibiais." },
  { en: "Good Morning", pt: "Good Morning", descricao: "Flex√£o do tronco com barra aos ombros, foco em cadeia posterior." },
  { en: "Russian Twist", pt: "Russian Twist", descricao: "Rota√ß√£o de tronco com ou sem carga." },
  { en: "Farmer\'s Carry", pt: "Farmer\'s Carry", descricao: "Caminhada a segurar pesos pesados em cada m√£o." },
  { en: "Sandbag Carry", pt: "Sandbag Carry", descricao: "Caminhada com saco pesado ao ombro ou ao peito." },
  { en: "Wall Ball", pt: "Wall Ball", descricao: "Agachamento com lan√ßamento de bola √† parede." },
  { en: "Medball Clean", pt: "Medball Clean", descricao: "Clean com bola medicinal." },
  { en: "Sled Push", pt: "Sled Push", descricao: "Empurrar tren√≥, foco em for√ßa de pernas e cardio." },
  { en: "Sled Pull", pt: "Sled Pull", descricao: "Puxar tren√≥ com arn√™s ou corda." },
  { en: "Dumbbell Snatch", pt: "Snatch com halteres", descricao: "Eleva√ß√£o do ch√£o at√© acima da cabe√ßa com um haltere, num movimento explosivo e cont√≠nuo." },
  { en: "Dumbbell Clean", pt: "Clean com halteres", descricao: "Elevar o haltere do ch√£o ou das pernas at√© ao ombro, com extens√£o de anca." },
  { en: "Dumbbell Clean & Jerk", pt: "Clean & jerk com halteres", descricao: "Clean com haltere at√© ao ombro seguido de impulso at√© overhead." },
  { en: "Dumbbell Thruster", pt: "Thruster com halteres", descricao: "Agachamento frontal seguido de press com halteres acima da cabe√ßa num s√≥ movimento." },
  { en: "Dumbbell Row", pt: "Remada com halteres", descricao: "Remada unilateral puxando o haltere em dire√ß√£o ao tronco, focando dorsais." },
  { en: "Dumbbell Lunges", pt: "Passadas com halteres", descricao: "Passadas segurando um haltere em cada m√£o junto ao corpo." },
  { en: "Kettlebell Swing", pt: "Swing com kettlebell", descricao: "Balan√ßo da kettlebell usando sobretudo o impulso da anca, n√£o dos bra√ßos." },
  { en: "Kettlebell Clean", pt: "Clean com kettlebell", descricao: "Elevar a kettlebell do fundo at√© √† posi√ß√£o de rack junto ao peito." },
  { en: "Kettlebell Snatch", pt: "Snatch com kettlebell", descricao: "Eleva√ß√£o da kettlebell do fundo at√© acima da cabe√ßa num s√≥ movimento." },
  { en: "Turkish Get-up", pt: "Turkish Get-up", descricao: "Levantamento do ch√£o at√© √† posi√ß√£o de p√© com carga acima da cabe√ßa, muito completo." },
  { en: "Russian Kettlebell Swing", pt: "Russian Kettlebell Swing", descricao: "Swing em que a kettlebell vai at√© √† altura do ombro." },
  { en: "American Kettlebell Swing", pt: "American Kettlebell Swing", descricao: "Swing em que a kettlebell vai at√© acima da cabe√ßa." }
];

/* Lista completa de exerc√≠cios em ingl√™s (para WOD, Objetivo, Guia) */
const ALL_EXERCISES = Array.from(new Set(EXER_INFO.map(ex => ex.en))).sort();

/* Completar MOVES_PT com todos os exerc√≠cios do guia */
EXER_INFO.forEach(ex => {
  MOVES_PT[ex.en] = ex.pt;
});
const PERC = [
  0.25, 0.30, 0.35, 0.40,
  0.50, 0.60, 0.65, 0.70,
  0.75, 0.80, 0.85, 0.90,
  0.95
];

let dataRm = JSON.parse(localStorage.getItem(STORAGE_RM) || "{}");
let rmHistory2 = JSON.parse(localStorage.getItem(STORAGE_RM_HISTORY) || "{}");

/* ===== FUN√á√ïES AUXILIARES ===== */
function formatKg(v) {
  return v.toFixed(1).replace(".", ",") + " kg";
}

function formatKm(v) {
  return v.toFixed(2).replace(".", ",") + " km";
}

function initSelects() {
  sel.innerHTML = "";
  Object.keys(MOVES_PT).sort().forEach(key => {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = MOVES_PT[key];
    sel.appendChild(opt);
  });

  const calcEx = document.getElementById("calcExercicio");
  calcEx.innerHTML = "";
  ALL_EXERCISES.forEach(ex => {
    const opt = document.createElement("option");
    opt.value = ex;
    opt.textContent = MOVES_PT[ex] || ex;
    calcEx.appendChild(opt);
  });

  const graphEx = document.getElementById("graphExercicio");
  graphEx.innerHTML = "";
  Object.keys(MOVES_PT).sort().forEach(key => {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = MOVES_PT[key];
    graphEx.appendChild(opt);
  });

  const treinoEx = document.getElementById("treinoExercicio");
  treinoEx.innerHTML = "";
  ALL_EXERCISES.forEach(ex => {
    const opt = document.createElement("option");
    opt.value = ex;
    opt.textContent = MOVES_PT[ex] || ex;
    treinoEx.appendChild(opt);
  });
}
function renderRmTable() {
  tableBody.innerHTML = "";

  Object.keys(dataRm).sort().forEach(ex => {
    const tr = document.createElement("tr");

    const tdEx = document.createElement("td");
    tdEx.textContent = MOVES_PT[ex] || ex;
    tr.appendChild(tdEx);

    const tdRm = document.createElement("td");
    tdRm.textContent = formatKg(dataRm[ex]);
    tr.appendChild(tdRm);

    PERC.forEach(p => {
      const td = document.createElement("td");
      td.textContent = formatKg(dataRm[ex] * p);
      tr.appendChild(td);
    });

    const tdDel = document.createElement("td");
    const btnDel = document.createElement("button");
    btnDel.className = "btn-delete";
    btnDel.textContent = "üóë";
    btnDel.addEventListener("click", () => {
      delete dataRm[ex];
      localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
      renderRmTable();
      renderRmHistory();
    });
    tdDel.appendChild(btnDel);
    tr.appendChild(tdDel);

    tableBody.appendChild(tr);
  });
}

function renderRmHistory() {
  historyBody.innerHTML = "";

  const rows = [];
  Object.keys(rmHistory2).forEach(ex => {
    rmHistory2[ex].forEach(entry => {
      rows.push({
        ex,
        data: entry.data,
        rm: entry.rm,
        diff: entry.diff || 0
      });
    });
  });

  rows.sort((a, b) => a.data.localeCompare(b.data));

  rows.forEach(r => {
    const tr = document.createElement("tr");

    const tdEx = document.createElement("td");
    tdEx.textContent = MOVES_PT[r.ex] || r.ex;
    tr.appendChild(tdEx);

    const tdData = document.createElement("td");
    tdData.textContent = r.data;
    tr.appendChild(tdData);

    const tdRm = document.createElement("td");
    tdRm.textContent = formatKg(r.rm);
    tr.appendChild(tdRm);

    const tdDiff = document.createElement("td");
    if (r.diff > 0) {
      tdDiff.textContent = `+${r.diff.toFixed(1)} kg`;
    } else if (r.diff < 0) {
      tdDiff.textContent = `${r.diff.toFixed(1)} kg`;
    } else {
      tdDiff.textContent = "-";
    }
    tr.appendChild(tdDiff);

    historyBody.appendChild(tr);
  });

  if (rows.length > 0) {
    const ultimo = rows[rows.length - 1];
    historyResumo.textContent = `√öltimo 1RM registado: ${MOVES_PT[ultimo.ex] || ultimo.ex} em ${ultimo.data} (${formatKg(ultimo.rm)}).`;
  } else {
    historyResumo.textContent = "Ainda n√£o h√° hist√≥rico de 1RM.";
  }
}

function addRm() {
  const ex = sel.value;
  const val = parseFloat(oneRmInput.value);
  if (!ex || !val || val <= 0) {
    alert("Preenche um exerc√≠cio e um valor de 1RM v√°lido.");
    return;
  }

  const old = dataRm[ex] || 0;
  const diff = old ? val - old : 0;

  dataRm[ex] = val;
  localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));

  if (!rmHistory2[ex]) rmHistory2[ex] = [];
  rmHistory2[ex].push({
    data: new Date().toISOString().slice(0, 10),
    rm: val,
    diff
  });
  localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory2));

  oneRmInput.value = "";
  renderRmTable();
  renderRmHistory();
}

addBtn.addEventListener("click", addRm);

/* ===== WOD / TREINOS ===== */
let treinos = JSON.parse(localStorage.getItem(STORAGE_TREINO) || "[]");

const treinoDataEl = document.getElementById("treinoData");
const treinoExercicioEl = document.getElementById("treinoExercicio");
const treinoExercicioSearchEl = document.getElementById("treinoExercicioSearch");
const treinoCategoriaEl = document.getElementById("treinoCategoria");
const treinoRondasEl = document.getElementById("treinoRondas");
const treinoRepsEl = document.getElementById("treinoReps");
const treinoCargaEl = document.getElementById("treinoCarga");
const treinoScoreEl = document.getElementById("treinoScore");
const treinoRpeEl = document.getElementById("treinoRpe");
const treinoNotasEl = document.getElementById("treinoNotas");
const treinoAddBtn = document.getElementById("treinoAdd");
const treinoTableBody = document.getElementById("treinoTableBody");
const treinoResumoEl = document.getElementById("treinoResumo");

function filtrarExerciciosTreino() {
  const texto = (treinoExercicioSearchEl.value || "").toLowerCase();
  treinoExercicioEl.innerHTML = "";
  ALL_EXERCISES
    .filter(ex => (MOVES_PT[ex] || ex).toLowerCase().includes(texto))
    .forEach(ex => {
      const opt = document.createElement("option");
      opt.value = ex;
      opt.textContent = MOVES_PT[ex] || ex;
      treinoExercicioEl.appendChild(opt);
    });
}

treinoExercicioSearchEl.addEventListener("input", filtrarExerciciosTreino);

function renderTreinos() {
  treinoTableBody.innerHTML = "";
  if (!treinos.length) {
    treinoResumoEl.textContent = "Ainda n√£o h√° treinos registados.";
    return;
  }

  const ordenados = [...treinos].sort((a, b) => (a.data || "").localeCompare(b.data || ""));
  ordenados.forEach((t, idx) => {
    const tr = document.createElement("tr");

    const tdData = document.createElement("td");
    tdData.textContent = t.data || "";
    tr.appendChild(tdData);

    const tdEx = document.createElement("td");
    tdEx.textContent = MOVES_PT[t.exercicio] || t.exercicio || "";
    tr.appendChild(tdEx);

    const tdCat = document.createElement("td");
    tdCat.textContent = t.categoria || "";
    tr.appendChild(tdCat);

    const tdScore = document.createElement("td");
    tdScore.textContent = t.score || "";
    tr.appendChild(tdScore);

    const tdRpe = document.createElement("td");
    tdRpe.textContent = t.rpe || "";
    tr.appendChild(tdRpe);

    const tdDel = document.createElement("td");
    const btnDel = document.createElement("button");
    btnDel.className = "btn-delete";
    btnDel.textContent = "üóë";
    btnDel.addEventListener("click", () => {
      treinos.splice(idx, 1);
      localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));
      renderTreinos();
      renderPerformance();
    });
    tdDel.appendChild(btnDel);
    tr.appendChild(tdDel);

    treinoTableBody.appendChild(tr);
  });

  const total = treinos.length;
  const unicos = new Set(treinos.map(t => t.data || "")).size;
  treinoResumoEl.textContent = `Treinos registados: ${total}. Dias √∫nicos com treino: ${unicos}.`;
}

function addTreino() {
  const data = treinoDataEl.value || new Date().toISOString().slice(0, 10);
  const exercicio = treinoExercicioEl.value || "Outro";
  const categoria = treinoCategoriaEl.value || "";
  const rondas = parseInt(treinoRondasEl.value || "0", 10);
  const reps = parseInt(treinoRepsEl.value || "0", 10);
  const carga = treinoCargaEl.value || "";
  const score = treinoScoreEl.value || "";
  const rpe = parseInt(treinoRpeEl.value || "0", 10);
  const notas = treinoNotasEl.value || "";

  treinos.push({
    data,
    exercicio,
    categoria,
    rondas,
    reps,
    carga,
    score,
    rpe,
    notas
  });

  localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));
  renderTreinos();
  renderPerformance();

  treinoRondasEl.value = "";
  treinoRepsEl.value = "";
  treinoCargaEl.value = "";
  treinoScoreEl.value = "";
  treinoRpeEl.value = "";
  treinoNotasEl.value = "";
}

treinoAddBtn.addEventListener("click", addTreino);

/* ===== OBJETIVO DO TREINO ===== */
const calcExercicioEl = document.getElementById("calcExercicio");
const calcRepsEl = document.getElementById("calcReps");
const calcObjetivoEl = document.getElementById("calcObjetivo");
const calcWeeksEl = document.getElementById("calcWeeks");
const calcBtn = document.getElementById("calcBtn");
const calcResultadoEl = document.getElementById("calcResultado");

function refreshCalcExOptions() {
  calcExercicioEl.innerHTML = "";
  ALL_EXERCISES.forEach(ex => {
    const opt = document.createElement("option");
    opt.value = ex;
    opt.textContent = MOVES_PT[ex] || ex;
    calcExercicioEl.appendChild(opt);
  });
}

function calcObjetivoTreino() {
  const ex = calcExercicioEl.value;
  const reps = parseInt(calcRepsEl.value || "0", 10);
  const objetivo = calcObjetivoEl.value;
  const weeks = parseInt(calcWeeksEl.value || "0", 10);

  if (!ex || !reps) {
    calcResultadoEl.textContent = "Escolhe um exerc√≠cio e indica as repeti√ß√µes.";
    return;
  }

  let texto = `Exerc√≠cio: ${(MOVES_PT[ex] || ex)} ¬∑ Reps por s√©rie: ${reps}. `;

  if (!objetivo) {
    if (reps <= 5) {
      texto += "Zona mais pr√≥xima de for√ßa m√°xima. Foca-te em carga alta e descanso mais longo.";
    } else if (reps <= 10) {
      texto += "Zona mista for√ßa/hipertrofia. Boa para ganhar massa muscular com carga moderada.";
    } else {
      texto += "Zona mais metab√≥lica / resist√™ncia. Ideal para condicionamento e endurance.";
    }
  } else if (objetivo === "forca") {
    texto += "Objetivo for√ßa: usa cargas altas, s√©ries curtas (1-5 repeti√ß√µes) e descansos de 2-3 minutos.";
  } else if (objetivo === "hipertrofia") {
    texto += "Objetivo hipertrofia: 6-12 repeti√ß√µes, descanso de 60-90 segundos e foco em controlo do movimento.";
  } else if (objetivo === "tecnica") {
    texto += "Objetivo t√©cnica: reduz a carga, aumenta o n√∫mero de repeti√ß√µes e d√° prioridade √† qualidade do movimento.";
  }

  if (weeks > 0) {
    texto += ` Planeia progredir durante ${weeks} semana(s), aumentando ligeiramente a carga ou o volume sempre que o corpo responder bem.`;
  }

  calcResultadoEl.textContent = texto;
}

calcBtn.addEventListener("click", calcObjetivoTreino);

/* ===== GR√ÅFICOS ===== */
const graphTipoEl = document.getElementById("graphTipo");
const graphExContainer = document.getElementById("graphExContainer");
const graphExercicioEl = document.getElementById("graphExercicio");
const graphHelperEl = document.getElementById("graphHelper");
const chartCanvas = document.getElementById("chart");
let chartInstance = null;

function refreshGraphExerciseOptions() {
  graphExercicioEl.innerHTML = "";
  Object.keys(dataRm).sort().forEach(ex => {
    const opt = document.createElement("option");
    opt.value = ex;
    opt.textContent = MOVES_PT[ex] || ex;
    graphExercicioEl.appendChild(opt);
  });
}

function renderChart() {
  const tipo = graphTipoEl.value;

  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }

  if (tipo === "1rm") {
    graphExContainer.style.display = "block";
    const ex = graphExercicioEl.value;
    if (!ex || !rmHistory2[ex] || !rmHistory2[ex].length) {
      graphHelperEl.textContent = "Ainda n√£o h√° hist√≥rico suficiente de 1RM para este exerc√≠cio.";
      return;
    }

    const dataPoints = rmHistory2[ex].sort((a, b) => a.data.localeCompare(b.data));
    const labels = dataPoints.map(d => d.data);
    const values = dataPoints.map(d => d.rm);

    chartInstance = new Chart(chartCanvas, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: MOVES_PT[ex] || ex,
          data: values
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: false }
        }
      }
    });

    graphHelperEl.textContent = "Evolu√ß√£o do teu 1RM ao longo do tempo.";
  } else {
    graphExContainer.style.display = "none";
    if (!treinos.length) {
      graphHelperEl.textContent = "Ainda n√£o h√° treinos registados para mostrar.";
      return;
    }

    const ordenados = [...treinos].sort((a, b) => (a.data || "").localeCompare(b.data || ""));
    const labels = ordenados.map(t => t.data || "");
    const rpes = ordenados.map(t => t.rpe || 0);

    chartInstance = new Chart(chartCanvas, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "RPE dos treinos",
          data: rpes
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, max: 10 }
        }
      }
    });

    graphHelperEl.textContent = "V√™ a evolu√ß√£o da intensidade (RPE) dos teus treinos ao longo do tempo.";
  }
}

graphTipoEl.addEventListener("change", renderChart);
graphExercicioEl.addEventListener("change", renderChart);

/* ===== PERFORMANCE ===== */
const performanceResumoEl = document.getElementById("performanceResumo");

function renderPerformance() {
  if (!treinos.length) {
    performanceResumoEl.textContent = "Ainda n√£o h√° treinos registados.";
    return;
  }

  const totalTreinos = treinos.length;
  const diasUnicos = new Set(treinos.map(t => t.data || "")).size;

  const rpesValidos = treinos.map(t => t.rpe || 0).filter(v => v > 0);
  const mediaRpe = rpesValidos.length
    ? (rpesValidos.reduce((acc, v) => acc + v, 0) / rpesValidos.length).toFixed(1)
    : null;

  const porCategoria = treinos.reduce((acc, t) => {
    const cat = t.categoria || "Sem categoria";
    acc[cat] = (acc[cat] || 0) + 1;
    return acc;
  }, {});

  const partesCat = Object.entries(porCategoria)
    .map(([cat, n]) => `${cat}: ${n}`)
    .join(" ¬∑ ");

  let texto = `Treinos registados: ${totalTreinos}. Dias √∫nicos com treino: ${diasUnicos}. `;
  if (mediaRpe) {
    texto += `RPE m√©dio: ${mediaRpe}. `;
  }
  if (partesCat) {
    texto += `Distribui√ß√£o por categoria ‚Äì ${partesCat}.`;
  }

  performanceResumoEl.textContent = texto;
}

/* ===== GUIA DE EXERC√çCIOS ===== */
const guiaBody = document.getElementById("guiaExerciciosBody");

function renderGuiaExercicios() {
  guiaBody.innerHTML = "";
  EXER_INFO.forEach(ex => {
    const tr = document.createElement("tr");

    const tdEx = document.createElement("td");
    tdEx.textContent = ex.pt;
    tr.appendChild(tdEx);

    const tdCat = document.createElement("td");
    tdCat.textContent = ex.en;
    tr.appendChild(tdCat);

    const tdDesc = document.createElement("td");
    tdDesc.textContent = ex.descricao;
    tr.appendChild(tdDesc);

    guiaBody.appendChild(tr);
  });
}

/* ===== BACKUP ===== */
const exportBackupBtn = document.getElementById("exportBackupBtn");
const importBackupBtn = document.getElementById("importBackupBtn");
const backupFileInput = document.getElementById("backupFileInput");
const backupInfoEl = document.getElementById("backupInfo");

/* Reservas & presen√ßas */
const reservasBtn = document.getElementById("reservasBtn");
const reservasSection = document.getElementById("sec-reservas");
const reservaDataEl = document.getElementById("reservaData");
const reservaHoraEl = document.getElementById("reservaHora");
const reservaTipoEl = document.getElementById("reservaTipo");
const reservaNotaEl = document.getElementById("reservaNota");
const reservaAddBtn = document.getElementById("reservaAddBtn");
const reservasBody = document.getElementById("reservasBody");
const reservasResumoEl = document.getElementById("reservasResumo");

let reservas = JSON.parse(localStorage.getItem(STORAGE_RESERVAS) || "[]");
let presencas = JSON.parse(localStorage.getItem(STORAGE_PRESENCAS) || "[]");
let rankingsMensais = JSON.parse(localStorage.getItem(STORAGE_RANKINGS) || "[]");

function getBackupData() {
  return {
    meta: {
      createdAt: new Date().toISOString(),
      app: "CrossBox - Di√°rio de Treino"
    },
    profile,
    dataRm,
    rmHistory2,
    treinos,
    reservas,
    presencas,
    rankingsMensais
  };
}

function exportBackup() {
  const data = getBackupData();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "crossbox_backup.json";
  a.click();
  URL.revokeObjectURL(url);

  backupInfoEl.textContent = "Backup exportado com sucesso.";
}

function importBackup(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);

      if (data.profile) {
        profile = data.profile;
        localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
      }
      if (data.dataRm) {
        dataRm = data.dataRm;
        localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
      }
      if (data.rmHistory2) {
        rmHistory2 = data.rmHistory2;
        localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory2));
      }
      if (data.treinos) {
        treinos = data.treinos;
        localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));
      }
      if (data.reservas) {
        reservas = data.reservas;
        localStorage.setItem(STORAGE_RESERVAS, JSON.stringify(reservas));
      }
      if (data.presencas) {
        presencas = data.presencas;
        localStorage.setItem(STORAGE_PRESENCAS, JSON.stringify(presencas));
      }
      if (data.rankingsMensais) {
        rankingsMensais = data.rankingsMensais;
        localStorage.setItem(STORAGE_RANKINGS, JSON.stringify(rankingsMensais));
      }

      loadProfile();
      renderRmTable();
      renderRmHistory();
      renderTreinos();
      renderReservas();
      renderPerformance();
      renderGuiaExercicios();
      backupInfoEl.textContent = "Backup importado com sucesso.";
    } catch (err) {
      backupInfoEl.textContent = "Erro ao importar backup.";
    }
  };
  reader.readAsText(file);
}

exportBackupBtn.addEventListener("click", exportBackup);
importBackupBtn.addEventListener("click", () => {
  backupFileInput.click();
});
backupFileInput.addEventListener("change", () => {
  if (backupFileInput.files && backupFileInput.files[0]) {
    importBackup(backupFileInput.files[0]);
  }
});

/* ===== RESERVAS & PRESEN√áAS ===== */

function gerarIdReserva() {
  return "R" + Math.random().toString(16).slice(2);
}

function mesmoMesAno(dataStr, ano, mes) {
  if (!dataStr) return false;
  const [a, m] = dataStr.split("-").map(n => parseInt(n, 10));
  return a === ano && m === mes;
}

function adicionarReserva() {
  const data = reservaDataEl.value || new Date().toISOString().slice(0,10);
  const hora = reservaHoraEl.value || "";
  const tipo = reservaTipoEl.value || "";
  const nota = reservaNotaEl.value.trim();

  if (!data || !hora || !tipo) {
    alert("Preenche pelo menos data, hora e tipo de aula.");
    return;
  }

  const novaReserva = {
    id: gerarIdReserva(),
    data,
    hora,
    tipo,
    nota,
    presenca: false
  };

  reservas.push(novaReserva);
  localStorage.setItem(STORAGE_RESERVAS, JSON.stringify(reservas));

  reservaDataEl.value = "";
  reservaHoraEl.value = "";
  reservaTipoEl.value = "";
  reservaNotaEl.value = "";

  renderReservas();
}

function marcarPresenca(id) {
  const reserva = reservas.find(r => r.id === id);
  if (!reserva) return;

  const dataHoje = reserva.data || new Date().toISOString().slice(0,10);

  presencas.push({
    idReserva: reserva.id,
    data: dataHoje,
    tipo: reserva.tipo
  });

  reserva.presenca = true;
  localStorage.setItem(STORAGE_RESERVAS, JSON.stringify(reservas));
  localStorage.setItem(STORAGE_PRESENCAS, JSON.stringify(presencas));

  atualizarRankingsMensais();
  renderReservas();
}

function apagarReserva(id) {
  reservas = reservas.filter(r => r.id !== id);
  localStorage.setItem(STORAGE_RESERVAS, JSON.stringify(reservas));
  renderReservas();
}

function atualizarRankingsMensais() {
  rankingsMensais = [];
  localStorage.setItem(STORAGE_RANKINGS, JSON.stringify(rankingsMensais));
}

function renderReservasResumo() {
  if (!reservasResumoEl) return;
  const agora = new Date();
  const ano = agora.getFullYear();
  const mes = agora.getMonth() + 1;

  const nReservasMes = reservas.filter(r => mesmoMesAno(r.data, ano, mes)).length;
  const nPresencasMes = presencas.filter(p => mesmoMesAno(p.data, ano, mes)).length;

  const chave = `${ano}-${String(mes).padStart(2,"0")}`;
  const rank = rankingsMensais.find(r => r.mes === chave);

  let texto = `Este m√™s: ${nReservasMes} reservas e ${nPresencasMes} presen√ßas registadas.`;

  if (rank && rank.nTreinos > 0) {
    texto += ` Treinos registados em WOD: ${rank.nTreinos} ¬∑ Carga total = ${formatKg(rank.cargaTotal)}.`;
    if (rank.distTotal > 0) {
      texto += ` Dist√¢ncia total = ${formatKm(rank.distTotal)}.`;
    }
  } else {
    texto += " Ainda n√£o h√° dados suficientes de WOD para resumo mensal.";
  }

  reservasResumoEl.textContent = texto;
}

function renderReservas() {
  if (!reservasBody) return;
  reservasBody.innerHTML = "";

  const ord = [...reservas].sort((a, b) => (a.data || "").localeCompare(b.data || ""));

  ord.forEach(r => {
    const tr = document.createElement("tr");

    const tdData = document.createElement("td");
    tdData.textContent = r.data || "";
    tr.appendChild(tdData);

    const tdHora = document.createElement("td");
    tdHora.textContent = r.hora || "";
    tr.appendChild(tdHora);

    const tdAula = document.createElement("td");
    tdAula.textContent = r.tipo || "";
    tr.appendChild(tdAula);

    const tdNota = document.createElement("td");
    tdNota.textContent = r.nota || "";
    tr.appendChild(tdNota);

    const tdPres = document.createElement("td");
    if (r.presenca) {
      tdPres.textContent = "‚úî";
    } else {
      const btnPres = document.createElement("button");
      btnPres.className = "btn-secondary";
      btnPres.style.padding = "4px 8px";
      btnPres.style.fontSize = "0.7rem";
      btnPres.textContent = "Marcar presen√ßa";
      btnPres.addEventListener("click", () => marcarPresenca(r.id));
      tdPres.appendChild(btnPres);
    }
    tr.appendChild(tdPres);

    const tdDel = document.createElement("td");
    const btnDel = document.createElement("button");
    btnDel.className = "btn-delete";
    btnDel.textContent = "üóë";
    btnDel.addEventListener("click", () => apagarReserva(r.id));
    tdDel.appendChild(btnDel);
    tr.appendChild(tdDel);

    reservasBody.appendChild(tr);
  });

  renderReservasResumo();
}

/* TABS PRINCIPAIS */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const target = btn.dataset.target;
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(target).classList.add("active");
  });
});

/* OP√á√ïES (sub-se√ß√µes) */
document.querySelectorAll(".opt-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const target = btn.dataset.target;
    document.querySelectorAll(".option-section").forEach(s => s.classList.remove("active"));
    const sec = document.getElementById(target);
    if (sec) sec.classList.add("active");
  });
});

/* BOT√ÉO RESERVAS ‚Äì j√° n√£o usas porque o bot√£o foi removido do header,
   mas o c√≥digo fica inofensivo porque reservasBtn ser√° null. */
if (reservasBtn && reservasSection) {
  reservasBtn.addEventListener("click", () => {
    const visivel = reservasSection.style.display === "block";
    reservasSection.style.display = visivel ? "none" : "block";
  });
}

/* INIT */
initSelects();
loadProfile();
renderRmTable();
renderRmHistory();
refreshCalcExOptions();
refreshGraphExerciseOptions();

if (treinoDataEl && !treinoDataEl.value) {
  treinoDataEl.value = new Date().toISOString().slice(0, 10);
}
renderTreinos();
renderReservas();
renderPerformance();
renderGuiaExercicios();

/* Service worker (se j√° usavas) */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("service-worker.js");
  });
}
</script>

</body>
</html>
