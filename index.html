<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrossBox</title>

  <meta name="theme-color" content="#f2f2f2" />
  <link rel="manifest" href="manifest.json" />

  <link rel="apple-touch-icon" sizes="180x180" href="imagens/crossmoita_logo.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      font-family: system-ui, sans-serif;
      color-scheme: light;
    }

    body {
      background: linear-gradient(to bottom, #e0e0e0 90%, #d4d4d4 100%);
      color: #111;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 900px;
      padding: 16px;
      box-sizing: border-box;
    }

    header {
      text-align: center;
      margin-bottom: 12px;
      position: relative;
    }

    #appLogo {
      max-width: 220px;
      height: auto;
      display: block;
      margin: 0 auto 6px auto;
    }

    .subtitle {
      font-size: 0.85rem;
      color: #555;
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 16px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    }

    /* PERFIL SEM ‚ÄúCART√ÉO‚Äù BRANCO */
    #perfil.card {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
      margin-bottom: 4px;
    }

    #perfilForm {
      display: none;
      margin-bottom: 8px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .field {
      flex: 1;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.8rem;
      color: #444;
    }

    input, select, textarea, button {
      padding: 10px;
      border-radius: 10px;
      background: #ffffff;
      color: #111;
      border: 1px solid #cccccc;
      font-size: 0.9rem;
      box-sizing: border-box;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.2);
    }

    .btn-primary {
      background: #22c55e;
      border-color: #22c55e;
      color: #ffffff;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-secondary {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #cccccc;
      background: #e5e5e5;
      color: #222;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-secondary:active {
      transform: scale(0.97);
    }

    .btn-delete {
      padding: 2px 4px;
      border-radius: 999px;
      border: 1px solid #e5e5e5;
      background: #f97373;
      color: #ffffff;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .btn-delete:hover {
      background: #ef4444;
    }

    .helper-text {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #444;
    }

    .btn-edit-profile {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #cccccc;
      background: #e5e5e5;
      color: #222;
      font-size: 0.65rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-edit-profile:active {
      transform: scale(0.95);
    }

    #editProfileBtnHeader {
      position: absolute;
      top: 4px;
      right: 8px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin: 10px 0 14px 0;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid #cccccc;
      background: #e5e5e5;
      color: #222;
      cursor: pointer;
      font-size: 0.9rem;
      box-shadow: 0 4px 0 #b3b3b3;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease, border-color 0.1s ease, color 0.1s ease;
    }

    .tab-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 5px 0 #aaaaaa;
    }

    .tab-btn.active {
      background: #22c55e;
      border-color: #22c55e;
      color: #ffffff;
      font-weight: 600;
      transform: translateY(2px);
      box-shadow: 0 2px 0 #15803d;
    }

    .section { display: none; }
    .section.active { display: block; }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
    }

    .opt-btn {
      width: 100%;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .opt-emoji {
      font-size: 1.4rem;
    }

    .option-section {
      display: none;
    }

    .option-section.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      color: #111;
    }

    th, td {
      padding: 6px;
      text-align: center;
      border-bottom: 1px solid #dddddd;
      white-space: nowrap;
    }

    th {
      background: #f9f9f9;
      color: #333;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .scroll {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #e5e5e5;
    }

    #backupInfo {
      margin-top: 6px;
      font-size: 0.75rem;
      color: #555;
    }
  </style>
</head>
<body>
<div class="app">

  <header>
    <button id="editProfileBtnHeader" class="btn-edit-profile">Editar perfil</button>
    <img id="appLogo" src="imagens/crossmoita_logo.png" alt="Cross Moita Logo">
    <div class="subtitle" id="appSubtitle">Registo de treinos</div>
  </header>

  <!-- PERFIL -->
  <section class="card" id="perfil">
    <div id="perfilForm">
      <div class="form-row">
        <div class="field">
          <label>Nome</label>
          <input id="nome" type="text" />
        </div>
        <div class="field">
          <label>N√≠vel</label>
          <select id="nivel">
            <option value="">Selecionar</option>
            <option value="iniciante">Iniciante</option>
            <option value="intermedio">Interm√©dio</option>
            <option value="avancado">Avan√ßado</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Sexo</label>
          <select id="sexo">
            <option value="">Selecionar</option>
            <option value="homem">Homem</option>
            <option value="mulher">Mulher</option>
          </select>
        </div>
        <div class="field">
          <label>Idade</label>
          <input id="idade" type="number" min="10" max="100" />
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Altura (cm)</label>
          <input id="altura" type="number" min="100" max="230" />
        </div>
        <div class="field">
          <label>Peso (kg)</label>
          <input id="peso" type="number" step="0.1" min="30" max="250" />
        </div>
      </div>

      <button class="btn-primary" id="saveProfile">Guardar perfil</button>
    </div>
  </section>

  <!-- TABS PRINCIPAIS -->
  <div class="tabs">
    <button class="tab-btn active" data-target="sec-1rm">1RM</button>
    <button class="tab-btn" data-target="sec-opcoes">OP√á√ïES</button>
  </div>

  <!-- SEC√á√ÉO 1: 1RM -->
  <section id="sec-1rm" class="section active">

    <div class="card">
      <div class="form-row">
        <div class="field">
          <label>Exerc√≠cio</label>
          <select id="exercise"></select>
        </div>

        <div class="field">
          <label>1RM (kg) ‚Äì peso m√°ximo numa repeti√ß√£o</label>
          <input id="oneRm" type="number" step="0.5" />
        </div>
      </div>

      <button class="btn-primary" id="addBtn">Guardar / Atualizar</button>
    </div>

    <div class="card">
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Exerc√≠cio (EN)</th>
              <th>1RM</th>
              <th>25%</th>
              <th>30%</th>
              <th>35%</th>
              <th>40%</th>
              <th>50%</th>
              <th>60%</th>
              <th>70%</th>
              <th>75%</th>
              <th>80%</th>
              <th>85%</th>
              <th>90%</th>
              <th>95%</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

  </section>

  <!-- SEC√á√ÉO 2: OP√á√ïES -->
  <section id="sec-opcoes" class="section">

    <div class="card">
      <h3 style="margin-top:0; margin-bottom:8px;">Op√ß√µes</h3>
      <div class="options-grid">
        <button class="btn-secondary opt-btn" data-target="opt-wod">
          <span class="opt-emoji">üü©</span>
          <span>WOD</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-calc">
          <span class="opt-emoji">üßÆ</span>
          <span>Melhoramento</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-graficos">
          <span class="opt-emoji">üìà</span>
          <span>Gr√°fico</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-guia">
          <span class="opt-emoji">üìö</span>
          <span>Guia exerc√≠cios</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-backup">
          <span class="opt-emoji">üíæ</span>
          <span>Backup</span>
        </button>
      </div>
      <div class="helper-text" style="margin-top:8px;">
        Toca num dos blocos para abrir o m√≥dulo pretendido.
      </div>
    </div>

    <!-- WOD -->
    <section id="opt-wod" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üü© WOD</h3>

        <div class="form-row">
          <div class="field">
            <label>Data</label>
            <input id="treinoData" type="date">
          </div>
          <div class="field">
            <label>Exerc√≠cio</label>
            <select id="treinoExercicio"></select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Tipo</label>
            <select id="treinoTipo">
              <option value="">Selecionar</option>
              <option value="for√ßa">For√ßa</option>
              <option value="hipertrofia">Hipertrofia</option>
              <option value="t√©cnica">T√©cnica</option>
              <option value="metcon">Metcon</option>
            </select>
          </div>
          <div class="field">
            <label>Rondas / S√©ries</label>
            <input id="treinoRondas" type="number" min="1" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Repeti√ß√µes por s√©rie</label>
            <input id="treinoReps" type="number" min="1" />
          </div>
          <div class="field">
            <label>Peso (kg)</label>
            <input id="treinoPeso" type="number" step="0.5" min="0" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Tempo (opcional)</label>
            <input id="treinoTempo" type="text" placeholder="Ex.: 12:35, 20', AMRAP 10'..." />
          </div>
        </div>

        <button class="btn-primary" id="treinoAdd">Adicionar ao WOD</button>
        <div class="helper-text">
          A carga de cada exerc√≠cio √© calculada como: peso √ó repeti√ß√µes √ó rondas.
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">Registo e hist√≥rico</h3>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Exerc√≠cio</th>
                <th>Tipo</th>
                <th>Rondas</th>
                <th>Reps</th>
                <th>Peso</th>
                <th>% 1RM</th>
                <th>Tempo</th>
                <th>Carga</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="treinoBody"></tbody>
          </table>
        </div>
        <div class="helper-text" id="treinoResumo"></div>
        <div class="helper-text" id="treinoSugestao" style="margin-top:4px; font-weight:500;"></div>
        <div class="helper-text" id="weeklyHistory" style="margin-top:6px;"></div>

        <button class="btn-secondary" id="toggleDailyHistory" style="margin-top:8px;">
          Hist√≥rico di√°rio completo
        </button>

        <div id="dailyHistorySection" style="display:none; margin-top:8px;">
          <div class="scroll">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Exerc√≠cio</th>
                  <th>Tipo</th>
                  <th>Rondas</th>
                  <th>Reps</th>
                  <th>Peso</th>
                  <th>% 1RM</th>
                  <th>Tempo</th>
                  <th>Carga</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="dailyHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- MELHORAMENTO -->
    <section id="opt-calc" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üßÆ Melhoramento</h3>

        <div class="form-row">
          <div class="field">
            <label>Exerc√≠cio (com 1RM registado)</label>
            <select id="calcExercicio"></select>
          </div>
          <div class="field">
            <label>N.¬∫ de repeti√ß√µes planeadas</label>
            <input id="calcReps" type="number" min="1" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Objetivo</label>
            <select id="calcObjetivo">
              <option value="">Autom√°tico</option>
              <option value="forca">For√ßa</option>
              <option value="hipertrofia">Hipertrofia</option>
              <option value="tecnica">T√©cnica / Volume leve</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Peso objetivo (kg ‚Äì opcional)</label>
            <input id="calcTargetKg" type="number" step="0.5" min="0" />
          </div>
          <div class="field">
            <label>Prazo (semanas ‚Äì opcional)</label>
            <input id="calcWeeks" type="number" min="1" />
          </div>
        </div>

        <button class="btn-primary" id="calcBtn">Calcular</button>
        <div class="helper-text" id="calcResultado" style="margin-top:6px;">
          Escolhe um exerc√≠cio com 1RM registado, indica o n¬∫ de repeti√ß√µes e, se quiseres, o objetivo (for√ßa / hipertrofia / t√©cnica).
        </div>
      </div>
    </section>

    <!-- GR√ÅFICOS -->
    <section id="opt-graficos" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üìà Gr√°fico de evolu√ß√£o do 1RM</h3>
        <div class="field">
          <label>Exerc√≠cio</label>
          <select id="graphExercise"></select>
        </div>
        <div style="margin-top:8px;">
          <canvas id="rmChart" style="width:100%; max-height:260px;"></canvas>
        </div>
      </div>
    </section>

    <!-- GUIA EXERC√çCIOS -->
    <section id="opt-guia" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üìö Guia de exerc√≠cios</h3>
        <input id="guiaSearch" type="text" placeholder="Procurar por nome (EN/PT) ou descri√ß√£o..." />
        <div class="scroll" style="margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th>Nome (EN)</th>
                <th>Tradu√ß√£o (PT)</th>
                <th>Descri√ß√£o</th>
              </tr>
            </thead>
            <tbody id="guiaBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BACKUP -->
    <section id="opt-backup" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üíæ Backup de dados</h3>
        <p class="helper-text">
          Exporta um ficheiro com o teu perfil, 1RM, hist√≥rico de WOD e restante informa√ß√£o.
          Podes guardar em Google Drive, iCloud, Ficheiros, etc. Para restaurar noutro telem√≥vel, basta importar o ficheiro.
        </p>
        <div class="form-row">
          <button class="btn-primary" id="exportBackupBtn">Exportar backup</button>
          <button class="btn-secondary" id="importBackupBtn">Importar backup</button>
          <input type="file" id="backupFileInput" accept="application/json" style="display:none;" />
        </div>
        <div id="backupInfo"></div>
      </div>
    </section>

  </section>

</div>

<script>
/* ===== CHAVES DE ARMAZENAMENTO ===== */
const STORAGE_PROFILE = "crossfit_profile";
const STORAGE_RM = "crossfit_1rm";
const STORAGE_RM_HISTORY = "crossfit_1rm_history";
const STORAGE_TREINO = "crossfit_treinos";
const STORAGE_BACKUP_META = "crossfit_backup_meta";

/* ===== PERFIL ===== */
let profile = JSON.parse(localStorage.getItem(STORAGE_PROFILE) || "{}");

const nomeEl = document.getElementById("nome");
const nivelEl = document.getElementById("nivel");
const sexoEl = document.getElementById("sexo");
const idadeEl = document.getElementById("idade");
const alturaEl = document.getElementById("altura");
const pesoEl = document.getElementById("peso");
const perfilForm = document.getElementById("perfilForm");
const editProfileBtnHeader = document.getElementById("editProfileBtnHeader");

function updateProfileInfo() {
  if (perfilForm) perfilForm.style.display = "none";
}

function updateSubtitle() {
  const sub = document.getElementById("appSubtitle");
  if (!sub) return;
  if (profile && profile.nome && profile.nome.trim() !== "") {
    sub.textContent = `Registo de treinos do ${profile.nome}`;
  } else {
    sub.textContent = "Registo de treinos";
  }
}

function loadProfile() {
  if (!sexoEl) return;
  if (profile.nome && nomeEl) nomeEl.value = profile.nome;
  if (profile.nivel && nivelEl) nivelEl.value = profile.nivel;
  if (profile.sexo) sexoEl.value = profile.sexo;
  if (profile.idade) idadeEl.value = profile.idade;
  if (profile.altura) alturaEl.value = profile.altura;
  if (profile.peso) pesoEl.value = profile.peso;
  updateProfileInfo();
  updateSubtitle();
}

const saveProfileBtn = document.getElementById("saveProfile");
if (saveProfileBtn) {
  saveProfileBtn.addEventListener("click", () => {
    profile = {
      nome: nomeEl && nomeEl.value ? nomeEl.value.trim() : "",
      nivel: nivelEl ? (nivelEl.value || "") : "",
      sexo: sexoEl.value || "",
      idade: idadeEl.value ? parseInt(idadeEl.value, 10) : "",
      altura: alturaEl.value ? parseInt(alturaEl.value, 10) : "",
      peso: pesoEl.value ? parseFloat(pesoEl.value) : ""
    };
    localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
    updateProfileInfo();
    updateSubtitle();
    registerBackupMeta("Perfil atualizado");
    alert("Perfil atualizado.");
  });
}

if (editProfileBtnHeader) {
  editProfileBtnHeader.addEventListener("click", () => {
    if (!perfilForm) return;
    const visible = perfilForm.style.display === "block";
    perfilForm.style.display = visible ? "none" : "block";
  });
}

/* ===== BASE DE EXERC√çCIOS COMPLETA (EN / PT / DESCRI√á√ÉO) ===== */
const EXERCISES = [
  /* === BARBELL / HALTEROFILISMO (1RM = true) === */
  { nameEn: "Chest Press", namePt: "Supino com barra", isWeight: true, category: "barbell", description: "Deitado no banco, empurrar a barra para cima a partir do peito, controlando a descida." },
  { nameEn: "Back Squat", namePt: "Agachamento com barra nas costas", isWeight: true, category: "barbell", description: "Agachamento com a barra apoiada nas costas, descendo at√© pelo menos √† paralela e subindo com o tronco firme." },
  { nameEn: "Front Squat", namePt: "Agachamento frontal", isWeight: true, category: "barbell", description: "Agachamento com a barra apoiada na parte da frente dos ombros, mantendo o tronco mais vertical." },
  { nameEn: "Overhead Squat", namePt: "Agachamento acima da cabe√ßa", isWeight: true, category: "barbell", description: "Agachamento com a barra acima da cabe√ßa, bra√ßos estendidos e core firme para estabilizar." },
  { nameEn: "Deadlift", namePt: "Peso morto", isWeight: true, category: "barbell", description: "Levar a barra do ch√£o at√© √† anca com costas neutras, empurrando o ch√£o com as pernas." },
  { nameEn: "Sumo Deadlift", namePt: "Peso morto sumo", isWeight: true, category: "barbell", description: "Peso morto com p√©s mais afastados e m√£os a agarrar a barra entre as pernas, reduzindo a amplitude de anca." },
  { nameEn: "Romanian Deadlift (RDL)", namePt: "Peso morto romeno", isWeight: true, category: "barbell", description: "Peso morto com menor flex√£o de joelhos, focado em posteriores da coxa e gl√∫teos." },
  { nameEn: "Power Clean", namePt: "Power clean", isWeight: true, category: "barbell", description: "Levar a barra do ch√£o at√© aos ombros de forma explosiva, recebendo-a acima da paralela." },
  { nameEn: "Squat Clean", namePt: "Squat clean", isWeight: true, category: "barbell", description: "Clean com rece√ß√£o em agachamento completo, antes de subir para a posi√ß√£o de p√©." },
  { nameEn: "Clean & Jerk", namePt: "Clean & jerk", isWeight: true, category: "barbell", description: "Clean do ch√£o aos ombros seguido de jerk dos ombros at√© acima da cabe√ßa." },
  { nameEn: "Power Snatch", namePt: "Power snatch", isWeight: true, category: "barbell", description: "Arranco com rece√ß√£o acima da paralela, num movimento do ch√£o at√© overhead." },
  { nameEn: "Squat Snatch", namePt: "Squat snatch", isWeight: true, category: "barbell", description: "Arranco com rece√ß√£o em agachamento profundo, seguido de extens√£o at√© ficar de p√©." },
  { nameEn: "Push Press", namePt: "Push press", isWeight: true, category: "barbell", description: "Press de ombros com pequeno impulso das pernas, terminando com a barra acima da cabe√ßa." },
  { nameEn: "Push Jerk", namePt: "Push jerk", isWeight: true, category: "barbell", description: "Impulso de pernas e encaixe da barra acima da cabe√ßa, recebendo em semi-agachamento." },
  { nameEn: "Split Jerk", namePt: "Split jerk", isWeight: true, category: "barbell", description: "Jerk em passada, recebendo a barra overhead com uma perna √† frente e outra atr√°s." },
  { nameEn: "Strict Press", namePt: "Press militar estrito", isWeight: true, category: "barbell", description: "Press de ombros sem ajuda das pernas, apenas com for√ßa de ombros e bra√ßos." },
  { nameEn: "Thruster", namePt: "Thruster", isWeight: true, category: "barbell", description: "Agachamento frontal seguido diretamente de press acima da cabe√ßa num s√≥ movimento." },
  { nameEn: "Barbell Row", namePt: "Remada com barra", isWeight: true, category: "barbell", description: "Com o tronco inclinado, puxar a barra em dire√ß√£o ao abd√≥men mantendo as costas neutras." },
  { nameEn: "Bent Over Row", namePt: "Remada inclinada", isWeight: true, category: "barbell", description: "Remada com maior inclina√ß√£o do tronco, focando dorsais e parte m√©dia das costas." },
  { nameEn: "Good Morning", namePt: "Good morning", isWeight: true, category: "barbell", description: "Com a barra nas costas, inclinar o tronco √† frente com ligeira flex√£o de joelhos e voltar √† posi√ß√£o inicial." },
  { nameEn: "Lunges com barra", namePt: "Passadas com barra", isWeight: true, category: "barbell", description: "Passadas √† frente ou atr√°s com a barra apoiada nos ombros, mantendo o tronco direito." },
  { nameEn: "Hip Thrust com barra", namePt: "Hip thrust com barra", isWeight: true, category: "barbell", description: "Elevar a anca com as costas apoiadas num banco e a barra sobre a bacia, contraindo bem os gl√∫teos." },

  /* DUMBBELL / HALTERES (1RM = true nos b√°sicos) */
  { nameEn: "Dumbbell Press", namePt: "Press com halteres", isWeight: true, category: "dumbbell", description: "Press de ombros com halteres, de p√© ou sentado, subindo acima da cabe√ßa." },
  { nameEn: "Dumbbell Bench Press", namePt: "Supino com halteres", isWeight: true, category: "dumbbell", description: "Deitado no banco, empurrar dois halteres para cima a partir do peito." },
  { nameEn: "Dumbbell Snatch", namePt: "Snatch com halteres", isWeight: true, category: "dumbbell", description: "Do ch√£o at√© acima da cabe√ßa com um haltere, num movimento explosivo." },
  { nameEn: "Dumbbell Clean", namePt: "Clean com halteres", isWeight: true, category: "dumbbell", description: "Levar os halteres das pernas at√© aos ombros com extens√£o de anca." },
  { nameEn: "Dumbbell Clean & Jerk", namePt: "Clean & jerk com halteres", isWeight: true, category: "dumbbell", description: "Clean com halteres at√© ao ombro seguido de impulso at√© overhead." },
  { nameEn: "Dumbbell Thruster", namePt: "Thruster com halteres", isWeight: true, category: "dumbbell", description: "Agachamento seguido de press com halteres acima da cabe√ßa num s√≥ movimento." },
  { nameEn: "Dumbbell Row", namePt: "Remada com halteres", isWeight: true, category: "dumbbell", description: "Remada unilateral ou bilateral, puxando o haltere em dire√ß√£o ao tronco." },
  { nameEn: "Dumbbell Lunges", namePt: "Passadas com halteres", isWeight: true, category: "dumbbell", description: "Passadas segurando um haltere em cada m√£o junto ao corpo." },

  /* KETTLEBELL (peso, mas mais usado em WOD) */
  { nameEn: "Kettlebell Swing", namePt: "Swing com kettlebell", isWeight: true, category: "kettlebell", description: "Balan√ßo da kettlebell usando sobretudo o impulso da anca, n√£o dos bra√ßos." },
  { nameEn: "Kettlebell Clean", namePt: "Clean com kettlebell", isWeight: true, category: "kettlebell", description: "Levar a kettlebell do fundo at√© √† posi√ß√£o de rack junto ao peito." },
  { nameEn: "Kettlebell Snatch", namePt: "Snatch com kettlebell", isWeight: true, category: "kettlebell", description: "Arranco unilateral, do ch√£o ou baloi√ßo at√© acima da cabe√ßa." },
  { nameEn: "Goblet Squat", namePt: "Agachamento goblet", isWeight: true, category: "kettlebell", description: "Agachamento segurando kettlebell ou haltere junto ao peito." },
  { nameEn: "Kettlebell Lunges", namePt: "Passadas com kettlebell", isWeight: true, category: "kettlebell", description: "Passadas segurando a kettlebell ao lado do corpo ou em rack." },

  /* === GIN√ÅSTICA / CALISTENIA (1RM = false) === */
  { nameEn: "Pull-Up", namePt: "Puxada na barra", isWeight: false, category: "gymnastic", description: "Suspenso na barra, puxar at√© o queixo ultrapassar a barra, com pegada pronada." },
  { nameEn: "Chin-Up", namePt: "Puxada em supina√ß√£o", isWeight: false, category: "gymnastic", description: "Puxada na barra com palmas viradas para si, focando mais os b√≠ceps." },
  { nameEn: "Chest-to-Bar Pull-Up", namePt: "Puxada ao peito", isWeight: false, category: "gymnastic", description: "Puxada at√© o peito tocar na barra, exigindo maior amplitude." },
  { nameEn: "Bar Muscle-Up", namePt: "Muscle-up na barra", isWeight: false, category: "gymnastic", description: "Puxada explosiva seguida de transi√ß√£o e dip, terminando com o tronco por cima da barra." },
  { nameEn: "Ring Muscle-Up", namePt: "Muscle-up nas argolas", isWeight: false, category: "gymnastic", description: "Vers√£o em argolas, mais inst√°vel, combinando puxada e dip." },
  { nameEn: "Toes-to-Bar (T2B)", namePt: "P√©s √† barra", isWeight: false, category: "gymnastic", description: "Suspenso na barra, elevar os p√©s at√© tocar na barra com controlo de core." },
  { nameEn: "Knees-to-Elbows (K2E)", namePt: "Joelhos aos cotovelos", isWeight: false, category: "gymnastic", description: "Suspenso na barra, elevar os joelhos at√© tocar nos cotovelos." },
  { nameEn: "Hanging Knee Raise", namePt: "Eleva√ß√£o de joelhos", isWeight: false, category: "gymnastic", description: "Suspenso na barra, elevar os joelhos at√© √† altura da anca ou acima." },
  { nameEn: "Handstand Push-Up (HSPU)", namePt: "Flex√£o de bra√ßos em pino", isWeight: false, category: "gymnastic", description: "Em pino contra a parede ou livre, realizar flex√µes de bra√ßos." },
  { nameEn: "Handstand Walk", namePt: "Caminhada em pino", isWeight: false, category: "gymnastic", description: "Deslocar-se apoiado apenas nas m√£os em posi√ß√£o de pino." },
  { nameEn: "Pistol Squat", namePt: "Agachamento numa perna", isWeight: false, category: "gymnastic", description: "Agachamento completo numa perna, mantendo a outra estendida √† frente." },
  { nameEn: "Sit-Up", namePt: "Abdominal", isWeight: false, category: "gymnastic", description: "Deitado de costas, subir o tronco at√© ficar sentado." },
  { nameEn: "GHD Sit-Up", namePt: "Abdominal GHD", isWeight: false, category: "gymnastic", description: "Abdominal profundo na m√°quina GHD, descendo al√©m da linha da anca e regressando." },
  { nameEn: "Back Extension (GHD)", namePt: "Extens√£o lombar", isWeight: false, category: "gymnastic", description: "Na GHD, descer o tronco em flex√£o de anca e voltar √† extens√£o." },
  { nameEn: "Ring Row", namePt: "Remada em argolas", isWeight: false, category: "gymnastic", description: "Suspenso nas argolas com os p√©s no ch√£o, puxar o peito em dire√ß√£o √†s argolas." },
  { nameEn: "Ring Dip", namePt: "Mergulhos em argolas", isWeight: false, category: "gymnastic", description: "A partir de bra√ßos estendidos, descer at√© ombros abaixo dos cotovelos e voltar a subir." },
  { nameEn: "Air Squat", namePt: "Agachamento simples", isWeight: false, category: "gymnastic", description: "Agachamento apenas com peso corporal, descendo at√© abaixo da paralela." },
  { nameEn: "Push-Up", namePt: "Flex√µes de bra√ßos", isWeight: false, category: "gymnastic", description: "Em prancha, baixar o peito em dire√ß√£o ao ch√£o e voltar a subir." },
  { nameEn: "Hand-Release Push-Up", namePt: "Flex√µes com m√£os ao ar", isWeight: false, category: "gymnastic", description: "No fundo da flex√£o, levantar as m√£os do ch√£o antes de voltar a subir." },

  /* === METCON / WOD === */
  { nameEn: "Burpee", namePt: "Burpee", isWeight: false, category: "metcon", description: "Agachar, colocar as m√£os no ch√£o, fazer flex√£o, voltar a levantar e terminar com um salto." },
  { nameEn: "Burpee Box Jump-Over", namePt: "Burpee com salto sobre a caixa", isWeight: false, category: "metcon", description: "Burpee seguido de salto por cima da caixa, de um lado para o outro." },
  { nameEn: "Box Jump", namePt: "Salto para a caixa", isWeight: false, category: "metcon", description: "Saltar com os dois p√©s para cima da caixa e estabilizar antes de descer." },
  { nameEn: "Box Jump Over", namePt: "Salto por cima da caixa", isWeight: false, category: "metcon", description: "Saltar para cima e para o outro lado da caixa, sem necessidade de estabilizar no topo." },
  { nameEn: "Wall Ball", namePt: "Lan√ßamento de bola", isWeight: true, category: "metcon", description: "Agachamento com bola medicinal seguido de lan√ßamento at√© um alvo na parede." },
  { nameEn: "Devil Press", namePt: "Devil press", isWeight: true, category: "metcon", description: "Burpee com halteres seguido de movimento tipo snatch duplo at√© overhead." },
  { nameEn: "Man Maker", namePt: "Man maker", isWeight: true, category: "metcon", description: "Combina√ß√£o de remada, burpee, clean e thruster com halteres." },

  /* === CARDIO / ERG√ìMETROS === */
  { nameEn: "Rowing", namePt: "Remo", isWeight: false, category: "cardio", description: "Exerc√≠cio na m√°quina de remo, trabalhando pernas, tronco e bra√ßos de forma coordenada." },
  { nameEn: "Ski Erg", namePt: "Ski erg", isWeight: false, category: "cardio", description: "Simulador de esqui, puxando as manetes de cima para baixo de forma cont√≠nua." },
  { nameEn: "Assault Bike", namePt: "Bicicleta de resist√™ncia", isWeight: false, category: "cardio", description: "Bicicleta com resist√™ncia de ar, trabalhando simultaneamente bra√ßos e pernas." },
  { nameEn: "Running", namePt: "Corrida", isWeight: false, category: "cardio", description: "Corrida em tapete ou exterior, em ritmo cont√≠nuo ou intervalado." },
  { nameEn: "Sprint", namePt: "Sprint", isWeight: false, category: "cardio", description: "Corrida explosiva de curta dist√¢ncia, em m√°xima intensidade." },
  { nameEn: "Double Under", namePt: "Saltos duplos na corda", isWeight: false, category: "cardio", description: "Saltos em que a corda passa duas vezes por baixo dos p√©s em cada salto." },
  { nameEn: "Single Under", namePt: "Saltos simples na corda", isWeight: false, category: "cardio", description: "Saltos em que a corda passa uma vez por baixo dos p√©s em cada salto." },

  /* === STRONGMAN / CARGAS === */
  { nameEn: "Farmer Carry", namePt: "Caminhada com cargas", isWeight: true, category: "strongman", description: "Caminhar segurando cargas pesadas (halteres, kettlebells, pegas) ao lado do corpo." },
  { nameEn: "Sled Push", namePt: "Empurrar tren√≥", isWeight: true, category: "strongman", description: "Empurrar um tren√≥ com carga ao longo de uma dist√¢ncia definida." },
  { nameEn: "Sled Pull", namePt: "Puxar tren√≥", isWeight: true, category: "strongman", description: "Puxar um tren√≥ com carga, com arn√™s ou corda, para tr√°s ou para a frente." },
  { nameEn: "Sandbag Carry", namePt: "Caminhada com saco", isWeight: true, category: "strongman", description: "Transportar um saco pesado ao peito, ombro ou costas." },
  { nameEn: "Yoke Carry", namePt: "Caminhada com yoke", isWeight: true, category: "strongman", description: "Caminhar com uma estrutura pesada apoiada nos ombros (yoke)." },
  { nameEn: "Rope Climb", namePt: "Subida √† corda", isWeight: false, category: "gymnastic", description: "Subir a corda usando t√©cnica de pernas ou apenas bra√ßos, tocando um alvo no topo." },
  { nameEn: "Bear Complex", namePt: "Bear complex", isWeight: true, category: "complex", description: "Sequ√™ncia: power clean, front squat, push press, back squat e push press novamente." },

  /* === ACESS√ìRIOS / MOBILIDADE === */
  { nameEn: "Hip Thrust", namePt: "Eleva√ß√£o de anca", isWeight: true, category: "accessory", description: "Elevar a anca com costas apoiadas num banco, com ou sem carga." },
  { nameEn: "Glute Bridge", namePt: "Ponte de gl√∫teos", isWeight: false, category: "accessory", description: "Elevar a anca a partir de posi√ß√£o deitado, com ombros no ch√£o." },
  { nameEn: "Reverse Hyperextension", namePt: "Hiperextens√£o reversa", isWeight: false, category: "accessory", description: "Na m√°quina Reverse Hyper, elevar as pernas atr√°s do corpo." },
  { nameEn: "Shrug", namePt: "Encolhimento de ombros", isWeight: true, category: "accessory", description: "Elevar os ombros em dire√ß√£o √†s orelhas segurando barra ou halteres." }
];

// Mapa r√°pido EN -> objeto
const EXERCISE_MAP = {};
EXERCISES.forEach(ex => {
  EXERCISE_MAP[ex.nameEn] = ex;
});

/* PERCENTAGENS FIXAS 1RM */
const PERC = [
  0.25, 0.30, 0.35, 0.40,
  0.50, 0.60, 0.70, 0.75,
  0.80, 0.85, 0.90, 0.95
];

let dataRm = JSON.parse(localStorage.getItem(STORAGE_RM) || "{}");
let rmHistory = JSON.parse(localStorage.getItem(STORAGE_RM_HISTORY) || "{}");

const sel = document.getElementById("exercise");
const rm = document.getElementById("oneRm");
const bodyTable = document.getElementById("tableBody");

/* WOD */
let treinos = JSON.parse(localStorage.getItem(STORAGE_TREINO) || "[]");

const treinoDataEl = document.getElementById("treinoData");
const treinoExEl = document.getElementById("treinoExercicio");
const treinoTipoEl = document.getElementById("treinoTipo");
const treinoRondasEl = document.getElementById("treinoRondas");
const treinoRepsEl = document.getElementById("treinoReps");
const treinoPesoEl = document.getElementById("treinoPeso");
const treinoTempoEl = document.getElementById("treinoTempo");
const treinoAddBtn = document.getElementById("treinoAdd");
const treinoBody = document.getElementById("treinoBody");
const treinoResumoEl = document.getElementById("treinoResumo");
const treinoSugestaoEl = document.getElementById("treinoSugestao");
const weeklyHistoryEl = document.getElementById("weeklyHistory");
const toggleDailyHistoryBtn = document.getElementById("toggleDailyHistory");
const dailyHistorySection = document.getElementById("dailyHistorySection");
const dailyHistoryBody = document.getElementById("dailyHistoryBody");

/* MELHORAMENTO */
const calcExEl = document.getElementById("calcExercicio");
const calcRepsEl = document.getElementById("calcReps");
const calcObjEl = document.getElementById("calcObjetivo");
const calcTargetKgEl = document.getElementById("calcTargetKg");
const calcWeeksEl = document.getElementById("calcWeeks");
const calcResEl = document.getElementById("calcResultado");
const calcBtn = document.getElementById("calcBtn");

/* Gr√°ficos */
const graphExerciseEl = document.getElementById("graphExercise");
const rmChartCanvas = document.getElementById("rmChart");
let rmChart = null;

/* Guia exerc√≠cios */
const guiaBody = document.getElementById("guiaBody");
const guiaSearch = document.getElementById("guiaSearch");

/* Backup */
const exportBackupBtn = document.getElementById("exportBackupBtn");
const importBackupBtn = document.getElementById("importBackupBtn");
const backupFileInput = document.getElementById("backupFileInput");
const backupInfoEl = document.getElementById("backupInfo");

function formatKg(v) {
  return v.toFixed(1).replace(".", ",") + " kg";
}

/* Selects ‚Äì 1RM = s√≥ peso; WOD = todos EN‚ÄìPT */
function initSelects() {
  if (sel) {
    sel.innerHTML = "";
    EXERCISES
      .filter(e => e.isWeight)
      .sort((a,b) => a.nameEn.localeCompare(b.nameEn))
      .forEach(ex => {
        const opt = document.createElement("option");
        opt.value = ex.nameEn;
        opt.textContent = ex.nameEn; // s√≥ EN no 1RM
        sel.appendChild(opt);
      });
  }

  if (treinoExEl) {
    treinoExEl.innerHTML = "";
    EXERCISES
      .slice()
      .sort((a,b) => a.nameEn.localeCompare(b.nameEn))
      .forEach(ex => {
        const opt = document.createElement("option");
        opt.value = ex.nameEn;
        opt.textContent = `${ex.nameEn} ‚Äì ${ex.namePt}`;
        treinoExEl.appendChild(opt);
      });
  }
}

function refreshCalcExOptions() {
  if (!calcExEl) return;
  calcExEl.innerHTML = "";

  const names = Object.keys(dataRm).sort();
  if (!names.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Nenhum 1RM registado";
    calcExEl.appendChild(opt);
    calcExEl.disabled = true;
    return;
  }

  calcExEl.disabled = false;
  names.forEach(n => {
    const exInfo = EXERCISE_MAP[n];
    const label = exInfo ? `${exInfo.nameEn}` : n;
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = label;
    calcExEl.appendChild(opt);
  });
}

function refreshGraphExerciseOptions() {
  if (!graphExerciseEl) return;
  const allNames = new Set([
    ...Object.keys(dataRm || {}),
    ...Object.keys(rmHistory || {})
  ]);
  const names = Array.from(allNames).sort();

  graphExerciseEl.innerHTML = "";
  if (!names.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Sem dados de 1RM";
    graphExerciseEl.appendChild(opt);
    graphExerciseEl.disabled = true;
    updateRmChart();
    return;
  }

  graphExerciseEl.disabled = false;
  names.forEach(n => {
    const exInfo = EXERCISE_MAP[n];
    const label = exInfo ? exInfo.nameEn : n;
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = label;
    graphExerciseEl.appendChild(opt);
  });

  updateRmChart();
}

function deleteEx(name) {
  if (!name) return;
  if (!confirm(`Apagar o exerc√≠cio "${name}"?`)) return;
  delete dataRm[name];
  delete rmHistory[name];
  localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
  localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory));
  registerBackupMeta("1RM removido");
  renderRm();
}

function renderRm() {
  bodyTable.innerHTML = "";
  Object.keys(dataRm).sort().forEach(name => {
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.textContent = name; // s√≥ EN na tabela de 1RM
    tr.appendChild(tdName);

    const td1rm = document.createElement("td");
    let oneRmText = formatKg(dataRm[name]);

    if (profile && profile.peso) {
      const rel = dataRm[name] / profile.peso;
      oneRmText += " (" + rel.toFixed(2) + "x peso corporal)";
    }

    const histList = rmHistory[name] || [];
    if (histList.length) {
      const prev = histList[histList.length - 1];
      const prevVal = prev.value;
      const diff = dataRm[name] - prevVal;
      if (Math.abs(diff) >= 0.5) {
        const seta = diff > 0 ? "‚Üë" : "‚Üì";
        const diffAbs = Math.abs(diff).toFixed(1).replace(".", ",");
        oneRmText += ` ¬∑ ${seta} ${diffAbs} kg vs anterior`;
      }
    }

    td1rm.textContent = oneRmText;
    tr.appendChild(td1rm);

    PERC.forEach(p => {
      const td = document.createElement("td");
      td.textContent = formatKg(dataRm[name] * p);
      tr.appendChild(td);
    });

    const tdDelete = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üóë";
    btn.className = "btn-delete";
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      deleteEx(name);
    });
    tdDelete.appendChild(btn);
    tr.appendChild(tdDelete);

    bodyTable.appendChild(tr);
  });

  refreshCalcExOptions();
  refreshGraphExerciseOptions();
}

document.getElementById("addBtn").addEventListener("click", () => {
  const ex = sel.value;
  const val = parseFloat(rm.value);
  if (!ex || !val || val <= 0) return;

  const old = dataRm[ex];

  if (typeof old === "number" && !isNaN(old) && old !== val) {
    if (!rmHistory[ex]) rmHistory[ex] = [];
    rmHistory[ex].push({
      date: new Date().toISOString().slice(0, 10),
      value: old
    });
  }

  dataRm[ex] = val;
  localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
  localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory));

  rm.value = "";
  registerBackupMeta("1RM atualizado");
  renderRm();
});

/* ===== MELHORAMENTO (CALCULADORA) ===== */
function getPercentRange(reps, objetivo) {
  let minP, maxP;

  if (objetivo === "forca") {
    if (reps <= 2) { minP = 0.9; maxP = 0.98; }
    else if (reps <= 3) { minP = 0.88; maxP = 0.95; }
    else if (reps <= 5) { minP = 0.80; maxP = 0.90; }
    else { minP = 0.75; maxP = 0.85; }
  } else if (objetivo === "hipertrofia") {
    if (reps <= 5) { minP = 0.75; maxP = 0.85; }
    else if (reps <= 8) { minP = 0.70; maxP = 0.80; }
    else if (reps <= 12) { minP = 0.65; maxP = 0.75; }
    else { minP = 0.55; maxP = 0.70; }
  } else if (objetivo === "tecnica") {
    if (reps <= 5) { minP = 0.50; maxP = 0.65; }
    else if (reps <= 10) { minP = 0.45; maxP = 0.60; }
    else { minP = 0.40; maxP = 0.55; }
  } else {
    if (reps === 1) { minP = 0.9; maxP = 1.0; }
    else if (reps <= 3) { minP = 0.85; maxP = 0.95; }
    else if (reps <= 5) { minP = 0.80; maxP = 0.90; }
    else if (reps <= 8) { minP = 0.70; maxP = 0.80; }
    else if (reps <= 12) { minP = 0.65; maxP = 0.75; }
    else { minP = 0.50; maxP = 0.65; }
  }

  return { minP, maxP };
}

if (calcBtn) {
  calcBtn.addEventListener("click", () => {
    if (!calcExEl || !calcRepsEl || !calcResEl) return;

    const ex = calcExEl.value;
    const reps = parseInt(calcRepsEl.value || "0", 10);
    const obj = calcObjEl ? calcObjEl.value : "";
    const targetKgVal = calcTargetKgEl ? parseFloat(calcTargetKgEl.value || "0") : 0;
    const weeksVal = calcWeeksEl ? parseInt(calcWeeksEl.value || "0", 10) : 0;

    if (!ex || !dataRm[ex]) {
      calcResEl.textContent = "Escolhe um exerc√≠cio com 1RM registado.";
      return;
    }
    if (!reps || reps <= 0) {
      calcResEl.textContent = "Indica o n√∫mero de repeti√ß√µes.";
      return;
    }

    const oneRmVal = dataRm[ex];
    const { minP, maxP } = getPercentRange(reps, obj);
    const minLoad = oneRmVal * minP;
    const maxLoad = oneRmVal * maxP;

    let objetivoTexto = "autom√°tico";
    if (obj === "forca") objetivoTexto = "for√ßa";
    if (obj === "hipertrofia") objetivoTexto = "hipertrofia";
    if (obj === "tecnica") objetivoTexto = "t√©cnica / volume leve";

    let msg =
      `Para ${reps} repeti√ß√µes em ${ex}, com objetivo ${objetivoTexto}, ` +
      `a carga sugerida √© entre ${(minP*100).toFixed(0)}% e ${(maxP*100).toFixed(0)}% do 1RM: ` +
      `${formatKg(minLoad)} ‚Äì ${formatKg(maxLoad)}. Ajusta ligeiramente para bater certo com os discos que tens.`;

    if (targetKgVal && !isNaN(targetKgVal)) {
      if (targetKgVal <= oneRmVal) {
        msg += `\n\nO peso objetivo (${formatKg(targetKgVal)}) est√° abaixo ou muito pr√≥ximo do teu 1RM atual. Foca-te em consolidar t√©cnica, controlar o volume e manter consist√™ncia semanal.`;
      } else {
        if (weeksVal && weeksVal > 0) {
          const incPercent = ((targetKgVal - oneRmVal) / oneRmVal) * 100;
          const incPerWeek = incPercent / weeksVal;
          let dificuldade;
          if (incPerWeek <= 1) {
            dificuldade = "uma progress√£o realista";
          } else if (incPerWeek <= 2) {
            dificuldade = "uma progress√£o exigente mas ainda poss√≠vel";
          } else {
            dificuldade = "uma progress√£o muito agressiva e pouco realista para a maioria das pessoas";
          }

          const nivel = (profile && profile.nivel) ? profile.nivel.toLowerCase() : "";
          let freq = "2‚Äì3 sess√µes semanais";
          let seriesReps = "3‚Äì5 s√©ries de 3‚Äì6 repeti√ß√µes entre 75‚Äì90% do 1RM atual";

          if (nivel === "iniciante") {
            freq = "2‚Äì3 sess√µes semanais focadas no movimento principal";
            seriesReps = "3‚Äì4 s√©ries de 5‚Äì8 repeti√ß√µes entre 70‚Äì80% do 1RM atual";
          } else if (nivel === "intermedio") {
            freq = "2‚Äì3 sess√µes semanais com varia√ß√µes do movimento principal";
            seriesReps = "4‚Äì5 s√©ries de 3‚Äì6 repeti√ß√µes entre 75‚Äì85% do 1RM atual";
          } else if (nivel === "avancado") {
            freq = "2‚Äì3 sess√µes semanais mais espec√≠ficas (for√ßa + varia√ß√µes t√©cnicas)";
            seriesReps = "3‚Äì6 s√©ries entre 2‚Äì5 repeti√ß√µes a 80‚Äì90% do 1RM atual";
          }

          msg += `\n\nObjetivo: chegar a ${formatKg(targetKgVal)} em cerca de ${weeksVal} semanas (${dificuldade}). ` +
                 `Uma sugest√£o, tendo em conta o teu n√≠vel, √© realizar ${freq} de ${ex}, com ${seriesReps}, ` +
                 `aumentando 2,5‚Äì5 kg quando conseguires todas as s√©ries com boa t√©cnica e sem falhas.`;
        } else {
          msg += `\n\nTens como objetivo chegar a ${formatKg(targetKgVal)}. Define um prazo em semanas para obteres uma recomenda√ß√£o mais detalhada de volume e frequ√™ncia.`;
        }
      }
    }

    calcResEl.textContent = msg;
  });
}

/* ===== GR√ÅFICO 1RM ===== */
function updateRmChart() {
  if (!rmChartCanvas || !graphExerciseEl) return;

  const ex = graphExerciseEl.value;
  let labels = [];
  let values = [];

  if (ex && (rmHistory[ex] || dataRm[ex])) {
    const hist = (rmHistory[ex] || []).slice().sort((a, b) => {
      return (a.date || "").localeCompare(b.date || "");
    });

    hist.forEach((entry, idx) => {
      labels.push(entry.date || "h" + (idx + 1));
      values.push(entry.value);
    });

    if (dataRm[ex]) {
      labels.push("Atual");
      values.push(dataRm[ex]);
    }
  }

  const ctx = rmChartCanvas.getContext("2d");

  if (rmChart) {
    rmChart.destroy();
    rmChart = null;
  }

  if (!labels.length) {
    rmChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: ["Sem dados"],
        datasets: [{
          label: "1RM (kg)",
          data: [0],
          tension: 0.25
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { display: false },
          y: { display: false }
        }
      }
    });
    return;
  }

  const exInfo = EXERCISE_MAP[ex];
  const datasetLabel = exInfo ? `${exInfo.nameEn} ‚Äì 1RM (kg)` : ex + " ‚Äì 1RM (kg)";

  rmChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: datasetLabel,
        data: values,
        tension: 0.25
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        x: {
          title: { display: true, text: "Registos" }
        },
        y: {
          title: { display: true, text: "Peso (kg)" },
          beginAtZero: false
        }
      }
    }
  });
}

if (graphExerciseEl) {
  graphExerciseEl.addEventListener("change", updateRmChart);
}

/* ===== WOD ===== */
function saveTreinos() {
  localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));
}

function calcCarga(entry) {
  const peso = entry.peso || 0;
  const reps = entry.reps || 0;
  const rondas = entry.rondas || 1;
  return peso * reps * rondas;
}

function addTreinoEntry() {
  const date = treinoDataEl.value || new Date().toISOString().slice(0,10);
  const ex = treinoExEl.value;
  const tipo = treinoTipoEl.value;
  const rondas = parseInt(treinoRondasEl.value || "1", 10);
  const reps = parseInt(treinoRepsEl.value || "0", 10);
  const peso = parseFloat(treinoPesoEl.value || "0");
  const tempo = treinoTempoEl.value.trim();

  if (!ex || !reps || reps <= 0) return;

  const carga = calcCarga({ peso, reps, rondas });
  let perc1rm = null;
  if (dataRm[ex] && dataRm[ex] > 0 && peso > 0) {
    perc1rm = peso / dataRm[ex];
  }

  const entry = {
    date,
    ex,
    tipo,
    rondas,
    reps,
    peso,
    tempo,
    carga,
    perc1rm
  };

  treinos.unshift(entry);
  saveTreinos();
  registerBackupMeta("WOD registado");
  renderTreinos();
}

function deleteTreinoEntry(index) {
  if (index < 0 || index >= treinos.length) return;
  if (!confirm("Apagar este registo de WOD?")) return;
  treinos.splice(index, 1);
  saveTreinos();
  registerBackupMeta("WOD removido");
  renderTreinos();
}

function renderDailyHistory() {
  if (!dailyHistoryBody) return;
  dailyHistoryBody.innerHTML = "";

  if (!treinos.length) return;

  const sorted = treinos.slice().sort((a, b) => {
    return (b.date || "").localeCompare(a.date || "");
  });

  sorted.forEach(t => {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = t.date || "";
    tr.appendChild(tdDate);

    const tdEx = document.createElement("td");
    const exInfo = EXERCISE_MAP[t.ex];
    const label = exInfo ? `${exInfo.nameEn} ‚Äì ${exInfo.namePt}` : t.ex;
    tdEx.textContent = label || "";
    tr.appendChild(tdEx);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = t.tipo || "";
    tr.appendChild(tdTipo);

    const tdR = document.createElement("td");
    tdR.textContent = t.rondas || "";
    tr.appendChild(tdR);

    const tdReps = document.createElement("td");
    tdReps.textContent = t.reps || "";
    tr.appendChild(tdReps);

    const tdPeso = document.createElement("td");
    tdPeso.textContent = t.peso ? formatKg(t.peso) : "";
    tr.appendChild(tdPeso);

    const tdPerc = document.createElement("td");
    if (t.perc1rm) {
      tdPerc.textContent = (t.perc1rm * 100).toFixed(0) + "%";
    } else {
      tdPerc.textContent = "";
    }
    tr.appendChild(tdPerc);

    const tdTempo = document.createElement("td");
    tdTempo.textContent = t.tempo || "";
    tr.appendChild(tdTempo);

    const tdCarga = document.createElement("td");
    tdCarga.textContent = t.carga ? formatKg(t.carga) : "";
    tr.appendChild(tdCarga);

    const tdDel = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üóë";
    btn.className = "btn-delete";
    btn.addEventListener("click", () => {
      deleteTreinoEntry(treinos.indexOf(t));
    });
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);

    dailyHistoryBody.appendChild(tr);
  });
}

function buildSugestao(lista, totalCarga, totalSeries, blocosForca, blocosHipertrofia, blocosLeve, dia) {
  let partes = [];

  if (totalSeries === 0 || totalCarga === 0) {
    return "Hoje o treino ficou muito leve. Se o objetivo √© ganhar for√ßa e m√∫sculo, planeia pelo menos 2‚Äì3 blocos de trabalho com carga moderada a alta.";
  }

  partes.push("Bom trabalho hoje, treino conclu√≠do em " + dia + "!");

  const idade = profile && profile.idade ? profile.idade : null;
  const sexo = profile && profile.sexo ? profile.sexo : null;
  const peso = profile && profile.peso ? profile.peso : null;
  const altura = profile && profile.altura ? profile.altura : null;

  if (blocosForca === 0 && blocosHipertrofia === 0) {
    partes.push("O dia ficou mais leve em termos de est√≠mulo de for√ßa e hipertrofia.");
    partes.push("Para evoluir, tenta incluir 2‚Äì3 exerc√≠cios principais entre 70‚Äì85% do teu 1RM, com 5‚Äì10 repeti√ß√µes.");
  } else if (blocosForca > 0 && blocosHipertrofia === 0) {
    partes.push("Treino muito focado em for√ßa m√°xima, com s√©ries pesadas e repeti√ß√µes baixas.");
    partes.push("Para aumentar tamb√©m a massa muscular, acrescenta 2‚Äì4 s√©ries de 6‚Äì10 repeti√ß√µes a 65‚Äì75% do 1RM em 1‚Äì2 exerc√≠cios grandes.");
  } else if (blocosHipertrofia > 0 && blocosForca === 0) {
    partes.push("Treino consistente para hipertrofia, com bastante trabalho de volume.");
    partes.push("Para refor√ßar a for√ßa, vale a pena incluir 2‚Äì3 s√©ries pesadas (3‚Äì5 repeti√ß√µes a 80‚Äì85% do 1RM) em movimentos fundamentais.");
  } else {
    partes.push("Boa combina√ß√£o de for√ßa e hipertrofia hoje.");
    partes.push("Mant√©m a l√≥gica de 2‚Äì3 exerc√≠cios principais mais pesados (3‚Äì5 reps a 80‚Äì85% do 1RM) e 2‚Äì3 exerc√≠cios de apoio com 6‚Äì12 reps a 65‚Äì75% do 1RM.");
  }

  if (sexo === "homem") {
    partes.push("Como homem, toleras bem blocos pesados entre 80‚Äì85% do 1RM, desde que respeites a t√©cnica e a recupera√ß√£o.");
  } else if (sexo === "mulher") {
    partes.push("Como mulher, costumas recuperar melhor entre s√©ries; n√£o tenhas receio de trabalhar com 8‚Äì12 repeti√ß√µes a 70‚Äì75% do 1RM nos grandes movimentos.");
  }

  if (idade && idade >= 40) {
    partes.push("Com a idade atual, √© importante controlar o volume: d√° prioridade √† qualidade do movimento e garante 48‚Äì72 horas de recupera√ß√£o entre dias muito pesados.");
  }

  if (peso) {
    const cargaMediaPorSerie = totalCarga / Math.max(totalSeries, 1);
    const rel = cargaMediaPorSerie / peso;

    if (rel < 0.8) {
      partes.push("A carga m√©dia por s√©rie ficou relativamente baixa face ao teu peso corporal; aos poucos podes aproximar os principais levantamentos de 1.0‚Äì1.5x do teu peso.");
    } else if (rel >= 0.8 && rel <= 1.5) {
      partes.push("A rela√ß√£o entre carga m√©dia por s√©rie e peso corporal est√° numa faixa interessante para progresso cont√≠nuo. Mant√©m esta consist√™ncia.");
    } else if (rel > 1.5) {
      partes.push("Est√°s a trabalhar com uma carga m√©dia por s√©rie alta relativamente ao teu peso corporal; mant√©m aten√ß√£o √† t√©cnica e √† recupera√ß√£o para evitar excesso de fadiga.");
    }
  }

  if (altura) {
    if (altura >= 185) {
      partes.push("Com a tua estatura, d√° aten√ß√£o extra √† posi√ß√£o lombar em agachamentos e deadlifts, mantendo o core firme em todas as repeti√ß√µes.");
    } else if (altura <= 165) {
      partes.push("Com a tua estatura, tens vantagem para estabilizar cargas pesadas; usa isso para consolidar t√©cnica s√≥lida nos b√°sicos antes de aumentar muito o volume.");
    }
  }

  return partes.join(" ");
}

function getMonday(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return null;
  const day = d.getDay();
  const diff = (day + 6) % 7;
  d.setDate(d.getDate() - diff);
  d.setHours(0, 0, 0, 0);
  return d;
}

function renderWeeklyHistory() {
  if (!weeklyHistoryEl) return;

  if (!treinos.length) {
    weeklyHistoryEl.textContent = "Ainda n√£o h√° hist√≥rico semanal registado.";
    return;
  }

  const semanas = {};
  treinos.forEach(t => {
    if (!t.date) return;
    const mon = getMonday(t.date);
    if (!mon) return;
    const key = mon.toISOString().slice(0,10);
    if (!semanas[key]) semanas[key] = 0;
    semanas[key] += t.carga || 0;
  });

  const keys = Object.keys(semanas).sort((a, b) => b.localeCompare(a));

  if (!keys.length) {
    weeklyHistoryEl.textContent = "Ainda n√£o h√° hist√≥rico semanal registado.";
    return;
  }

  const fmt = (d) => {
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    return dd + "/" + mm;
  };

  const lines = keys.slice(0, 4).map(k => {
    const mon = new Date(k);
    const sun = new Date(mon);
    sun.setDate(mon.getDate() + 6);
    const txtCarga = formatKg(semanas[k]);
    return fmt(mon) + " ‚Äì " + fmt(sun) + ": " + txtCarga;
  });

  weeklyHistoryEl.innerHTML =
    "Hist√≥rico das √∫ltimas semanas (carga total):<br>" +
    lines.join("<br>");
}

function renderTreinos() {
  if (!treinoBody) return;
  treinoBody.innerHTML = "";

  const dia = treinoDataEl.value || new Date().toISOString().slice(0,10);
  const lista = treinos.filter(t => t.date === dia);

  if (!lista.length) {
    if (treinoResumoEl) {
      treinoResumoEl.textContent = "Sem WOD registado para " + dia + ".";
    }
    if (treinoSugestaoEl) treinoSugestaoEl.textContent = "";
    renderWeeklyHistory();
    renderDailyHistory();
    return;
  }

  let totalCarga = 0;
  let totalSeries = 0;
  let blocosForca = 0;
  let blocosHipertrofia = 0;
  let blocosLeve = 0;

  lista.forEach(e => {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = e.date || "";
    tr.appendChild(tdDate);

    const tdEx = document.createElement("td");
    const exInfo = EXERCISE_MAP[e.ex];
    const label = exInfo ? `${exInfo.nameEn} ‚Äì ${exInfo.namePt}` : e.ex;
    tdEx.textContent = label || "";
    tr.appendChild(tdEx);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = e.tipo || "";
    tr.appendChild(tdTipo);

    const tdR = document.createElement("td");
    tdR.textContent = e.rondas || "";
    tr.appendChild(tdR);

    const tdReps = document.createElement("td");
    tdReps.textContent = e.reps || "";
    tr.appendChild(tdReps);

    const tdPeso = document.createElement("td");
    tdPeso.textContent = e.peso ? formatKg(e.peso) : "";
    tr.appendChild(tdPeso);

    const tdPerc = document.createElement("td");
    if (e.perc1rm) {
      tdPerc.textContent = (e.perc1rm * 100).toFixed(0) + "%";
    } else {
      tdPerc.textContent = "";
    }
    tr.appendChild(tdPerc);

    const tdTempo = document.createElement("td");
    tdTempo.textContent = e.tempo || "";
    tr.appendChild(tdTempo);

    const tdCarga = document.createElement("td");
    tdCarga.textContent = e.carga ? formatKg(e.carga) : "";
    tr.appendChild(tdCarga);

    const tdDel = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üóë";
    btn.className = "btn-delete";
    btn.addEventListener("click", () => deleteTreinoEntry(treinos.indexOf(e)));
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);

    treinoBody.appendChild(tr);

    totalCarga += e.carga || 0;
    totalSeries += (e.rondas || 0);

    if (e.perc1rm && e.reps) {
      const p = e.perc1rm;
      const r = e.reps;
      if (p >= 0.8 && r <= 5) {
        blocosForca++;
      } else if (p >= 0.65 && p <= 0.8 && r >= 6 && r <= 12) {
        blocosHipertrofia++;
      } else if (p < 0.6 || r >= 15) {
        blocosLeve++;
      }
    }
  });

  if (treinoResumoEl) {
    treinoResumoEl.textContent =
      "Resumo do dia " + dia + ": carga total do WOD = " + formatKg(totalCarga);
  }

  const sugestao = buildSugestao(
    lista,
    totalCarga,
    totalSeries,
    blocosForca,
    blocosHipertrofia,
    blocosLeve,
    dia
  );
  if (treinoSugestaoEl) treinoSugestaoEl.textContent = sugestao;

  renderWeeklyHistory();
  renderDailyHistory();
}

if (treinoAddBtn) {
  treinoAddBtn.addEventListener("click", addTreinoEntry);
}
if (treinoDataEl) {
  treinoDataEl.addEventListener("change", renderTreinos);
}
if (toggleDailyHistoryBtn && dailyHistorySection) {
  toggleDailyHistoryBtn.addEventListener("click", () => {
    const visible = dailyHistorySection.style.display === "block";
    dailyHistorySection.style.display = visible ? "none" : "block";
    if (!visible) {
      renderDailyHistory();
    }
  });
}

/* ===== BACKUP ===== */
function formatDateTime(dt) {
  const d = new Date(dt);
  if (isNaN(d.getTime())) return "";
  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2, "0");
  const mi = String(d.getMinutes()).padStart(2, "0");
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}

function registerBackupMeta(evento) {
  try {
    const meta = JSON.parse(localStorage.getItem(STORAGE_BACKUP_META) || "{}");
    meta.lastChange = new Date().toISOString();
    meta.lastEvent = evento || "";
    localStorage.setItem(STORAGE_BACKUP_META, JSON.stringify(meta));
    updateBackupInfo();
  } catch (e) {}
}

function updateBackupInfo() {
  if (!backupInfoEl) return;
  const meta = JSON.parse(localStorage.getItem(STORAGE_BACKUP_META) || "{}");
  const lastBackup = meta.lastBackup ? formatDateTime(meta.lastBackup) : "nunca";
  const lastChange = meta.lastChange ? formatDateTime(meta.lastChange) : "sem registo";
  backupInfoEl.innerHTML =
    `<div class="helper-text">
       √öltimo backup exportado: <strong>${lastBackup}</strong><br>
       √öltima altera√ß√£o de dados: <strong>${lastChange}</strong>
     </div>`;
}

function buildBackupObject() {
  return {
    version: 1,
    createdAt: new Date().toISOString(),
    profile: profile || {},
    dataRm: dataRm || {},
    rmHistory: rmHistory || {},
    treinos: treinos || []
  };
}

function downloadJson(obj, filename) {
  const dataStr = "data:application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(obj));
  const a = document.createElement("a");
  a.setAttribute("href", dataStr);
  a.setAttribute("download", filename);
  document.body.appendChild(a);
  a.click();
  a.remove();
}

if (exportBackupBtn) {
  exportBackupBtn.addEventListener("click", () => {
    const backup = buildBackupObject();
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const dd = String(now.getDate()).padStart(2, "0");
    const filename = `crossfit_backup_${yyyy}${mm}${dd}.json`;
    downloadJson(backup, filename);

    try {
      const meta = JSON.parse(localStorage.getItem(STORAGE_BACKUP_META) || "{}");
      meta.lastBackup = new Date().toISOString();
      localStorage.setItem(STORAGE_BACKUP_META, JSON.stringify(meta));
    } catch (e) {}
    updateBackupInfo();
    alert("Backup exportado. Podes agora guardar o ficheiro em Google Drive, iCloud, Ficheiros, etc.");
  });
}

if (importBackupBtn && backupFileInput) {
  importBackupBtn.addEventListener("click", () => {
    backupFileInput.value = "";
    backupFileInput.click();
  });

  backupFileInput.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        const content = evt.target.result;
        const data = JSON.parse(content);

        if (!data || typeof data !== "object") {
          alert("Ficheiro inv√°lido.");
          return;
        }

        if (!("dataRm" in data) && !("treinos" in data)) {
          alert("Este ficheiro n√£o parece ser um backup v√°lido da app.");
          return;
        }

        profile = data.profile || {};
        dataRm = data.dataRm || {};
        rmHistory = data.rmHistory || {};
        treinos = data.treinos || [];

        localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
        localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
        localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory));
        localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));

        registerBackupMeta("Backup importado");

        loadProfile();
        initSelects();
        renderRm();
        refreshCalcExOptions();
        refreshGraphExerciseOptions();
        renderTreinos();
        renderGuiaExercicios();

        alert("Backup importado com sucesso.");
      } catch (err) {
        console.error(err);
        alert("Erro ao ler o ficheiro de backup.");
      }
    };
    reader.readAsText(file);
  });
}

/* GUIA EXERC√çCIOS ‚Äì usa EXERCISES */
function renderGuiaExercicios() {
  if (!guiaBody) return;
  guiaBody.innerHTML = "";

  const filtro = (guiaSearch?.value || "").toLowerCase().trim();

  EXERCISES.forEach(ex => {
    const texto = (ex.nameEn + " " + ex.namePt + " " + ex.description).toLowerCase();
    if (filtro && !texto.includes(filtro)) return;

    const tr = document.createElement("tr");

    const tdEn = document.createElement("td");
    tdEn.textContent = ex.nameEn;
    tr.appendChild(tdEn);

    const tdPt = document.createElement("td");
    tdPt.textContent = ex.namePt;
    tr.appendChild(tdPt);

    const tdDesc = document.createElement("td");
    tdDesc.textContent = ex.description;
    tr.appendChild(tdDesc);

    guiaBody.appendChild(tr);
  });
}

if (guiaSearch) {
  guiaSearch.addEventListener("input", renderGuiaExercicios);
}

/* TABS PRINCIPAIS */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const target = btn.dataset.target;
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(target).classList.add("active");
  });
});

/* OP√á√ïES (sub-se√ß√µes) */
document.querySelectorAll(".opt-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const target = btn.dataset.target;
    document.querySelectorAll(".option-section").forEach(s => s.classList.remove("active"));
    const sec = document.getElementById(target);
    if (sec) sec.classList.add("active");
  });
});

/* INIT */
initSelects();
loadProfile();
renderRm();
refreshCalcExOptions();
refreshGraphExerciseOptions();

if (treinoDataEl && !treinoDataEl.value) {
  treinoDataEl.value = new Date().toISOString().slice(0, 10);
}
renderTreinos();
updateBackupInfo();
renderGuiaExercicios();

if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    navigator.serviceWorker.register("service-worker.js");
  });
}
</script>

</body>
</html>
